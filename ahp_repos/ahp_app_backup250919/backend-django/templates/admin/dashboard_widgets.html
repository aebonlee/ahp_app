{% load static %}

<!-- AHP Platform Super Admin Dashboard Widgets -->

<!-- System Overview Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
    
    <!-- Users Statistics -->
    <div class="stats-card">
        <div class="stats-number" id="total-users">-</div>
        <div class="stats-label">ì´ ì‚¬ìš©ì</div>
        <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
            í™œì„±: <span id="active-users">-</span> | ì‹ ê·œ: <span id="new-users">-</span>
        </div>
    </div>
    
    <!-- Projects Statistics -->
    <div class="stats-card">
        <div class="stats-number" id="total-projects">-</div>
        <div class="stats-label">ì´ í”„ë¡œì íŠ¸</div>
        <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
            ì§„í–‰ì¤‘: <span id="active-projects">-</span> | ì™„ë£Œ: <span id="completed-projects">-</span>
        </div>
    </div>
    
    <!-- Evaluations Statistics -->
    <div class="stats-card">
        <div class="stats-number" id="total-evaluations">-</div>
        <div class="stats-label">ì´ í‰ê°€</div>
        <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
            ì˜¤ëŠ˜: <span id="today-evaluations">-</span>
        </div>
    </div>
    
    <!-- System Health -->
    <div class="stats-card">
        <div class="stats-number" style="color: #27ae60;" id="system-uptime">99.9%</div>
        <div class="stats-label">ì‹œìŠ¤í…œ ê°€ë™ë¥ </div>
        <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
            ì‘ë‹µì‹œê°„: <span id="avg-response">-</span>ms
        </div>
    </div>
</div>

<!-- Quick Actions Panel -->
<div class="dashboard-widget">
    <h3>âš¡ ë¹ ë¥¸ ì‘ì—…</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        
        <a href="{% url 'admin:accounts_user_add' %}" class="quick-action-btn">
            <div class="quick-action-icon">ğŸ‘¤</div>
            <div class="quick-action-label">ìƒˆ ì‚¬ìš©ì ì¶”ê°€</div>
        </a>
        
        <a href="{% url 'admin:projects_project_add' %}" class="quick-action-btn">
            <div class="quick-action-icon">ğŸ“Š</div>
            <div class="quick-action-label">ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</div>
        </a>
        
        <a href="{% url 'admin:system_systemsettings_changelist' %}" class="quick-action-btn">
            <div class="quick-action-icon">âš™ï¸</div>
            <div class="quick-action-label">ì‹œìŠ¤í…œ ì„¤ì •</div>
        </a>
        
        <a href="{% url 'admin:system_systemlog_changelist' %}" class="quick-action-btn">
            <div class="quick-action-icon">ğŸ“‹</div>
            <div class="quick-action-label">ì‹œìŠ¤í…œ ë¡œê·¸</div>
        </a>
        
        <a href="{% url 'admin:system_backuprecord_changelist' %}" class="quick-action-btn">
            <div class="quick-action-icon">ğŸ’¾</div>
            <div class="quick-action-label">ë°±ì—… ê´€ë¦¬</div>
        </a>
        
        <button onclick="createSystemBackup()" class="quick-action-btn">
            <div class="quick-action-icon">ğŸ”„</div>
            <div class="quick-action-label">ì¦‰ì‹œ ë°±ì—…</div>
        </button>
    </div>
</div>

<!-- Recent Activity Panel -->
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
    
    <!-- Recent Users -->
    <div class="dashboard-widget">
        <h3>ğŸ‘¥ ìµœê·¼ ê°€ì…í•œ ì‚¬ìš©ì</h3>
        <div id="recent-users">ë¡œë”© ì¤‘...</div>
    </div>
    
    <!-- Recent Projects -->
    <div class="dashboard-widget">
        <h3>ğŸ“Š ìµœê·¼ ìƒì„±ëœ í”„ë¡œì íŠ¸</h3>
        <div id="recent-projects">ë¡œë”© ì¤‘...</div>
    </div>
</div>

<!-- System Alerts Panel -->
<div class="dashboard-widget">
    <h3>ğŸš¨ ì‹œìŠ¤í…œ ì•Œë¦¼</h3>
    <div id="system-alerts">
        <div class="alert alert-info">
            <strong>ì •ë³´:</strong> AHP Platformì´ ì •ìƒì ìœ¼ë¡œ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤.
        </div>
    </div>
</div>

<!-- Performance Charts Panel -->
<div class="dashboard-widget">
    <h3>ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        
        <!-- API Response Time Chart -->
        <div>
            <h4 style="color: #7f8c8d; font-size: 14px; margin-bottom: 10px;">API ì‘ë‹µ ì‹œê°„ (24ì‹œê°„)</h4>
            <canvas id="responseTimeChart" width="300" height="150"></canvas>
        </div>
        
        <!-- User Activity Chart -->
        <div>
            <h4 style="color: #7f8c8d; font-size: 14px; margin-bottom: 10px;">ì‚¬ìš©ì í™œë™ (7ì¼)</h4>
            <canvas id="userActivityChart" width="300" height="150"></canvas>
        </div>
    </div>
</div>

<style>
.quick-action-btn {
    display: block;
    text-decoration: none;
    background: white;
    border: 2px solid #e1e8ed;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    transition: all 0.3s ease;
    color: #2c3e50;
}

.quick-action-btn:hover {
    border-color: #3498db;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
    text-decoration: none;
    color: #3498db;
}

.quick-action-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.quick-action-label {
    font-size: 13px;
    font-weight: 600;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #ecf0f1;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 10px;
    font-size: 12px;
}

.activity-content {
    flex: 1;
}

.activity-title {
    font-weight: 600;
    color: #2c3e50;
    font-size: 13px;
}

.activity-meta {
    font-size: 11px;
    color: #7f8c8d;
    margin-top: 2px;
}
</style>

<script>
// Dashboard Data Loading
async function loadDashboardData() {
    try {
        // Load statistics (you would replace these with actual API calls)
        document.getElementById('total-users').textContent = '1,247';
        document.getElementById('active-users').textContent = '892';
        document.getElementById('new-users').textContent = '23';
        
        document.getElementById('total-projects').textContent = '156';
        document.getElementById('active-projects').textContent = '43';
        document.getElementById('completed-projects').textContent = '98';
        
        document.getElementById('total-evaluations').textContent = '2,341';
        document.getElementById('today-evaluations').textContent = '17';
        
        document.getElementById('avg-response').textContent = '145';
        
        // Load recent activities
        loadRecentUsers();
        loadRecentProjects();
        loadSystemAlerts();
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

function loadRecentUsers() {
    const recentUsers = [
        { name: 'ê¹€ì² ìˆ˜', email: 'kim@example.com', joined: '2ì‹œê°„ ì „', type: 'evaluator' },
        { name: 'ì´ì˜í¬', email: 'lee@example.com', joined: '5ì‹œê°„ ì „', type: 'admin' },
        { name: 'ë°•ë¯¼ìˆ˜', email: 'park@example.com', joined: '1ì¼ ì „', type: 'user' }
    ];
    
    const container = document.getElementById('recent-users');
    container.innerHTML = recentUsers.map(user => `
        <div class="activity-item">
            <div class="activity-icon" style="background: #3498db; color: white;">
                ${user.type === 'admin' ? 'ğŸ‘‘' : user.type === 'evaluator' ? 'ğŸ“Š' : 'ğŸ‘¤'}
            </div>
            <div class="activity-content">
                <div class="activity-title">${user.name}</div>
                <div class="activity-meta">${user.email} â€¢ ${user.joined}</div>
            </div>
        </div>
    `).join('');
}

function loadRecentProjects() {
    const recentProjects = [
        { title: 'ì‹ ì œí’ˆ ê°œë°œ ìš°ì„ ìˆœìœ„ í‰ê°€', owner: 'ê¹€ì² ìˆ˜', created: '3ì‹œê°„ ì „', status: 'active' },
        { title: 'ê³µê¸‰ì—…ì²´ ì„ ì • ë¶„ì„', owner: 'ì´ì˜í¬', created: '1ì¼ ì „', status: 'evaluation' },
        { title: 'íˆ¬ì í¬íŠ¸í´ë¦¬ì˜¤ ìµœì í™”', owner: 'ë°•ë¯¼ìˆ˜', created: '2ì¼ ì „', status: 'completed' }
    ];
    
    const statusColors = {
        'active': '#3498db',
        'evaluation': '#f39c12',
        'completed': '#27ae60'
    };
    
    const container = document.getElementById('recent-projects');
    container.innerHTML = recentProjects.map(project => `
        <div class="activity-item">
            <div class="activity-icon" style="background: ${statusColors[project.status]}; color: white;">
                ğŸ“Š
            </div>
            <div class="activity-content">
                <div class="activity-title">${project.title}</div>
                <div class="activity-meta">${project.owner} â€¢ ${project.created}</div>
            </div>
        </div>
    `).join('');
}

function loadSystemAlerts() {
    // This would typically load from your backend
    const alerts = [
        { type: 'success', message: 'ë°±ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', time: '10ë¶„ ì „' },
        { type: 'warning', message: 'PostgreSQL ì—°ê²° í’€ ì‚¬ìš©ë¥ ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.', time: '1ì‹œê°„ ì „' }
    ];
    
    const container = document.getElementById('system-alerts');
    const existingAlerts = container.querySelectorAll('.alert:not(.alert-info)');
    existingAlerts.forEach(alert => alert.remove());
    
    alerts.forEach(alert => {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${alert.type}`;
        alertDiv.innerHTML = `
            <strong>${alert.type === 'success' ? 'ì„±ê³µ' : 'ê²½ê³ '}:</strong> 
            ${alert.message}
            <small style="float: right; opacity: 0.7;">${alert.time}</small>
        `;
        container.appendChild(alertDiv);
    });
}

// System Actions
async function createSystemBackup() {
    if (!confirm('ì‹œìŠ¤í…œ ë°±ì—…ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    const btn = event.target.closest('.quick-action-btn');
    const originalContent = btn.innerHTML;
    
    btn.innerHTML = `
        <div class="quick-action-icon">â³</div>
        <div class="quick-action-label">ë°±ì—… ì¤‘...</div>
    `;
    btn.style.pointerEvents = 'none';
    
    try {
        // Simulate backup creation (replace with actual API call)
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        btn.innerHTML = `
            <div class="quick-action-icon">âœ…</div>
            <div class="quick-action-label">ë°±ì—… ì™„ë£Œ</div>
        `;
        
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.style.pointerEvents = 'auto';
        }, 2000);
        
        // Add success alert
        const alertsContainer = document.getElementById('system-alerts');
        const successAlert = document.createElement('div');
        successAlert.className = 'alert alert-success';
        successAlert.innerHTML = '<strong>ì„±ê³µ:</strong> ì‹œìŠ¤í…œ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
        alertsContainer.insertBefore(successAlert, alertsContainer.firstChild);
        
    } catch (error) {
        btn.innerHTML = `
            <div class="quick-action-icon">âŒ</div>
            <div class="quick-action-label">ë°±ì—… ì‹¤íŒ¨</div>
        `;
        
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.style.pointerEvents = 'auto';
        }, 2000);
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    
    // Refresh data every 5 minutes
    setInterval(loadDashboardData, 300000);
});

// Simple chart rendering (you might want to use Chart.js for production)
function drawSimpleChart(canvasId, data, color) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw axes
    ctx.strokeStyle = '#e1e8ed';
    ctx.lineWidth = 1;
    
    // Y axis
    ctx.beginPath();
    ctx.moveTo(30, 10);
    ctx.lineTo(30, height - 20);
    ctx.stroke();
    
    // X axis
    ctx.beginPath();
    ctx.moveTo(30, height - 20);
    ctx.lineTo(width - 10, height - 20);
    ctx.stroke();
    
    // Draw data line
    if (data && data.length > 0) {
        const maxValue = Math.max(...data);
        const stepX = (width - 40) / (data.length - 1);
        const stepY = (height - 30) / maxValue;
        
        ctx.strokeStyle = color || '#3498db';
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        data.forEach((value, index) => {
            const x = 30 + index * stepX;
            const y = height - 20 - value * stepY;
            
            if (index === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        });
        
        ctx.stroke();
    }
}

// Initialize charts with sample data
setTimeout(() => {
    drawSimpleChart('responseTimeChart', [120, 135, 115, 140, 125, 155, 145, 130], '#3498db');
    drawSimpleChart('userActivityChart', [245, 267, 289, 312, 298, 334, 356], '#27ae60');
}, 1000);
</script>