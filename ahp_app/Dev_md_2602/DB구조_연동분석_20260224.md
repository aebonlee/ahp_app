# DB 구조 & 연동 분석 보고서 — 2026-02-24

## 전체 아키텍처

```
React 18 (TypeScript)  ←→  Django REST Framework  ←→  PostgreSQL
     GitHub Pages              Render.com               Render.com
```

- **백엔드**: `https://ahp-django-backend.onrender.com`
- **인증**: JWT (simplejwt) — sessionStorage 기반
- **데이터 모드**: production=online, development=hybrid

---

## 1. API 엔드포인트 전체 구조

### Auth (인증)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| POST | `/api/service/auth/token/` | JWT 토큰 발급 |
| POST | `/api/service/auth/register/` | 회원가입 |
| POST | `/api/service/auth/logout/` | 로그아웃 |
| GET/PATCH | `/api/service/accounts/me/` | 현재 사용자 조회/수정 |
| POST | `/api/service/auth/token/refresh/` | 토큰 갱신 |

### Projects (프로젝트)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET/POST | `/api/service/projects/projects/` | 목록/생성 |
| GET/PATCH/DELETE | `/api/service/projects/projects/{id}/` | 상세/수정/삭제 |

### Criteria & Alternatives (기준/대안 — 동일 테이블)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET | `/api/service/projects/criteria/?project={id}` | 기준 목록 |
| GET | `/api/service/projects/criteria/?project={id}&type=alternative` | 대안 목록 |
| POST | `/api/service/projects/criteria/` | 생성 (type으로 구분) |
| PUT/DELETE | `/api/service/projects/criteria/{id}/` | 수정/삭제 |

### Evaluators (평가자)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET | `/api/service/evaluations/invitations/?project={id}` | 목록 |
| POST | `/api/service/evaluations/invitations/` | 추가 |
| PATCH/DELETE | `/api/service/evaluations/invitations/{id}/` | 수정/삭제 |
| POST | `/api/service/evaluations/bulk-invitations/` | 일괄 초대 |

### Comparisons (쌍대비교)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| POST | `/api/service/evaluations/comparisons/` | 비교 저장 |
| GET | `/api/service/evaluations/comparisons/?project={id}` | 비교 조회 |

### Results (분석 결과)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET | `/api/service/analysis/project-summary/?project_id={id}` | 프로젝트 결과 |
| POST | `/api/service/analysis/calculate/individual/` | 개별 계산 |
| POST | `/api/service/analysis/calculate/group/` | 그룹 계산 |
| POST | `/api/service/analysis/sensitivity/` | 민감도 분석 |

### Surveys (설문)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET/POST | `/api/service/projects/{id}/surveys/` | 목록/생성 |
| GET/PATCH/DELETE | `/api/service/evaluations/demographic-surveys/{id}/` | 상세/수정/삭제 |
| POST | `/api/service/evaluations/demographic-surveys/{id}/submit/` | 응답 제출 |

### Export (내보내기)
| 메서드 | 엔드포인트 | 용도 |
|--------|-----------|------|
| GET | `/api/service/export/excel/?project={id}` | Excel |
| GET | `/api/service/export/pdf/?project={id}` | PDF |
| GET | `/api/service/export/report/?project={id}` | 보고서 |

---

## 2. 데이터 모델 (프론트엔드 타입)

### User
```typescript
interface User {
  id: string | number
  username: string
  email: string
  role: 'super_admin' | 'service_admin' | 'service_user' | 'evaluator'
  phone?: string
  organization?: string
  is_verified: boolean
  can_create_projects: boolean
  max_projects: number
}
```

### Project
```typescript
interface Project {
  id: string | number
  title: string
  description: string
  objective: string
  status: 'draft' | 'active' | 'completed' | 'deleted' | 'evaluation' | 'archived'
  evaluation_mode: 'practical' | 'theoretical' | 'direct_input' | 'fuzzy_ahp'
  workflow_stage: 'creating' | 'waiting' | 'evaluating' | 'completed'
  criteria_count?: number
  alternatives_count?: number
  evaluator_count?: number
}
```

### Criteria/Alternative (동일 테이블)
```typescript
interface Criteria {
  id: string | number
  project: number
  name: string
  description: string
  parent?: number    // 계층 구조
  level: number
  type: 'criteria' | 'alternative'
  weight: number
  local_weight: number
}
```

### Comparison (쌍대비교)
```typescript
interface Comparison {
  id: string | number
  project: number
  evaluator: number
  item1: number
  item2: number
  value: number      // 1/9 ~ 9
}
```

### Result
```typescript
interface Result {
  id: string | number
  project: number
  weights: Record<string, number>
  rankings: Record<string, number>
  consistency_ratio: number
  is_group_result: boolean
}
```

---

## 3. 인증 흐름

```
로그인: POST /api/service/auth/token/
  → { access, refresh, user }
  → sessionStorage에 저장

모든 API 요청:
  → Authorization: Bearer {accessToken}
  → 401 시 → POST /token/refresh/ → 재시도

슈퍼관리자 판별:
  → user.email === SUPER_ADMIN_EMAIL → role='super_admin'
  → 클라이언트 UI용, 서버 권한은 별도 검증
```

---

## 4. Django ↔ React 필드 정규화

| Django 필드 | React 필드 |
|------------|-----------|
| `member_count` | `evaluatorCount` |
| `deadline` | `dueDate` |
| `status='evaluation'` | `status='active'` |
| `status='archived'` | `status='completed'` |
| `criteria_count` | `criteriaCount` |
| `alternatives_count` | `alternativesCount` |

---

## 5. 서비스 파일 매핑

| 서비스 | 파일 | 담당 API |
|--------|------|---------|
| api.ts | 856줄 | 전체 API 통합 (makeRequest, 정규화) |
| authService.ts | 424줄 | 인증 (JWT, 소셜, 2FA) |
| apiService.ts | 150줄 | HTTP 클라이언트 래퍼 |
| dataService.ts | 100줄 | 비즈니스 CRUD |
| sessionService.ts | 80줄 | 세션 타이머 (30분 만료) |
| subscriptionService.ts | 80줄 | 구독/결제 |
| invitationService.ts | 100줄 | 평가자 초대 (9-상태) |
| fileUploadService.ts | 80줄 | 파일 업로드 (FormData) |
| aiService.ts | — | AI 연동 (ChatGPT/Claude) |
| anonymousEvaluationService.ts | — | 익명 평가 세션 |
| djangoAdminService.ts | — | Django Admin 통합 |
| systemManagementService.ts | — | 시스템 관리 |
| twoFactorService.ts | — | 2FA (TOTP) |

---

## 6. 보안 구현

- **JWT**: sessionStorage 전용 (localStorage 제거)
- **API 키**: encryptedLocalStorage (Base64 난독화)
- **AES-GCM**: secureStorage.ts (Web Crypto API)
- **CORS**: credentials='include'
- **토큰 갱신**: 5분 전 자동, 401 시 자동 재시도

---

**작성**: Claude Opus 4.6
**날짜**: 2026-02-24
