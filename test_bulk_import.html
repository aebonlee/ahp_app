<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AHP ì¼ê´„ì…ë ¥ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .example-text { background: white; padding: 15px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; }
        button { padding: 10px 20px; margin: 10px 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #3B82F6; color: white; }
        .btn-secondary { background: #6B7280; color: white; }
        .result { background: #10B981; color: white; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #EF4444; color: white; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .hierarchy { margin-left: 20px; }
        .level-1 { font-weight: bold; color: #1F2937; }
        .level-2 { margin-left: 20px; color: #4B5563; }
        .level-3 { margin-left: 40px; color: #6B7280; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ AHP ì¼ê´„ì…ë ¥ í…ŒìŠ¤íŠ¸</h1>
        
        <div class="test-section">
            <h2>ì˜ˆì œ 3: ë“¤ì—¬ì“°ê¸° í˜•ì‹ (13ê°œ í•­ëª©)</h2>
            <div class="example-text" id="example3">ê¸°ì—… í‰ê°€ ê¸°ì¤€
    ì¬ë¬´ ì„±ê³¼
        ìˆ˜ìµì„± - ë§¤ì¶œì•¡ê³¼ ìˆœì´ìµ ì¦ê°€ìœ¨
        ì•ˆì •ì„± - ë¶€ì±„ë¹„ìœ¨ê³¼ ìœ ë™ë¹„ìœ¨
        ì„±ì¥ì„± - ì „ë…„ ëŒ€ë¹„ ì„±ì¥ë¥ ê³¼ ì‹œì¥ ì ìœ ìœ¨
    ìš´ì˜ íš¨ìœ¨ì„±
        ìƒì‚°ì„± - ì¸ë‹¹ ë§¤ì¶œì•¡ê³¼ ì„¤ë¹„ ê°€ë™ë¥ 
        í’ˆì§ˆ ê´€ë¦¬ - ë¶ˆëŸ‰ë¥ ê³¼ ê³ ê° ë§Œì¡±ë„
        í˜ì‹  ì—­ëŸ‰ - R&D íˆ¬ìì™€ ì‹ ì œí’ˆ ê°œë°œë ¥
    ì§€ì†ê°€ëŠ¥ì„±
        í™˜ê²½ ê²½ì˜ - ì¹œí™˜ê²½ ì •ì±…ê³¼ íƒ„ì†Œ ë°°ì¶œ ê°ì†Œ
        ì‚¬íšŒì  ì±…ì„ - ì‚¬íšŒê³µí—Œ í™œë™ê³¼ ìœ¤ë¦¬ ê²½ì˜
        ê±°ë²„ë„ŒìŠ¤ - íˆ¬ëª…í•œ ê²½ì˜ê³¼ ì´í•´ê´€ê³„ì ì†Œí†µ</div>
            <button class="btn-primary" onclick="parseExample3()">íŒŒì‹± í…ŒìŠ¤íŠ¸</button>
            <div id="result3"></div>
        </div>

        <div class="test-section">
            <h2>ë°±ì—”ë“œ ì €ì¥ í…ŒìŠ¤íŠ¸</h2>
            <p>í”„ë¡œì íŠ¸ ID: <input type="text" id="projectId" value="test_project_001" style="padding: 5px;"></p>
            <button class="btn-primary" onclick="testSaveToBackend()">ë°±ì—”ë“œì— ì €ì¥</button>
            <div id="saveResult"></div>
        </div>

        <div class="test-section">
            <h2>ì €ì¥ëœ ë°ì´í„° í™•ì¸</h2>
            <button class="btn-secondary" onclick="loadFromBackend()">ë°ì´í„° ë¡œë“œ</button>
            <div id="loadResult"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://ahp-django-backend.onrender.com';

        function parseExample3() {
            const text = document.getElementById('example3').innerText;
            const lines = text.split('\n');
            const criteria = [];
            const levelStack = {};

            lines.forEach((line, index) => {
                if (!line.trim()) return;
                
                // ê³µë°± ìˆ˜ ê³„ì‚°
                const spaces = line.match(/^(\s*)/)[1].length;
                const level = spaces === 0 ? 1 : Math.floor(spaces / 4) + 1;
                const content = line.trim();
                
                // ì´ë¦„ê³¼ ì„¤ëª… ë¶„ë¦¬
                let name, description = '';
                if (content.includes(' - ')) {
                    [name, description] = content.split(' - ');
                } else {
                    name = content;
                }
                
                // ë¶€ëª¨ ì°¾ê¸°
                let parent_id = null;
                if (level > 1) {
                    const parentLevel = level - 1;
                    if (levelStack[parentLevel]) {
                        parent_id = levelStack[parentLevel].id;
                    }
                }
                
                const criterion = {
                    id: `criterion_${index}`,
                    name: name.trim(),
                    description: description.trim(),
                    level: level,
                    parent_id: parent_id,
                    order: index + 1
                };
                
                criteria.push(criterion);
                levelStack[level] = criterion;
                
                // í˜„ì¬ ë ˆë²¨ë³´ë‹¤ ë†’ì€ ë ˆë²¨ ì œê±°
                Object.keys(levelStack).forEach(lvl => {
                    if (parseInt(lvl) > level) {
                        delete levelStack[lvl];
                    }
                });
            });

            // ê²°ê³¼ í‘œì‹œ
            let html = `<div class="result">âœ… ${criteria.length}ê°œ í•­ëª© íŒŒì‹± ì™„ë£Œ</div>`;
            html += '<div class="hierarchy">';
            criteria.forEach(c => {
                const className = `level-${c.level}`;
                html += `<div class="${className}">`;
                html += `L${c.level} - ${c.name}`;
                if (c.description) html += ` (${c.description})`;
                if (c.parent_id) html += ` [ë¶€ëª¨: ${c.parent_id}]`;
                html += '</div>';
            });
            html += '</div>';
            
            document.getElementById('result3').innerHTML = html;
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.parsedCriteria = criteria;
        }

        async function testSaveToBackend() {
            if (!window.parsedCriteria) {
                alert('ë¨¼ì € íŒŒì‹± í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”');
                return;
            }
            
            const projectId = document.getElementById('projectId').value;
            const resultDiv = document.getElementById('saveResult');
            
            resultDiv.innerHTML = '<div class="result">ì €ì¥ ì¤‘...</div>';
            
            try {
                const savedIds = {};
                let successCount = 0;
                
                // ë ˆë²¨ ìˆœì„œëŒ€ë¡œ ì €ì¥
                const sortedCriteria = [...window.parsedCriteria].sort((a, b) => a.level - b.level);
                
                for (const criterion of sortedCriteria) {
                    // ë¶€ëª¨ ID ë§¤í•‘
                    let parent_id = null;
                    if (criterion.parent_id && savedIds[criterion.parent_id]) {
                        parent_id = savedIds[criterion.parent_id];
                    }
                    
                    const data = {
                        project: projectId,
                        name: criterion.name,
                        description: criterion.description,
                        parent_id: parent_id,
                        level: criterion.level,
                        position: criterion.order,
                        order: criterion.order
                    };
                    
                    console.log('Saving:', data);
                    
                    // API í˜¸ì¶œ
                    const response = await fetch(`${API_BASE_URL}/api/service/projects/criteria/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        savedIds[criterion.id] = result.id;
                        successCount++;
                    } else {
                        console.error('Save failed:', await response.text());
                    }
                }
                
                resultDiv.innerHTML = `<div class="result">âœ… ${successCount}/${sortedCriteria.length}ê°œ í•­ëª© ì €ì¥ ì™„ë£Œ</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ì €ì¥ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }

        async function loadFromBackend() {
            const projectId = document.getElementById('projectId').value;
            const resultDiv = document.getElementById('loadResult');
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/service/projects/criteria/?project=${projectId}`);
                const data = await response.json();
                
                let html = `<div class="result">âœ… ${data.length}ê°œ í•­ëª© ë¡œë“œ ì™„ë£Œ</div>`;
                html += '<div class="hierarchy">';
                data.forEach(c => {
                    const className = `level-${c.level || 1}`;
                    html += `<div class="${className}">`;
                    html += `${c.name}`;
                    if (c.description) html += ` - ${c.description}`;
                    html += '</div>';
                });
                html += '</div>';
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>