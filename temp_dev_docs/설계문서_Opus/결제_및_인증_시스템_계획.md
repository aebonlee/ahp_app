# ğŸ’³ ê²°ì œ ë° ì¸ì¦ ì‹œìŠ¤í…œ í†µí•© ê³„íš
## ì‘ì„±ì¼: 2024-11-12
## ì‘ì„±ì: Claude Opus 4.1
## ìƒíƒœ: ê³„íš ìˆ˜ë¦½ (êµ¬í˜„ ë³´ë¥˜)

---

## 1. ì´ë‹ˆì‹œìŠ¤(INICIS) ê²°ì œ ì‹œìŠ¤í…œ ê³„íš

### 1.1 ì„ íƒ ì´ìœ 
- êµ­ë‚´ 1ìœ„ PGì‚¬ë¡œ ì•ˆì •ì„± ë†’ìŒ
- ë‹¤ì–‘í•œ ê²°ì œ ìˆ˜ë‹¨ ì§€ì›
- ì—ìŠ¤í¬ë¡œ ì„œë¹„ìŠ¤ ì œê³µ
- ì •ê¸°ê²°ì œ ì§€ì›

### 1.2 í•„ìš”í•œ ì¤€ë¹„ ì‚¬í•­
```
[ ] ì‚¬ì—…ì ë“±ë¡ì¦
[ ] ì´ë‹ˆì‹œìŠ¤ ê°€ë§¹ì  ì‹ ì²­
[ ] MID (Merchant ID) ë°œê¸‰
[ ] ê²°ì œ ì¸ì¦í‚¤ ë°œê¸‰
[ ] í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
```

### 1.3 ì§€ì› ê²°ì œ ìˆ˜ë‹¨
- ì‹ ìš©ì¹´ë“œ (êµ­ë‚´/í•´ì™¸)
- ì‹¤ì‹œê°„ ê³„ì¢Œì´ì²´
- ê°€ìƒê³„ì¢Œ
- íœ´ëŒ€í° ê²°ì œ
- ì¹´ì¹´ì˜¤í˜ì´, ë„¤ì´ë²„í˜ì´ ë“±

### 1.4 í†µí•© ì•„í‚¤í…ì²˜ (ê³„íš)

```typescript
// ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤
interface InicisPaymentService {
  // ì¼ë°˜ ê²°ì œ
  requestPayment(params: PaymentRequest): Promise<PaymentResponse>;
  
  // ì •ê¸° ê²°ì œ
  subscribeBilling(params: BillingRequest): Promise<BillingResponse>;
  
  // ê²°ì œ ì·¨ì†Œ
  cancelPayment(tid: string, amount?: number): Promise<CancelResponse>;
  
  // ê²°ì œ ì¡°íšŒ
  queryPayment(tid: string): Promise<PaymentInfo>;
}

interface PaymentRequest {
  oid: string;          // ì£¼ë¬¸ë²ˆí˜¸
  price: number;        // ê²°ì œê¸ˆì•¡
  goodname: string;     // ìƒí’ˆëª…
  buyername: string;    // êµ¬ë§¤ìëª…
  buyertel: string;     // êµ¬ë§¤ì ì—°ë½ì²˜
  buyeremail: string;   // êµ¬ë§¤ì ì´ë©”ì¼
  returnUrl: string;    // ê²°ì œ ì™„ë£Œ í›„ ë¦¬í„´ URL
  closeUrl: string;     // ê²°ì œ ì°½ ë‹«ê¸° URL
}
```

### 1.5 ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- HTTPS í•„ìˆ˜
- ìœ„ë³€ì¡° ë°©ì§€ í•´ì‹œ ê²€ì¦
- IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸
- ê²°ì œ ë¡œê·¸ ì•”í˜¸í™” ì €ì¥

---

## 2. ì†Œì…œ ë¡œê·¸ì¸ í†µí•© ê³„íš

### 2.1 ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸

#### í•„ìš” ì¤€ë¹„ì‚¬í•­
```
[ ] Kakao Developers ê³„ì •
[ ] ì•± ë“±ë¡ ë° ì•± í‚¤ ë°œê¸‰
[ ] Redirect URI ì„¤ì •
[ ] ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™œì„±í™”
[ ] í•„ìˆ˜ ë™ì˜ í•­ëª© ì„¤ì •
```

#### êµ¬í˜„ ê³„íš
```typescript
interface KakaoAuthService {
  // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ URL ìƒì„±
  getAuthUrl(): string;
  
  // ì¸ê°€ ì½”ë“œë¡œ í† í° ë°›ê¸°
  getToken(code: string): Promise<KakaoToken>;
  
  // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
  getUserInfo(token: string): Promise<KakaoUser>;
  
  // ë¡œê·¸ì•„ì›ƒ
  logout(token: string): Promise<void>;
}
```

### 2.2 ë„¤ì´ë²„ ë¡œê·¸ì¸

#### í•„ìš” ì¤€ë¹„ì‚¬í•­
```
[ ] ë„¤ì´ë²„ ê°œë°œì ì„¼í„° ë“±ë¡
[ ] ì• í”Œë¦¬ì¼€ì´ì…˜ ë“±ë¡
[ ] Client ID/Secret ë°œê¸‰
[ ] ì„œë¹„ìŠ¤ URL ì„¤ì •
[ ] ê²€ìˆ˜ ì‹ ì²­ (ì„ íƒ)
```

#### êµ¬í˜„ ê³„íš
```typescript
interface NaverAuthService {
  // ë„¤ì´ë²„ ë¡œê·¸ì¸ URL ìƒì„±
  getAuthUrl(state: string): string;
  
  // Access Token ë°œê¸‰
  getToken(code: string, state: string): Promise<NaverToken>;
  
  // í”„ë¡œí•„ ì¡°íšŒ
  getProfile(token: string): Promise<NaverProfile>;
  
  // í† í° ê°±ì‹ 
  refreshToken(refreshToken: string): Promise<NaverToken>;
}
```

### 2.3 êµ¬ê¸€ ë¡œê·¸ì¸

#### í•„ìš” ì¤€ë¹„ì‚¬í•­
```
[ ] Google Cloud Console í”„ë¡œì íŠ¸
[ ] OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ìƒì„±
[ ] ìŠ¹ì¸ëœ ë¦¬ë””ë ‰ì…˜ URI ì„¤ì •
[ ] Google API ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
```

#### êµ¬í˜„ ê³„íš
```typescript
interface GoogleAuthService {
  // Google Sign-In ì´ˆê¸°í™”
  initializeGoogleSignIn(clientId: string): void;
  
  // ë¡œê·¸ì¸ ì²˜ë¦¬
  signIn(): Promise<GoogleUser>;
  
  // ID í† í° ê²€ì¦
  verifyIdToken(idToken: string): Promise<TokenPayload>;
  
  // ë¡œê·¸ì•„ì›ƒ
  signOut(): Promise<void>;
}
```

### 2.4 í†µí•© ì¸ì¦ ê´€ë¦¬ì

```typescript
// í†µí•© ì†Œì…œ ë¡œê·¸ì¸ ê´€ë¦¬
class SocialAuthManager {
  private providers: Map<string, SocialAuthProvider>;
  
  constructor() {
    this.providers = new Map([
      ['kakao', new KakaoAuthService()],
      ['naver', new NaverAuthService()],
      ['google', new GoogleAuthService()]
    ]);
  }
  
  async authenticate(provider: string, code: string): Promise<User> {
    const authService = this.providers.get(provider);
    if (!authService) {
      throw new Error(`Unknown provider: ${provider}`);
    }
    
    // 1. ì†Œì…œ í† í° íšë“
    const socialToken = await authService.getToken(code);
    
    // 2. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    const socialUser = await authService.getUserInfo(socialToken);
    
    // 3. ë¡œì»¬ ì‚¬ìš©ì ìƒì„±/ì—…ë°ì´íŠ¸
    const user = await this.findOrCreateUser(socialUser, provider);
    
    // 4. JWT í† í° ë°œê¸‰
    const jwtToken = await this.generateJWT(user);
    
    return { user, token: jwtToken };
  }
}
```

---

## 3. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ (ê³„íš)

### 3.1 ì†Œì…œ ì¸ì¦ í…Œì´ë¸”

```sql
-- ì†Œì…œ ë¡œê·¸ì¸ ì •ë³´
CREATE TABLE social_auth (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(20) NOT NULL, -- 'kakao', 'naver', 'google'
  social_id VARCHAR(255) NOT NULL, -- ì†Œì…œ í”Œë«í¼ì˜ ì‚¬ìš©ì ID
  access_token TEXT,
  refresh_token TEXT,
  token_expires_at TIMESTAMP WITH TIME ZONE,
  profile_data JSONB, -- ì†Œì…œ í”„ë¡œí•„ ì •ë³´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  
  UNIQUE(provider, social_id)
);

-- ì´ë‹ˆì‹œìŠ¤ ê²°ì œ ë‚´ì—­
CREATE TABLE inicis_payments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  subscription_id UUID REFERENCES subscriptions(id),
  
  -- ì´ë‹ˆì‹œìŠ¤ ì •ë³´
  tid VARCHAR(100) UNIQUE NOT NULL, -- ê±°ë˜ë²ˆí˜¸
  oid VARCHAR(100) NOT NULL, -- ì£¼ë¬¸ë²ˆí˜¸
  mid VARCHAR(50) NOT NULL, -- ê°€ë§¹ì  ID
  
  -- ê²°ì œ ì •ë³´
  amount DECIMAL(10,2) NOT NULL,
  currency VARCHAR(3) DEFAULT 'KRW',
  pay_method VARCHAR(20), -- 'CARD', 'BANK', 'VBANK', 'MOBILE'
  status VARCHAR(20) NOT NULL, -- 'pending', 'paid', 'cancelled', 'failed'
  
  -- ì¹´ë“œ ì •ë³´ (ë§ˆìŠ¤í‚¹)
  card_number VARCHAR(20), -- ë§ˆìŠ¤í‚¹ëœ ì¹´ë“œë²ˆí˜¸
  card_company VARCHAR(50),
  
  -- ì‘ë‹µ ì •ë³´
  result_code VARCHAR(10),
  result_msg TEXT,
  auth_token TEXT,
  auth_url TEXT,
  
  -- ì·¨ì†Œ ì •ë³´
  cancelled_at TIMESTAMP WITH TIME ZONE,
  cancel_reason TEXT,
  cancelled_amount DECIMAL(10,2),
  
  metadata JSONB,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

---

## 4. êµ¬í˜„ ë³´ë¥˜ ì‚¬ìœ 

### 4.1 í•„ìš”í•œ ì™¸ë¶€ ë“±ë¡
1. **ì´ë‹ˆì‹œìŠ¤**
   - ì‚¬ì—…ì ë“±ë¡ í•„ìš”
   - ê°€ë§¹ì  ê³„ì•½ í•„ìš”
   - ì‹¬ì‚¬ ê¸°ê°„ ì†Œìš”

2. **ì†Œì…œ ë¡œê·¸ì¸**
   - ê° í”Œë«í¼ ê°œë°œì ë“±ë¡ í•„ìš”
   - ì•± ì‹¬ì‚¬ í•„ìš” (ë„¤ì´ë²„)
   - ë„ë©”ì¸ ê²€ì¦ í•„ìš”

### 4.2 í˜„ì¬ ìš°ì„ ìˆœìœ„
1. í•µì‹¬ í‰ê°€ ì‹œìŠ¤í…œ êµ¬í˜„ (ì§„í–‰ ì¤‘)
2. ê¸°ë³¸ ì´ë©”ì¼ ì¸ì¦ìœ¼ë¡œ MVP ì¶œì‹œ
3. MVP ê²€ì¦ í›„ ê²°ì œ/ì†Œì…œ ë¡œê·¸ì¸ ì¶”ê°€

---

## 5. í–¥í›„ êµ¬í˜„ ì¼ì • (ì˜ˆì •)

### Phase 1: ì¤€ë¹„ (2024ë…„ 12ì›”)
- ì‚¬ì—…ì ë“±ë¡ ì™„ë£Œ
- ê° í”Œë«í¼ ê°œë°œì ë“±ë¡
- API í‚¤ ë°œê¸‰

### Phase 2: ê°œë°œ (2025ë…„ 1ì›”)
- ì†Œì…œ ë¡œê·¸ì¸ êµ¬í˜„
- ì´ë‹ˆì‹œìŠ¤ ì—°ë™ ê°œë°œ
- í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì¶•

### Phase 3: ê²€ì¦ (2025ë…„ 2ì›”)
- í†µí•© í…ŒìŠ¤íŠ¸
- ë³´ì•ˆ ê²€ì¦
- ì‹¤ ì„œë¹„ìŠ¤ ì ìš©

---

**ì‘ì„± ì™„ë£Œ**: 2024-11-12 04:15 KST
**ìƒíƒœ**: ê³„íš ìˆ˜ë¦½ ì™„ë£Œ, êµ¬í˜„ ë³´ë¥˜
**ë‹¤ìŒ ì‘ì—…**: ë³µì¡í•œ í‰ê°€ ì‹œìŠ¤í…œ ê°œë°œ ê³„ì†