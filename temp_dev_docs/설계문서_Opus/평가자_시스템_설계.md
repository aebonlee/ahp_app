# ğŸ“‹ í‰ê°€ì ì‹œìŠ¤í…œ ì„¤ê³„ ë¬¸ì„œ
## ì‘ì„±ì¼: 2024-11-12
## ì‘ì„±ì: Claude Opus 4.1
## í”„ë¡œì íŠ¸: AHP Decision Support Platform

---

## 1. ì‹œìŠ¤í…œ ê°œìš”

### 1.1 ëª©ì 
í‰ê°€ì ì´ˆëŒ€, ì¸ì¦, í‰ê°€ ìˆ˜í–‰, ì§„í–‰ë¥  ì¶”ì ì„ ìœ„í•œ ì™„ì „í•œ í‰ê°€ì ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬ì¶•

### 1.2 í•µì‹¬ ìš”êµ¬ì‚¬í•­
- ì´ë©”ì¼ ê¸°ë°˜ í‰ê°€ì ì´ˆëŒ€
- í† í° ê¸°ë°˜ ë³´ì•ˆ ì¸ì¦
- ìµëª… í‰ê°€ ì§€ì›
- ì‹¤ì‹œê°„ ì§„í–‰ë¥  ì¶”ì 
- ê·¸ë£¹ í‰ê°€ í†µí•©

---

## 2. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ì„¤ê³„

### 2.1 í‰ê°€ì í…Œì´ë¸” (evaluators)
```sql
CREATE TABLE evaluators (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    email VARCHAR(255) NOT NULL,
    name VARCHAR(100),
    organization VARCHAR(100),
    role VARCHAR(50), -- 'expert', 'stakeholder', 'general'
    invitation_token VARCHAR(255) UNIQUE,
    token_expires_at TIMESTAMP WITH TIME ZONE,
    invitation_status VARCHAR(20) DEFAULT 'pending', -- 'pending', 'sent', 'accepted', 'declined', 'expired'
    invited_at TIMESTAMP WITH TIME ZONE,
    accepted_at TIMESTAMP WITH TIME ZONE,
    last_active_at TIMESTAMP WITH TIME ZONE,
    is_anonymous BOOLEAN DEFAULT FALSE,
    anonymous_id VARCHAR(50), -- ìµëª… í‰ê°€ ì‹œ ì‚¬ìš©
    weight DECIMAL(3,2) DEFAULT 1.00, -- í‰ê°€ì ê°€ì¤‘ì¹˜ (0.00-1.00)
    metadata JSONB, -- ì¶”ê°€ ì •ë³´ ì €ì¥
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(project_id, email)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_evaluators_project_id ON evaluators(project_id);
CREATE INDEX idx_evaluators_email ON evaluators(email);
CREATE INDEX idx_evaluators_token ON evaluators(invitation_token);
CREATE INDEX idx_evaluators_status ON evaluators(invitation_status);
```

### 2.2 í‰ê°€ ì„¸ì…˜ í…Œì´ë¸” (evaluation_sessions)
```sql
CREATE TABLE evaluation_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    evaluator_id UUID NOT NULL REFERENCES evaluators(id) ON DELETE CASCADE,
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    session_token VARCHAR(255) UNIQUE,
    started_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE,
    last_saved_at TIMESTAMP WITH TIME ZONE,
    progress_percentage INTEGER DEFAULT 0, -- 0-100
    current_step VARCHAR(100), -- í˜„ì¬ í‰ê°€ ë‹¨ê³„
    evaluation_data JSONB, -- í‰ê°€ ë°ì´í„° ì„ì‹œ ì €ì¥
    is_complete BOOLEAN DEFAULT FALSE,
    time_spent_seconds INTEGER DEFAULT 0,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_sessions_evaluator_id ON evaluation_sessions(evaluator_id);
CREATE INDEX idx_sessions_project_id ON evaluation_sessions(project_id);
CREATE INDEX idx_sessions_token ON evaluation_sessions(session_token);
```

### 2.3 í‰ê°€ ì‘ë‹µ í…Œì´ë¸” (evaluation_responses)
```sql
CREATE TABLE evaluation_responses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES evaluation_sessions(id) ON DELETE CASCADE,
    evaluator_id UUID NOT NULL REFERENCES evaluators(id) ON DELETE CASCADE,
    criteria_pair_id VARCHAR(100), -- "criteria1_id:criteria2_id"
    criteria1_id UUID NOT NULL REFERENCES criteria(id),
    criteria2_id UUID NOT NULL REFERENCES criteria(id),
    comparison_value DECIMAL(10,4) NOT NULL, -- 1/9 to 9
    inverse_value DECIMAL(10,4) NOT NULL, -- ìë™ ê³„ì‚°ëœ ì—­ìˆ˜
    confidence_level INTEGER, -- 1-5 (í‰ê°€ í™•ì‹ ë„)
    notes TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(session_id, criteria1_id, criteria2_id)
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_responses_session_id ON evaluation_responses(session_id);
CREATE INDEX idx_responses_evaluator_id ON evaluation_responses(evaluator_id);
```

### 2.4 í‰ê°€ì ì•Œë¦¼ í…Œì´ë¸” (evaluator_notifications)
```sql
CREATE TABLE evaluator_notifications (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    evaluator_id UUID NOT NULL REFERENCES evaluators(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- 'invitation', 'reminder', 'deadline', 'completion'
    subject VARCHAR(255),
    content TEXT,
    sent_at TIMESTAMP WITH TIME ZONE,
    read_at TIMESTAMP WITH TIME ZONE,
    email_sent BOOLEAN DEFAULT FALSE,
    in_app_sent BOOLEAN DEFAULT FALSE,
    metadata JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

-- ì¸ë±ìŠ¤
CREATE INDEX idx_notifications_evaluator_id ON evaluator_notifications(evaluator_id);
CREATE INDEX idx_notifications_type ON evaluator_notifications(type);
```

---

## 3. API ì—”ë“œí¬ì¸íŠ¸ ì„¤ê³„

### 3.1 í‰ê°€ì ê´€ë¦¬ API

#### POST /api/evaluators/invite
```typescript
interface InviteEvaluatorRequest {
  projectId: string;
  evaluators: Array<{
    email: string;
    name?: string;
    organization?: string;
    role?: 'expert' | 'stakeholder' | 'general';
    weight?: number;
  }>;
  emailTemplate?: {
    subject?: string;
    customMessage?: string;
  };
  sendImmediately?: boolean;
  expiresInDays?: number; // ê¸°ë³¸ê°’: 7ì¼
}

interface InviteEvaluatorResponse {
  success: boolean;
  invited: Array<{
    email: string;
    evaluatorId: string;
    invitationUrl: string;
  }>;
  failed: Array<{
    email: string;
    reason: string;
  }>;
}
```

#### GET /api/evaluators/project/:projectId
```typescript
interface GetProjectEvaluatorsResponse {
  evaluators: Array<{
    id: string;
    email: string;
    name?: string;
    organization?: string;
    role: string;
    invitationStatus: string;
    invitedAt: string;
    acceptedAt?: string;
    progress: number;
    weight: number;
  }>;
  statistics: {
    total: number;
    pending: number;
    accepted: number;
    completed: number;
    averageProgress: number;
  };
}
```

#### POST /api/evaluators/resend-invitation
```typescript
interface ResendInvitationRequest {
  evaluatorIds: string[];
  updateExpiry?: boolean;
}
```

#### DELETE /api/evaluators/:evaluatorId
```typescript
interface DeleteEvaluatorResponse {
  success: boolean;
  message: string;
  deletedResponses?: number;
}
```

### 3.2 í‰ê°€ ì„¸ì…˜ API

#### POST /api/evaluation/start
```typescript
interface StartEvaluationRequest {
  token: string; // invitation_token
}

interface StartEvaluationResponse {
  sessionId: string;
  sessionToken: string;
  evaluatorId: string;
  projectInfo: {
    id: string;
    title: string;
    description: string;
    criteriaCount: number;
    alternativeCount: number;
    expectedTime: number; // ì˜ˆìƒ ì†Œìš” ì‹œê°„ (ë¶„)
  };
  evaluationStructure: {
    criteria: CriteriaHierarchy;
    alternatives: Alternative[];
    comparisonsRequired: number;
  };
}
```

#### POST /api/evaluation/save-progress
```typescript
interface SaveProgressRequest {
  sessionToken: string;
  responses: Array<{
    criteria1Id: string;
    criteria2Id: string;
    value: number;
    confidence?: number;
  }>;
  currentStep: string;
  progressPercentage: number;
}

interface SaveProgressResponse {
  success: boolean;
  saved: number;
  nextStep?: string;
}
```

#### POST /api/evaluation/submit
```typescript
interface SubmitEvaluationRequest {
  sessionToken: string;
  finalResponses: EvaluationResponse[];
  feedbackComments?: string;
}

interface SubmitEvaluationResponse {
  success: boolean;
  completionCertificate?: string; // PDF URL
  summary: {
    totalComparisons: number;
    consistencyRatio: number;
    timeSpent: number;
  };
}
```

### 3.3 ì§„í–‰ë¥  ì¶”ì  API

#### GET /api/evaluation/progress/:sessionToken
```typescript
interface GetProgressResponse {
  sessionId: string;
  progress: number;
  currentStep: string;
  completedComparisons: number;
  totalComparisons: number;
  lastSavedAt: string;
  estimatedTimeRemaining: number; // ë¶„
}
```

#### GET /api/project/:projectId/evaluation-status
```typescript
interface ProjectEvaluationStatusResponse {
  projectId: string;
  evaluators: Array<{
    evaluatorId: string;
    email: string;
    status: 'pending' | 'in_progress' | 'completed';
    progress: number;
    lastActive?: string;
  }>;
  overallProgress: number;
  completionRate: number;
}
```

---

## 4. ì¸ì¦ í† í° ì‹œìŠ¤í…œ

### 4.1 í† í° ìƒì„± ì „ëµ

```typescript
class TokenGenerator {
  /**
   * ì´ˆëŒ€ í† í° ìƒì„±
   * Format: {prefix}_{random}_{checksum}
   * Example: inv_a4b2c8d9e3f1_7x9z
   */
  static generateInvitationToken(): string {
    const prefix = 'inv';
    const random = crypto.randomBytes(12).toString('hex');
    const checksum = this.generateChecksum(random);
    return `${prefix}_${random}_${checksum}`;
  }

  /**
   * ì„¸ì…˜ í† í° ìƒì„±
   * Format: {prefix}_{timestamp}_{random}_{signature}
   * Example: sess_1699123456_a4b2c8_9z7x
   */
  static generateSessionToken(evaluatorId: string): string {
    const prefix = 'sess';
    const timestamp = Math.floor(Date.now() / 1000);
    const random = crypto.randomBytes(6).toString('hex');
    const signature = this.generateSignature(evaluatorId, timestamp);
    return `${prefix}_${timestamp}_${random}_${signature}`;
  }

  private static generateChecksum(data: string): string {
    return crypto
      .createHash('sha256')
      .update(data + process.env.TOKEN_SECRET)
      .digest('hex')
      .substring(0, 4);
  }

  private static generateSignature(
    evaluatorId: string, 
    timestamp: number
  ): string {
    const data = `${evaluatorId}:${timestamp}`;
    return crypto
      .createHmac('sha256', process.env.TOKEN_SECRET)
      .update(data)
      .digest('hex')
      .substring(0, 4);
  }
}
```

### 4.2 í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´

```typescript
class TokenValidator {
  /**
   * ì´ˆëŒ€ í† í° ê²€ì¦
   */
  static async validateInvitationToken(token: string): Promise<{
    valid: boolean;
    evaluatorId?: string;
    projectId?: string;
    error?: string;
  }> {
    // 1. í† í° í˜•ì‹ ê²€ì¦
    const tokenPattern = /^inv_[a-f0-9]{24}_[a-f0-9]{4}$/;
    if (!tokenPattern.test(token)) {
      return { valid: false, error: 'Invalid token format' };
    }

    // 2. ì²´í¬ì„¬ ê²€ì¦
    const [prefix, random, checksum] = token.split('_');
    const expectedChecksum = this.generateChecksum(random);
    if (checksum !== expectedChecksum) {
      return { valid: false, error: 'Invalid token checksum' };
    }

    // 3. DBì—ì„œ í† í° ì¡°íšŒ
    const evaluator = await db.query(
      'SELECT * FROM evaluators WHERE invitation_token = $1',
      [token]
    );

    if (!evaluator) {
      return { valid: false, error: 'Token not found' };
    }

    // 4. ë§Œë£Œ ì‹œê°„ í™•ì¸
    if (new Date() > new Date(evaluator.token_expires_at)) {
      return { valid: false, error: 'Token expired' };
    }

    return {
      valid: true,
      evaluatorId: evaluator.id,
      projectId: evaluator.project_id
    };
  }

  /**
   * ì„¸ì…˜ í† í° ê²€ì¦
   */
  static async validateSessionToken(token: string): Promise<{
    valid: boolean;
    sessionId?: string;
    evaluatorId?: string;
    error?: string;
  }> {
    // êµ¬í˜„ ë¡œì§...
    return { valid: true };
  }
}
```

---

## 5. ì´ë©”ì¼ ë°œì†¡ ì•„í‚¤í…ì²˜

### 5.1 ì´ë©”ì¼ ì„œë¹„ìŠ¤ ì¸í„°í˜ì´ìŠ¤

```typescript
interface EmailService {
  sendInvitation(params: InvitationEmailParams): Promise<boolean>;
  sendReminder(params: ReminderEmailParams): Promise<boolean>;
  sendCompletion(params: CompletionEmailParams): Promise<boolean>;
}

interface InvitationEmailParams {
  to: string;
  evaluatorName?: string;
  projectTitle: string;
  projectDescription?: string;
  inviterName: string;
  invitationUrl: string;
  expiresAt: Date;
  customMessage?: string;
}
```

### 5.2 SendGrid êµ¬í˜„

```typescript
import sgMail from '@sendgrid/mail';

class SendGridEmailService implements EmailService {
  constructor() {
    sgMail.setApiKey(process.env.SENDGRID_API_KEY);
  }

  async sendInvitation(params: InvitationEmailParams): Promise<boolean> {
    const html = this.generateInvitationHTML(params);
    
    const msg = {
      to: params.to,
      from: {
        email: process.env.SENDER_EMAIL,
        name: 'AHP Platform'
      },
      subject: `í‰ê°€ ì´ˆëŒ€: ${params.projectTitle}`,
      html,
      trackingSettings: {
        clickTracking: { enable: true },
        openTracking: { enable: true }
      }
    };

    try {
      await sgMail.send(msg);
      
      // ë°œì†¡ ê¸°ë¡ ì €ì¥
      await this.logEmailSent({
        evaluatorEmail: params.to,
        type: 'invitation',
        sentAt: new Date()
      });
      
      return true;
    } catch (error) {
      console.error('Email send failed:', error);
      return false;
    }
  }

  private generateInvitationHTML(params: InvitationEmailParams): string {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <style>
          .container { max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; }
          .content { padding: 30px; background: #f8f9fa; }
          .button { display: inline-block; padding: 15px 30px; background: #667eea; color: white; text-decoration: none; border-radius: 5px; margin: 20px 0; }
          .footer { padding: 20px; text-align: center; color: #666; font-size: 12px; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1>AHP í‰ê°€ ì´ˆëŒ€</h1>
          </div>
          <div class="content">
            <p>ì•ˆë…•í•˜ì„¸ìš”${params.evaluatorName ? ` ${params.evaluatorName}ë‹˜` : ''},</p>
            
            <p><strong>${params.inviterName}</strong>ë‹˜ì´ ë‹¤ìŒ í”„ë¡œì íŠ¸ì˜ í‰ê°€ì— ì´ˆëŒ€í•˜ì…¨ìŠµë‹ˆë‹¤:</p>
            
            <h2>${params.projectTitle}</h2>
            ${params.projectDescription ? `<p>${params.projectDescription}</p>` : ''}
            
            ${params.customMessage ? `
              <div style="background: white; padding: 15px; border-left: 4px solid #667eea; margin: 20px 0;">
                <p><strong>ì´ˆëŒ€ ë©”ì‹œì§€:</strong></p>
                <p>${params.customMessage}</p>
              </div>
            ` : ''}
            
            <div style="text-align: center;">
              <a href="${params.invitationUrl}" class="button">í‰ê°€ ì‹œì‘í•˜ê¸°</a>
            </div>
            
            <p><small>ì´ ë§í¬ëŠ” ${params.expiresAt.toLocaleDateString('ko-KR')}ê¹Œì§€ ìœ íš¨í•©ë‹ˆë‹¤.</small></p>
          </div>
          <div class="footer">
            <p>Â© 2024 AHP Platform. All rights reserved.</p>
            <p>ì´ ì´ë©”ì¼ì€ í‰ê°€ ì´ˆëŒ€ë¥¼ ìœ„í•´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </body>
      </html>
    `;
  }
}
```

### 5.3 ì´ë©”ì¼ í ì‹œìŠ¤í…œ

```typescript
import Bull from 'bull';

class EmailQueue {
  private queue: Bull.Queue;

  constructor() {
    this.queue = new Bull('email-queue', {
      redis: {
        host: process.env.REDIS_HOST,
        port: process.env.REDIS_PORT,
        password: process.env.REDIS_PASSWORD
      }
    });

    this.setupProcessors();
  }

  /**
   * ì´ë©”ì¼ ì‘ì—… íì— ì¶”ê°€
   */
  async addEmailJob(type: string, data: any, options?: Bull.JobOptions) {
    return await this.queue.add(type, data, {
      attempts: 3,
      backoff: {
        type: 'exponential',
        delay: 2000
      },
      ...options
    });
  }

  /**
   * ëŒ€ëŸ‰ ì´ˆëŒ€ ë©”ì¼ ë°œì†¡
   */
  async bulkInvite(invitations: InvitationEmailParams[]) {
    const jobs = invitations.map((invitation, index) => ({
      name: 'send-invitation',
      data: invitation,
      opts: {
        delay: index * 1000 // 1ì´ˆ ê°„ê²©ìœ¼ë¡œ ë°œì†¡
      }
    }));

    return await this.queue.addBulk(jobs);
  }

  private setupProcessors() {
    // ì´ˆëŒ€ ë©”ì¼ í”„ë¡œì„¸ì„œ
    this.queue.process('send-invitation', async (job) => {
      const emailService = new SendGridEmailService();
      return await emailService.sendInvitation(job.data);
    });

    // ë¦¬ë§ˆì¸ë” ë©”ì¼ í”„ë¡œì„¸ì„œ
    this.queue.process('send-reminder', async (job) => {
      const emailService = new SendGridEmailService();
      return await emailService.sendReminder(job.data);
    });

    // ì™„ë£Œ ë©”ì¼ í”„ë¡œì„¸ì„œ
    this.queue.process('send-completion', async (job) => {
      const emailService = new SendGridEmailService();
      return await emailService.sendCompletion(job.data);
    });
  }
}
```

---

## 6. ì‹¤ì‹œê°„ ì§„í–‰ë¥  ì¶”ì  ì‹œìŠ¤í…œ

### 6.1 WebSocket ì—°ê²° ê´€ë¦¬

```typescript
import { Server } from 'socket.io';

class ProgressTracker {
  private io: Server;
  private sessions: Map<string, SessionData> = new Map();

  constructor(server: any) {
    this.io = new Server(server, {
      cors: {
        origin: process.env.FRONTEND_URL,
        credentials: true
      }
    });

    this.setupHandlers();
  }

  private setupHandlers() {
    this.io.on('connection', (socket) => {
      console.log('Client connected:', socket.id);

      // í‰ê°€ì ì¸ì¦
      socket.on('authenticate', async (data) => {
        const { sessionToken } = data;
        const validation = await TokenValidator.validateSessionToken(sessionToken);
        
        if (validation.valid) {
          socket.join(`session:${validation.sessionId}`);
          socket.join(`evaluator:${validation.evaluatorId}`);
          
          socket.emit('authenticated', {
            sessionId: validation.sessionId,
            evaluatorId: validation.evaluatorId
          });
        } else {
          socket.emit('authentication_failed', { error: validation.error });
        }
      });

      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
      socket.on('progress_update', async (data) => {
        const { sessionId, progress, currentStep } = data;
        
        // DB ì—…ë°ì´íŠ¸
        await this.updateProgress(sessionId, progress, currentStep);
        
        // ê´€ë¦¬ìì—ê²Œ ì‹¤ì‹œê°„ ì•Œë¦¼
        this.io.to(`project:admin:${data.projectId}`).emit('evaluator_progress', {
          sessionId,
          evaluatorId: data.evaluatorId,
          progress,
          currentStep
        });
      });

      // í‰ê°€ ì™„ë£Œ
      socket.on('evaluation_complete', async (data) => {
        const { sessionId, evaluatorId, projectId } = data;
        
        // ì™„ë£Œ ì²˜ë¦¬
        await this.completeEvaluation(sessionId);
        
        // ëª¨ë“  ê´€ë ¨ìì—ê²Œ ì•Œë¦¼
        this.io.to(`project:${projectId}`).emit('evaluator_completed', {
          evaluatorId,
          completedAt: new Date()
        });
      });

      socket.on('disconnect', () => {
        console.log('Client disconnected:', socket.id);
      });
    });
  }

  async updateProgress(
    sessionId: string, 
    progress: number, 
    currentStep: string
  ): Promise<void> {
    await db.query(
      `UPDATE evaluation_sessions 
       SET progress_percentage = $1, 
           current_step = $2,
           last_saved_at = CURRENT_TIMESTAMP
       WHERE id = $3`,
      [progress, currentStep, sessionId]
    );
  }

  async completeEvaluation(sessionId: string): Promise<void> {
    await db.query(
      `UPDATE evaluation_sessions 
       SET is_complete = true,
           completed_at = CURRENT_TIMESTAMP,
           progress_percentage = 100
       WHERE id = $1`,
      [sessionId]
    );
  }
}
```

---

## 7. ìµëª… í‰ê°€ ì‹œìŠ¤í…œ

### 7.1 ìµëª… ID ìƒì„±

```typescript
class AnonymousEvaluator {
  /**
   * ìµëª… ID ìƒì„±
   * Format: ANON_{PROJECT_PREFIX}_{RANDOM}
   * Example: ANON_PRJ001_X7K9
   */
  static generateAnonymousId(projectId: string): string {
    const projectPrefix = projectId.substring(0, 6).toUpperCase();
    const random = crypto.randomBytes(2).toString('hex').toUpperCase();
    return `ANON_${projectPrefix}_${random}`;
  }

  /**
   * ìµëª… í‰ê°€ì ìƒì„±
   */
  static async createAnonymousEvaluator(
    projectId: string,
    email?: string
  ): Promise<Evaluator> {
    const anonymousId = this.generateAnonymousId(projectId);
    
    const evaluator = await db.query(
      `INSERT INTO evaluators (
        project_id,
        email,
        anonymous_id,
        is_anonymous,
        invitation_status,
        invitation_token,
        token_expires_at
      ) VALUES ($1, $2, $3, true, 'accepted', $4, $5)
      RETURNING *`,
      [
        projectId,
        email || `${anonymousId}@anonymous.local`,
        anonymousId,
        TokenGenerator.generateInvitationToken(),
        new Date(Date.now() + 30 * 24 * 60 * 60 * 1000) // 30ì¼
      ]
    );

    return evaluator;
  }

  /**
   * ìµëª… í‰ê°€ ê²°ê³¼ ì²˜ë¦¬
   */
  static async processAnonymousResults(
    sessionId: string
  ): Promise<void> {
    // í‰ê°€ ê²°ê³¼ì—ì„œ ê°œì¸ ì‹ë³„ ì •ë³´ ì œê±°
    await db.query(
      `UPDATE evaluation_responses 
       SET notes = NULL 
       WHERE session_id = $1`,
      [sessionId]
    );

    // ì„¸ì…˜ ì •ë³´ì—ì„œ IP, User-Agent ì œê±°
    await db.query(
      `UPDATE evaluation_sessions 
       SET ip_address = NULL, 
           user_agent = NULL 
       WHERE id = $1`,
      [sessionId]
    );
  }
}
```

---

## 8. ê·¸ë£¹ í‰ê°€ í†µí•©

### 8.1 ê°€ì¤‘ì¹˜ í†µí•© ì „ëµ

```typescript
class GroupEvaluationAggregator {
  /**
   * í‰ê°€ìë³„ ê°€ì¤‘ì¹˜ë¥¼ ê³ ë ¤í•œ í†µí•©
   */
  static aggregateWeightedEvaluations(
    evaluations: EvaluationData[]
  ): AggregatedResult {
    // 1. í‰ê°€ìë³„ ê°€ì¤‘ì¹˜ ì •ê·œí™”
    const totalWeight = evaluations.reduce((sum, e) => sum + e.weight, 0);
    const normalizedEvaluations = evaluations.map(e => ({
      ...e,
      normalizedWeight: e.weight / totalWeight
    }));

    // 2. ê°€ì¤‘ ê¸°í•˜í‰ê·  ê³„ì‚°
    const aggregatedMatrix = this.calculateWeightedGeometricMean(
      normalizedEvaluations
    );

    // 3. ì¼ê´€ì„± ê²€ì¦
    const consistencyRatio = this.calculateGroupConsistency(
      aggregatedMatrix
    );

    // 4. ìµœì¢… ìš°ì„ ìˆœìœ„ ë„ì¶œ
    const priorities = this.calculatePriorities(aggregatedMatrix);

    return {
      aggregatedMatrix,
      priorities,
      consistencyRatio,
      participantCount: evaluations.length,
      totalWeight
    };
  }

  /**
   * ê°€ì¤‘ ê¸°í•˜í‰ê·  ê³„ì‚°
   */
  private static calculateWeightedGeometricMean(
    evaluations: NormalizedEvaluation[]
  ): number[][] {
    const n = evaluations[0].matrix.length;
    const result = Array(n).fill(null).map(() => Array(n).fill(1));

    for (let i = 0; i < n; i++) {
      for (let j = 0; j < n; j++) {
        let product = 1;
        
        evaluations.forEach(evaluation => {
          product *= Math.pow(
            evaluation.matrix[i][j],
            evaluation.normalizedWeight
          );
        });
        
        result[i][j] = product;
      }
    }

    return result;
  }
}
```

---

## 9. ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 9.1 ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸
- âœ… í† í° ì•”í˜¸í™” ë° ì„œëª…
- âœ… HTTPS ì „ìš© í†µì‹ 
- âœ… SQL Injection ë°©ì§€ (Prepared Statements)
- âœ… XSS ë°©ì§€ (ì…ë ¥ê°’ ê²€ì¦)
- âœ… CSRF í† í° ì‚¬ìš©
- âœ… Rate Limiting
- âœ… ì„¸ì…˜ íƒ€ì„ì•„ì›ƒ
- âœ… ë¯¼ê° ì •ë³´ ì•”í˜¸í™” ì €ì¥

### 9.2 ê°œì¸ì •ë³´ ë³´í˜¸
- ìµëª… í‰ê°€ ì‹œ ê°œì¸ì •ë³´ ì™„ì „ ë¶„ë¦¬
- GDPR ì¤€ìˆ˜
- ë°ì´í„° ë³´ê´€ ê¸°ê°„ ì„¤ì •
- í‰ê°€ì ë™ì˜ íšë“

---

## 10. êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1 (í•„ìˆ˜ - 1ì£¼ì°¨)
1. DB ìŠ¤í‚¤ë§ˆ ìƒì„±
2. ê¸°ë³¸ í‰ê°€ì CRUD API
3. ì´ˆëŒ€ í† í° ì‹œìŠ¤í…œ
4. ì´ë©”ì¼ ë°œì†¡ (ê¸°ë³¸)

### Phase 2 (í•µì‹¬ - 2ì£¼ì°¨)
1. í‰ê°€ ì„¸ì…˜ ê´€ë¦¬
2. ì§„í–‰ë¥  ì¶”ì 
3. WebSocket ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
4. ê·¸ë£¹ í‰ê°€ í†µí•©

### Phase 3 (ê³ ê¸‰ - 3ì£¼ì°¨)
1. ìµëª… í‰ê°€
2. ì´ë©”ì¼ í ì‹œìŠ¤í…œ
3. ê³ ê¸‰ ë³´ì•ˆ ê¸°ëŠ¥
4. ë¶„ì„ ë° ë¦¬í¬íŠ¸

---

## 11. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 11.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
```typescript
describe('TokenGenerator', () => {
  it('should generate valid invitation token', () => {
    const token = TokenGenerator.generateInvitationToken();
    expect(token).toMatch(/^inv_[a-f0-9]{24}_[a-f0-9]{4}$/);
  });

  it('should generate unique tokens', () => {
    const tokens = new Set();
    for (let i = 0; i < 1000; i++) {
      tokens.add(TokenGenerator.generateInvitationToken());
    }
    expect(tokens.size).toBe(1000);
  });
});
```

### 11.2 í†µí•© í…ŒìŠ¤íŠ¸
```typescript
describe('Evaluator Invitation Flow', () => {
  it('should complete full invitation flow', async () => {
    // 1. í‰ê°€ì ì´ˆëŒ€
    const inviteResponse = await api.post('/api/evaluators/invite', {
      projectId: 'test-project',
      evaluators: [{ email: 'test@example.com' }]
    });
    
    expect(inviteResponse.success).toBe(true);
    const { invitationUrl } = inviteResponse.invited[0];

    // 2. ì´ˆëŒ€ ìˆ˜ë½
    const token = extractTokenFromUrl(invitationUrl);
    const startResponse = await api.post('/api/evaluation/start', {
      token
    });
    
    expect(startResponse.sessionId).toBeDefined();

    // 3. í‰ê°€ ìˆ˜í–‰
    // ... í‰ê°€ ë¡œì§ í…ŒìŠ¤íŠ¸

    // 4. ì™„ë£Œ í™•ì¸
    const statusResponse = await api.get(
      `/api/evaluation/progress/${startResponse.sessionToken}`
    );
    
    expect(statusResponse.progress).toBe(100);
  });
});
```

---

**ì‘ì„± ì™„ë£Œ**: 2024-11-12 01:00 KST
**ë‹¤ìŒ ë‹¨ê³„**: AHP ê³„ì‚° ì—”ì§„ ì„¤ê³„ ë¬¸ì„œ ì‘ì„±