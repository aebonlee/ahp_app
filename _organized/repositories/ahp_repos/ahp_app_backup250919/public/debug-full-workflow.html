<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Full Workflow Debug - AHP Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container {
            max-width: 1200px; margin: 0 auto;
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; padding: 2rem; text-align: center;
        }
        .content { padding: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .section {
            background: #f8f9fa; padding: 1.5rem; border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        .section h3 {
            color: #333; margin-bottom: 1rem;
            display: flex; align-items: center; gap: 0.5rem;
        }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        input, textarea, select {
            width: 100%; padding: 0.8rem; border: 2px solid #ddd;
            border-radius: 6px; font-size: 0.9rem;
        }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
        button {
            flex: 1; padding: 0.8rem; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn-warning { background: #ed8936; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-info { background: #4299e1; color: white; }
        button:hover { transform: translateY(-2px); }
        .console {
            background: #1a202c; color: #68d391; padding: 1rem;
            border-radius: 8px; font-family: 'Courier New', monospace;
            max-height: 400px; overflow-y: auto; font-size: 0.85rem;
            grid-column: 1 / -1; margin-top: 1rem;
        }
        .console-line { margin-bottom: 3px; white-space: pre-wrap; }
        .success { color: #68d391; }
        .error { color: #fc8181; }
        .info { color: #63b3ed; }
        .warning { color: #f6e05e; }
        .status { 
            display: inline-block; width: 10px; height: 10px; 
            border-radius: 50%; margin-right: 8px;
        }
        .status-success { background: #48bb78; }
        .status-error { background: #f56565; }
        .status-pending { background: #ed8936; }
        .response-box {
            background: #2d3748; color: #e2e8f0; padding: 1rem;
            border-radius: 6px; margin-top: 1rem; font-family: monospace;
            max-height: 200px; overflow-y: auto; font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ í”„ë¡ íŠ¸ì—”ë“œ â†’ Django â†’ PostgreSQL ì™„ì „ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</h1>
            <p>ì‹¤ì‹œê°„ ë””ë²„ê¹… ë° ë°ì´í„° íë¦„ ì¶”ì </p>
        </div>
        
        <div class="content">
            <!-- í”„ë¡œì íŠ¸ ìƒì„± í¼ -->
            <div class="section">
                <h3>ğŸ“ í”„ë¡œì íŠ¸ ìƒì„± í¼</h3>
                <div class="form-group">
                    <label>í”„ë¡œì íŠ¸ ì œëª© *</label>
                    <input type="text" id="projectTitle" value="Debug Test Project" placeholder="í”„ë¡œì íŠ¸ ì œëª©">
                </div>
                <div class="form-group">
                    <label>ëª©í‘œ *</label>
                    <input type="text" id="projectObjective" value="Complete workflow test" placeholder="í”„ë¡œì íŠ¸ ëª©í‘œ">
                </div>
                <div class="form-group">
                    <label>ì„¤ëª…</label>
                    <textarea id="projectDescription" rows="3" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…">Full workflow debugging and testing</textarea>
                </div>
                <div class="form-group">
                    <label>ê³µê°œ ë²”ìœ„</label>
                    <select id="projectVisibility">
                        <option value="private">ë¹„ê³µê°œ</option>
                        <option value="team">íŒ€ ê³µê°œ</option>
                        <option value="public">ì „ì²´ ê³µê°œ</option>
                    </select>
                </div>
            </div>
            
            <!-- ì—°ê²° ìƒíƒœ ë° ì œì–´ -->
            <div class="section">
                <h3>ğŸ”§ ì‹œìŠ¤í…œ ìƒíƒœ ë° ì œì–´</h3>
                <div style="margin-bottom: 1rem;">
                    <div><span class="status status-pending" id="apiStatus"></span>API ì„œë²„: <span id="apiStatusText">í™•ì¸ ì¤‘...</span></div>
                    <div><span class="status status-pending" id="dbStatus"></span>ë°ì´í„°ë² ì´ìŠ¤: <span id="dbStatusText">í™•ì¸ ì¤‘...</span></div>
                    <div><span class="status status-pending" id="authStatus"></span>ì¸ì¦: <span id="authStatusText">í™•ì¸ ì¤‘...</span></div>
                </div>
                
                <div class="btn-group" style="flex-direction: column;">
                    <button class="btn-info" onclick="checkSystemStatus()">1. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</button>
                    <button class="btn-warning" onclick="loadApiService()">2. API ì„œë¹„ìŠ¤ ë¡œë“œ</button>
                    <button class="btn-primary" onclick="testProjectCreation()">3. í”„ë¡œì íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸</button>
                    <button class="btn-success" onclick="verifyDatabaseSave()">4. DB ì €ì¥ ê²€ì¦</button>
                    <button class="btn-danger" onclick="clearConsole()">ì½˜ì†” ì§€ìš°ê¸°</button>
                </div>
            </div>
            
            <!-- ì‹¤ì‹œê°„ ì‘ë‹µ ëª¨ë‹ˆí„° -->
            <div class="section">
                <h3>ğŸ“¡ API ì‘ë‹µ ëª¨ë‹ˆí„°</h3>
                <div><strong>ë§ˆì§€ë§‰ ìš”ì²­:</strong> <span id="lastRequest">ì—†ìŒ</span></div>
                <div><strong>ì‘ë‹µ ìƒíƒœ:</strong> <span id="responseStatus">-</span></div>
                <div><strong>ì‘ë‹µ ì‹œê°„:</strong> <span id="responseTime">-</span></div>
                <div class="response-box" id="responseBox">
                    API ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                </div>
            </div>
            
            <!-- ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ -->
            <div class="section">
                <h3>ğŸ—„ï¸ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤</h3>
                <div><strong>ì´ í”„ë¡œì íŠ¸:</strong> <span id="projectCount">-</span></div>
                <div><strong>ë§ˆì§€ë§‰ ìƒì„±:</strong> <span id="lastCreated">-</span></div>
                <div><strong>ë°ì´í„° ìƒíƒœ:</strong> <span id="dataStatus">í™•ì¸ ì¤‘...</span></div>
                <div style="margin-top: 1rem;">
                    <button class="btn-info" onclick="refreshProjectList()" style="width: 100%;">í”„ë¡œì íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
                </div>
                <div class="response-box" id="projectListBox" style="height: 150px;">
                    í”„ë¡œì íŠ¸ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
                </div>
            </div>
        </div>
        
        <!-- ì‹¤ì‹œê°„ ì½˜ì†” -->
        <div class="console" id="console">
            <div class="console-line info">[${new Date().toLocaleString()}] ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° ë””ë²„ê±° ì´ˆê¸°í™” ì™„ë£Œ</div>
            <div class="console-line info">[${new Date().toLocaleString()}] ğŸ“Š Frontend â†’ Django â†’ PostgreSQL ë°ì´í„° íë¦„ ì¶”ì  ì‹œì‘</div>
            <div class="console-line">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
        </div>
    </div>
    
    <script src="./scripts/api-service.js"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let apiService = null;
        let lastRequestTime = 0;
        
        // ì½˜ì†” ë¡œê·¸ í•¨ìˆ˜
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatus(element, status, text) {
            const statusEl = document.getElementById(element);
            const textEl = document.getElementById(element.replace('Status', 'StatusText'));
            statusEl.className = `status status-${status}`;
            if (textEl) textEl.textContent = text;
        }
        
        // ì‘ë‹µ ëª¨ë‹ˆí„° ì—…ë°ì´íŠ¸
        function updateResponseMonitor(request, status, time, data) {
            document.getElementById('lastRequest').textContent = request;
            document.getElementById('responseStatus').textContent = status;
            document.getElementById('responseTime').textContent = time + 'ms';
            document.getElementById('responseBox').textContent = JSON.stringify(data, null, 2);
        }
        
        // 1. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
        async function checkSystemStatus() {
            log('ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ ì¢…í•© í™•ì¸ ì‹œì‘...', 'info');
            
            // API ì„œë²„ í™•ì¸
            try {
                const startTime = Date.now();
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/projects/', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                const endTime = Date.now();
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('api', 'success', 'ì˜¨ë¼ì¸');
                    log(`âœ… API ì„œë²„ ì—°ê²° ì„±ê³µ (${endTime - startTime}ms)`, 'success');
                    updateResponseMonitor('GET /api/service/projects/', response.status, endTime - startTime, data);
                } else {
                    updateStatus('api', 'error', 'ì˜¤ë¥˜');
                    log(`âŒ API ì„œë²„ ì˜¤ë¥˜: ${response.status}`, 'error');
                }
            } catch (error) {
                updateStatus('api', 'error', 'ì—°ê²° ì‹¤íŒ¨');
                log(`âŒ API ì„œë²„ ì—°ê²° ì‹¤íŒ¨: ${error.message}`, 'error');
            }
            
            // ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
            try {
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/health/', {
                    method: 'GET'
                });
                if (response.ok) {
                    updateStatus('db', 'success', 'ì—°ê²°ë¨');
                    log('âœ… PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸', 'success');
                } else {
                    updateStatus('db', 'error', 'ì—°ê²° ì˜¤ë¥˜');
                    log('âŒ ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨', 'error');
                }
            } catch (error) {
                updateStatus('db', 'error', 'í™•ì¸ ë¶ˆê°€');
                log(`âš ï¸ DB ìƒíƒœ í™•ì¸ ë¶ˆê°€: ${error.message}`, 'warning');
            }
            
            log('ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì™„ë£Œ', 'info');
        }
        
        // 2. API ì„œë¹„ìŠ¤ ë¡œë“œ
        async function loadApiService() {
            log('ğŸ“¡ AHP API ì„œë¹„ìŠ¤ ë¡œë“œ ì¤‘...', 'info');
            
            try {
                if (typeof AHPApiService !== 'undefined') {
                    apiService = new AHPApiService();
                    window.ahpApi = apiService;
                    log('âœ… API ì„œë¹„ìŠ¤ ë¡œë“œ ì„±ê³µ', 'success');
                    updateStatus('auth', 'success', 'ì¤€ë¹„ë¨');
                    
                    // ì¸ì¦ ìƒíƒœ í™•ì¸
                    try {
                        const userResult = await apiService.getCurrentUser();
                        if (userResult.success) {
                            log(`âœ… ì¸ì¦ëœ ì‚¬ìš©ì: ${userResult.user.name}`, 'success');
                            updateStatus('auth', 'success', 'ì¸ì¦ë¨');
                        } else {
                            log('â„¹ï¸ ìµëª… ì‚¬ìš©ìë¡œ ì§„í–‰', 'info');
                            updateStatus('auth', 'pending', 'ìµëª…');
                        }
                    } catch (authError) {
                        log('â„¹ï¸ ì¸ì¦ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨, ìµëª…ìœ¼ë¡œ ì§„í–‰', 'info');
                        updateStatus('auth', 'pending', 'ìµëª…');
                    }
                } else {
                    throw new Error('AHPApiService í´ë˜ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
            } catch (error) {
                log(`âŒ API ì„œë¹„ìŠ¤ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus('auth', 'error', 'ì‹¤íŒ¨');
            }
        }
        
        // 3. í”„ë¡œì íŠ¸ ìƒì„± í…ŒìŠ¤íŠ¸
        async function testProjectCreation() {
            if (!apiService) {
                log('âš ï¸ API ì„œë¹„ìŠ¤ë¥¼ ë¨¼ì € ë¡œë“œí•´ì£¼ì„¸ìš”', 'warning');
                return;
            }
            
            const projectData = {
                title: document.getElementById('projectTitle').value + ' - ' + new Date().toLocaleTimeString(),
                objective: document.getElementById('projectObjective').value,
                description: document.getElementById('projectDescription').value,
                visibility: document.getElementById('projectVisibility').value,
                settings: {
                    evaluation_method: 'pairwise',
                    status: 'draft'
                }
            };
            
            log('ğŸš€ í”„ë¡œì íŠ¸ ìƒì„± ìš”ì²­ ì „ì†¡...', 'info');
            log(`ğŸ“¤ ìš”ì²­ ë°ì´í„°: ${JSON.stringify(projectData, null, 2)}`, 'info');
            
            try {
                const startTime = Date.now();
                const result = await apiService.createProject(projectData);
                const endTime = Date.now();
                
                updateResponseMonitor('POST /api/service/projects/', 
                    result.success ? 'SUCCESS' : 'FAILED', 
                    endTime - startTime, 
                    result
                );
                
                if (result.success) {
                    log('âœ… í”„ë¡œì íŠ¸ ìƒì„± ì„±ê³µ!', 'success');
                    log(`ğŸ“‹ í”„ë¡œì íŠ¸ ID: ${result.data?.id || 'N/A'}`, 'success');
                    log(`ğŸ“Š ì œëª©: ${result.data?.title || projectData.title}`, 'success');
                    log('ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê²€ì¦ì„ ì§„í–‰í•˜ì„¸ìš”', 'info');
                    
                    // ìë™ìœ¼ë¡œ DB ê²€ì¦ ì‹¤í–‰
                    setTimeout(verifyDatabaseSave, 1000);
                } else {
                    log(`âŒ í”„ë¡œì íŠ¸ ìƒì„± ì‹¤íŒ¨: ${result.message}`, 'error');
                    log(`ğŸ’­ ì˜¤ë¥˜ ìƒì„¸: ${result.error || 'ì•Œ ìˆ˜ ì—†ìŒ'}`, 'error');
                }
            } catch (error) {
                log(`âŒ í”„ë¡œì íŠ¸ ìƒì„± ì˜ˆì™¸: ${error.message}`, 'error');
                updateResponseMonitor('POST /api/service/projects/', 'EXCEPTION', 0, { error: error.message });
            }
        }
        
        // 4. ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê²€ì¦
        async function verifyDatabaseSave() {
            log('ğŸ” PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ê²€ì¦ ì¤‘...', 'info');
            
            try {
                const response = await fetch('https://ahp-django-backend.onrender.com/api/service/projects/');
                if (response.ok) {
                    const data = await response.json();
                    const projectCount = data.results ? data.results.length : data.length || 0;
                    
                    document.getElementById('projectCount').textContent = projectCount;
                    document.getElementById('dataStatus').textContent = 'ì €ì¥ í™•ì¸ë¨';
                    document.getElementById('projectListBox').textContent = JSON.stringify(data, null, 2);
                    
                    if (projectCount > 0) {
                        const latest = data.results ? data.results[0] : data[0];
                        document.getElementById('lastCreated').textContent = latest?.title || 'N/A';
                        log(`âœ… ë°ì´í„°ë² ì´ìŠ¤ì— ${projectCount}ê°œ í”„ë¡œì íŠ¸ ì €ì¥ í™•ì¸`, 'success');
                        log(`ğŸ“‹ ìµœì‹  í”„ë¡œì íŠ¸: ${latest?.title || 'N/A'}`, 'success');
                    } else {
                        log('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤', 'warning');
                    }
                } else {
                    log(`âŒ ë°ì´í„°ë² ì´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ë°ì´í„°ë² ì´ìŠ¤ ê²€ì¦ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // í”„ë¡œì íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        async function refreshProjectList() {
            await verifyDatabaseSave();
        }
        
        // ì½˜ì†” ì§€ìš°ê¸°
        function clearConsole() {
            const console = document.getElementById('console');
            console.innerHTML = `
                <div class="console-line info">[${new Date().toLocaleTimeString()}] ğŸ§¹ ì½˜ì†” ì´ˆê¸°í™”ë¨</div>
                <div class="console-line">â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•</div>
            `;
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
        window.addEventListener('load', () => {
            log('ğŸ’¡ íŒ: ë²„íŠ¼ì„ ìˆœì„œëŒ€ë¡œ í´ë¦­í•˜ì—¬ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•˜ì„¸ìš”', 'info');
            log('ğŸ“‹ ë‹¨ê³„: 1) ì‹œìŠ¤í…œ ìƒíƒœ â†’ 2) API ë¡œë“œ â†’ 3) í”„ë¡œì íŠ¸ ìƒì„± â†’ 4) DB ê²€ì¦', 'info');
            
            // 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            setTimeout(checkSystemStatus, 2000);
        });
    </script>
</body>
</html>