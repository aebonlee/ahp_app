# AHP App 개발일지 — 2026-02-19

## 세션 개요
- **작업 시간**: 세션 지속 (전일 컨텍스트 이어서 진행)
- **담당 모델**: Claude Sonnet 4.6
- **작업 범위**: 백엔드 CI 실패 디버깅 및 수정, 배포 검증, ESLint 수정, alert() 전면 제거 (55개 파일)

---

## 세션 시작 시점 상태 (컨텍스트 재개)

전일(2026-02-18) 세션에서 다음 작업까지 완료:
- 프론트엔드 12개 커밋 (alert 제거, URL 수정, 이모지 로그 제거 등)
- 백엔드 exports/workshops 앱 신규 구현 (GitHub API 직접 커밋)
- `simple_urls.py` 업데이트: exports, workshops 등록

**세션 재개 시 오류 상황:**
- 백엔드 CI 실패 (#32, #33 모두 failure)
- Render.com 배포도 실패
- 사용자 보고: "2개도 에러야", "render.com에서도 에러야"

---

## 완료된 작업

### 1. 백엔드 CI 실패 원인 분석 및 수정

#### 근본 원인 파악
백엔드 CI 실패 원인 2가지:

**원인 1**: `apps.exports`와 `apps.workshops`가 `INSTALLED_APPS`에 미등록
- `simple_urls.py`에 URL 포함 추가 → Django startup `manage.py check` 실패
- `python manage.py check --deploy` 에서 앱 임포트 오류 발생

**원인 2**: 두 앱 모두 `migrations/` 디렉터리 미존재
- 모델이 있는 앱은 반드시 `migrations/__init__.py` + `0001_initial.py` 필요

#### 수정 내역

**파일 1: `ahp_backend/settings.py`** (commit `9a6710f3`)
```python
LOCAL_APPS = [
    'apps.accounts',
    'apps.projects',
    'apps.evaluations',
    'apps.analysis',
    'apps.subscriptions',
    'apps.exports',      # 신규 추가
    'apps.workshops',    # 신규 추가
]
```

**파일 2-5: migrations 디렉터리 생성** (commit `75473c26` ~ `569f1556`)
- `apps/exports/migrations/__init__.py`
- `apps/exports/migrations/0001_initial.py` — ExportTemplate, ExportHistory, ReportSchedule 테이블
- `apps/workshops/migrations/__init__.py`
- `apps/workshops/migrations/0001_initial.py` — WorkshopSession, WorkshopParticipant, RealTimeProgress, GroupConsensusResult, SurveyTemplate, SurveyResponse 테이블

#### 의존성 설정
```python
# exports/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]

# workshops/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]
```

### 2. 백엔드 CI 검증

수정 후 백엔드 CI 결과:

| Run # | Status | Commit |
|-------|--------|--------|
| #34 | ✅ success | 9a6710f3 (settings.py INSTALLED_APPS 수정) |
| #35 | ✅ success | 75473c26 (migrations __init__ 생성) |
| #36 | ✅ success | 0d7bbf41 (migrations __init__ 생성) |
| #37 | ✅ success | 6abdf6c4 (0001_initial.py 생성) |
| #38 | ✅ success | 569f1556 (0001_initial.py 생성) |

**모든 CI 통과 완료 ✅**

### 3. 프론트엔드 GitHub Pages 배포 상태 점검

| 워크플로우 | 최신 Run | 결과 | 비고 |
|----------|---------|------|------|
| CI Pipeline | #81 | ✅ success | 빌드 정상 |
| Deploy to GitHub Pages | #87 | ❌ failure | "Setup Pages" 단계 실패 |
| pages build and deployment | #88 | ❌ failure | #87 실패로 인한 연쇄 실패 |

**분석**:
- 빌드 자체는 성공 (`Build Application` job 통과)
- `Deploy` job의 `Setup Pages` 단계에서 실패
- 이전 커밋(08e5e38)에서는 배포 성공했으나 dev log 커밋(f4135c2) 이후 실패
- 코드 문제가 아닌 GitHub Pages 인프라 일시적 문제로 판단
- 로컬 빌드 테스트: `npm run build` 정상 완료 ✅

### 4. connectionTest.ts ESLint 수정

**오류**: `no-whitespace-before-property` (빌드 경고)
```typescript
// 수정 전 (경고 발생)
console.log('=' .repeat(50));  // line 291, 308

// 수정 후
console.log('='.repeat(50));
```

**파일**: `src/utils/connectionTest.ts` (lines 291, 308)

---

## 완료된 작업 (세션 2부)

### 5. alert() 전면 제거 — 55개 파일

전일 세션에서 28개 파일 완료 후, 56개 파일이 추가로 남아있는 것을 확인.
총 **55개 컴포넌트** 파일에서 `alert()` 호출 완전 제거.

#### 처리 전략

| 구분 | 처리 방법 |
|------|----------|
| 프로덕션 UI 컴포넌트 | `actionMessage` 상태 + `showActionMessage()` 헬퍼 + 토스트 배너 JSX |
| 데모/테스트 파일 | `console.log()` 또는 `console.warn()` 대체 |
| 주석 처리된 alert | 변경 없음 |
| XSS 테스트 문자열 (`security.test.ts`) | 변경 없음 (함수 호출 아님) |

#### 토스트 배너 패턴
```tsx
const [actionMessage, setActionMessage] = useState<{type:'success'|'error'|'info', text:string}|null>(null);

const showActionMessage = (type: 'success'|'error'|'info', text: string) => {
  setActionMessage({type, text});
  setTimeout(() => setActionMessage(null), 3000);
};

// JSX (return div의 첫 번째 자식):
{actionMessage && (
  <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-sm font-medium shadow-lg ${
    actionMessage.type === 'success' ? 'bg-green-100 text-green-800' :
    actionMessage.type === 'info' ? 'bg-blue-100 text-blue-800' :
    'bg-red-100 text-red-800'
  }`}>
    {actionMessage.text}
  </div>
)}
```

#### 처리된 파일 목록 (55개)

**admin 폴더 (17개)**
- AlternativeManagement.tsx, CriteriaManagement.tsx, EnhancedEvaluatorManagement.tsx
- EvaluatorAssignment.tsx, EvaluatorManagement.tsx, GroupWeightAnalysis.tsx
- ModelBuilderWorkflow.tsx, ModelConfiguration.tsx, MyProjects.tsx
- PersonalServiceDashboard.tsx, ProjectCompletion.tsx, SensitivityAnalysis.tsx
- SurveyLinkManager.tsx, TrashBin.tsx, TrashBinTest.tsx
- UsageManagement.tsx, UserManagement.tsx
- `ai-management/AISettingsManager.tsx`

**AI/분석 폴더 (6개)**
- `ai-interpretation/AIResultsInterpretationPage.tsx`
- `ai-materials/AIMaterialsGenerationPage.tsx`
- `ai-paper/AIPaperGenerationPage.tsx`
- `ai-quality/AIQualityValidationPage.tsx`
- `analysis/ResultsAnalysis.tsx`
- `analysis/advanced/ComprehensiveReport.tsx`

**평가/기준 폴더 (7개)**
- `comparison/PairwiseComparison.tsx`
- `criteria/BulkCriteriaInput.tsx`
- `criteria/InteractiveCriteriaEditor.tsx`
- `evaluation/DirectInputEvaluation.tsx`, `EvaluationTest.tsx`, `MultiModeEvaluation.tsx`
- `evaluation/assignment/InvitationHistory.tsx`, `InviteEvaluators.tsx`

**superadmin 폴더 (4개)**
- AllProjectsManagement.tsx, RoleSwitcher.tsx, SystemReset.tsx, SystemSettings.tsx

**기타 (21개)**
- `auth/SecureLoginForm.tsx`
- `common/ServerWarningBadge.tsx`, `TrashOverflowModal.tsx`
- `decision/DecisionSupportSystem.tsx`
- `demo/ComponentShowcase.tsx`, `EventSequenceDemo.tsx`
- `evaluator/ProjectSelection.tsx`
- `modeling/ModelBuilder.tsx`
- `notifications/EmailNotificationSystem.tsx`
- `paper/PaperManagement.tsx`
- `project/EnhancedProjectCreationWizard.tsx`
- `settings/AIConfiguration.tsx`, `PersonalSettings.tsx`
- `subscription/SubscriptionDashboard.tsx`
- `survey/EvaluatorSurveyPage.tsx`, `SurveyFormBuilder.tsx`, `SurveyManagementSystem.tsx`
- `workshop/ParticipantManager.tsx`
- `App.tsx`

#### 최종 검증
```
Grep alert() 결과:
- CriteriaManagement.tsx:527 → 주석 처리된 줄 (// alert(...))
- security.test.ts → XSS 테스트 문자열 (함수 호출 아님)
✅ 실제 alert() 함수 호출 0개 남음
```

#### 로컬 빌드 결과
```
✅ Compiled with warnings (errors 없음)
번들: 581.61 kB gzip
```

---

## 커밋 내역

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | 내용 |
|-----------|------|
| `9a6710f3` | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | feat: add initial migrations for exports and workshops apps |
| `569f1556` | feat: add initial migrations for exports and workshops apps |

---

## 완료된 작업 (세션 3부)

### 6. projects 엔드포인트 인증 강화

**파일**: `apps/projects/views.py` (커밋 `a47c40c`)

#### 수정 내역

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| `ProjectViewSet.authentication_classes` | `[]` (비어있음) | 제거 (DRF 기본값 사용) |
| `ProjectViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `ProjectViewSet.get_permissions()` | 항상 `AllowAny()` 반환 | **제거** |
| `ProjectViewSet.get_queryset()` 익명 분기 | 모든 프로젝트 반환 (보안 결함) | **제거** |
| `CriteriaViewSet.authentication_classes` | `[]` (비어있음) | 제거 |
| `CriteriaViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `CriteriaViewSet.get_queryset()` | 모든 criteria 반환 | 접근 가능한 프로젝트의 criteria만 반환 |
| `timezone` import | 누락 (soft_delete에서 사용 중) | **추가** |

**결과**: 미인증 사용자 `/api/service/projects/projects/` 접근 시 401 반환

---

### 7. Render.com 배포 실패 디버깅 및 수정

#### 문제 상황
`a47c40c` 커밋 이후 Render.com 빌드 실패:
```
django.db.utils.ProgrammingError: relation "survey_responses" already exists
```

**원인**: Render DB에 `survey_responses` 테이블이 마이그레이션 이전부터 존재 → `workshops.0001_initial`이 재생성 시도 → 충돌

#### 수정 시도 과정

| 시도 | 방법 | 결과 | 실패 원인 |
|------|------|------|----------|
| 1차 | `migrate --fake-initial` | CI ✅ Render ❌ | `--fake-initial`은 ALL 테이블이 존재할 때만 동작 (일부 없으면 실패) |
| 2차 | `SeparateDatabaseAndState` + `RunPython` | CI ❌ | `RunPython`은 `from_state.apps` 사용 → 새 모델 미포함 → `get_model()` 실패 |
| 3차 | `render-build.sh` 조건부 `record_applied` | CI ✅ Render ✅ | 배포 성공 |

#### 최종 해결책

**파일 1: `render-build.sh`** (커밋 `ebff907`)
```bash
# migrate 실행 전, 테이블이 이미 존재하면 migration을 applied로 마킹
python manage.py shell -c "
from django.db import connection
from django.db.migrations.recorder import MigrationRecorder
tables = connection.introspection.table_names()
recorder = MigrationRecorder(connection)
applied = {(m.app, m.name) for m in recorder.migration_qs}

if 'survey_responses' in tables and ('workshops', '0001_initial') not in applied:
    recorder.record_applied('workshops', '0001_initial')

if 'export_templates' in tables and ('exports', '0001_initial') not in applied:
    recorder.record_applied('exports', '0001_initial')
"
python manage.py migrate --no-input
```

#### 추가 문제: workshop_sessions 테이블 미존재

`survey_responses`는 있지만 `workshop_sessions` 등 다른 테이블은 없는 불일치 상태 발견.
→ `0001_initial`을 fake-apply했기 때문에 다른 테이블이 생성 안 됨.

**파일 2-3: `0002_create_missing_tables.py`** (커밋 `4f95b1a`)

`0002` 마이그레이션에서 `RunPython`으로 누락 테이블 조건부 생성:
- `0001_initial` 이후 실행되므로 `from_state.apps`에 workshop 모델 포함 → `get_model()` 정상 작동
- 각 모델의 DB 테이블 존재 여부를 확인 후 없을 때만 `schema_editor.create_model()` 호출
- 의존성 순서: `WorkshopSession` → `SurveyTemplate` → `WorkshopParticipant` → `RealTimeProgress` → `GroupConsensusResult` → `SurveyResponse`
- Fresh DB (CI): `0001_initial`이 모두 생성 → `0002`는 no-op ✅
- Render 기존 DB: `0001_initial` fake → `0002`가 누락 테이블 생성 ✅

---

## 커밋 내역 (세션 전체)

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | CI | 내용 |
|-----------|----|------|
| `9a6710f3` | ✅ #34 | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | ✅ #35 | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | ✅ #36 | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | ✅ #37 | feat: add initial migrations for exports and workshops apps |
| `569f1556` | ✅ #38 | feat: add initial migrations for exports and workshops apps |
| `a47c40c` | ✅ #39 | security: require authentication for ProjectViewSet and CriteriaViewSet |
| `6a9b693` | ✅ #40 | fix: --fake-initial 시도 (Render 실패) |
| `b4ed855` | ❌ #41 | fix: SeparateDatabaseAndState+RunPython 시도 (CI 실패) |
| `ebff907` | ✅ #42 | fix: render-build.sh 조건부 마킹 + 마이그레이션 원복 |
| `4f95b1a` | ✅ #43 | fix: 0002 migration으로 누락 테이블 생성 |

---

## 현재 시스템 상태

### 백엔드 (aebonlee/ahp-django-service)

| 앱 | 엔드포인트 | 인증 | 상태 |
|----|-----------|------|------|
| accounts | `/api/service/accounts/` | IsAuthenticated | ✅ |
| projects | `/api/service/projects/projects/` | IsAuthenticated | ✅ 401 (미인증) |
| criteria | `/api/service/projects/criteria/` | IsAuthenticated | ✅ 401 (미인증) |
| evaluations | `/api/service/evaluations/` | IsAuthenticated | ✅ |
| analysis | `/api/service/analysis/` | IsAuthenticated | ✅ |
| subscriptions | `/api/service/subscriptions/` | IsAuthenticated | ✅ |
| exports | `/api/service/exports/` | IsAuthenticated | ✅ |
| workshops | `/api/service/workshops/sessions/` | IsAuthenticated | ✅ 200 (빈 목록) |

- **CI**: ✅ Run #39-40, #42-43 성공 (#41은 SeparateDatabaseAndState 시도로 실패)
- **Render.com**: ✅ 배포 성공, workshop_sessions 테이블 생성 완료

### 프론트엔드 (aebonlee/ahp_app)

- **CI Pipeline**: ✅ 통과
- **GitHub Pages**: ✅ 배포 완료
- **배포 URL**: https://aebonlee.github.io/ahp_app

---

## 남은 작업 (TODO)

### 우선순위 HIGH
1. **전체 API 연동 통합 테스트**
   - ALTERNATIVES 엔드포인트 (`criteria/?type=alternative`) 실제 동작 확인
   - 평가 비교(comparisons) CRUD 테스트
   - 분석(analysis) AHP 계산 테스트
   - `GET /api/service/exports/excel/?project=1` 응답 확인

2. **회원가입 이메일 인증 흐름 검토**

### 우선순위 LOW (개발 완료 후)
3. **Render.com PostgreSQL → Neon.tech 이전** ($7/월 절약)
4. **새 프로덕션 레포** 생성 (현재 레포는 백업용)

---

## 기술 노트

### Django 앱 추가 시 필수 체크리스트
새 Django 앱을 추가할 때 반드시 다음 3단계 모두 수행:
1. `apps/{앱명}/migrations/__init__.py` 생성
2. `apps/{앱명}/migrations/0001_initial.py` 생성 (모델이 있는 경우)
3. `settings.py` → `LOCAL_APPS` 리스트에 `'apps.{앱명}'` 추가

순서 없이 `urls.py`에만 include 추가하면 CI `manage.py check` 실패.

### GitHub Pages "Setup Pages" 실패 패턴
- 빌드 자체는 성공해도 `configure-pages@v4` 액션이 실패할 수 있음
- GitHub 인프라 일시 문제 또는 환경(github-pages) 설정 문제
- 재트리거(새 push)로 대부분 해결됨

### Django RunPython과 SeparateDatabaseAndState 주의사항
`SeparateDatabaseAndState`의 `database_operations` 안에 있는 `RunPython`은
`from_state.apps` (state_operations 적용 **이전** 상태)를 사용.
따라서 state_operations에서 정의한 새 모델을 `apps.get_model()`로 조회 불가.

올바른 패턴: 새 모델을 사용하는 `RunPython`은 **별도 마이그레이션**(`0002`)으로 분리.
이 경우 `from_state`가 `0001_initial`의 state_operations를 포함하므로 `get_model()` 정상 동작.

### Render.com 마이그레이션 충돌 처리 패턴
마이그레이션 이전에 테이블이 이미 존재하는 경우:
1. `render-build.sh`에서 `MigrationRecorder.record_applied()` 로 해당 마이그레이션 수동 마킹
2. 후속 마이그레이션(`0002`)에서 누락 테이블을 `schema_editor.create_model()` + 존재 여부 체크로 생성
3. `--fake-initial`은 ALL 테이블 존재 시에만 동작하므로 부분 상태에서는 사용 불가
