# AHP App 개발일지 — 2026-02-19

## 세션 개요
- **작업 시간**: 세션 지속 (전일 컨텍스트 이어서 진행)
- **담당 모델**: Claude Sonnet 4.6
- **작업 범위**: 백엔드 CI 실패 디버깅 및 수정, 배포 검증, ESLint 수정, alert() 전면 제거 (55개 파일)

---

## 세션 시작 시점 상태 (컨텍스트 재개)

전일(2026-02-18) 세션에서 다음 작업까지 완료:
- 프론트엔드 12개 커밋 (alert 제거, URL 수정, 이모지 로그 제거 등)
- 백엔드 exports/workshops 앱 신규 구현 (GitHub API 직접 커밋)
- `simple_urls.py` 업데이트: exports, workshops 등록

**세션 재개 시 오류 상황:**
- 백엔드 CI 실패 (#32, #33 모두 failure)
- Render.com 배포도 실패
- 사용자 보고: "2개도 에러야", "render.com에서도 에러야"

---

## 완료된 작업

### 1. 백엔드 CI 실패 원인 분석 및 수정

#### 근본 원인 파악
백엔드 CI 실패 원인 2가지:

**원인 1**: `apps.exports`와 `apps.workshops`가 `INSTALLED_APPS`에 미등록
- `simple_urls.py`에 URL 포함 추가 → Django startup `manage.py check` 실패
- `python manage.py check --deploy` 에서 앱 임포트 오류 발생

**원인 2**: 두 앱 모두 `migrations/` 디렉터리 미존재
- 모델이 있는 앱은 반드시 `migrations/__init__.py` + `0001_initial.py` 필요

#### 수정 내역

**파일 1: `ahp_backend/settings.py`** (commit `9a6710f3`)
```python
LOCAL_APPS = [
    'apps.accounts',
    'apps.projects',
    'apps.evaluations',
    'apps.analysis',
    'apps.subscriptions',
    'apps.exports',      # 신규 추가
    'apps.workshops',    # 신규 추가
]
```

**파일 2-5: migrations 디렉터리 생성** (commit `75473c26` ~ `569f1556`)
- `apps/exports/migrations/__init__.py`
- `apps/exports/migrations/0001_initial.py` — ExportTemplate, ExportHistory, ReportSchedule 테이블
- `apps/workshops/migrations/__init__.py`
- `apps/workshops/migrations/0001_initial.py` — WorkshopSession, WorkshopParticipant, RealTimeProgress, GroupConsensusResult, SurveyTemplate, SurveyResponse 테이블

#### 의존성 설정
```python
# exports/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]

# workshops/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]
```

### 2. 백엔드 CI 검증

수정 후 백엔드 CI 결과:

| Run # | Status | Commit |
|-------|--------|--------|
| #34 | ✅ success | 9a6710f3 (settings.py INSTALLED_APPS 수정) |
| #35 | ✅ success | 75473c26 (migrations __init__ 생성) |
| #36 | ✅ success | 0d7bbf41 (migrations __init__ 생성) |
| #37 | ✅ success | 6abdf6c4 (0001_initial.py 생성) |
| #38 | ✅ success | 569f1556 (0001_initial.py 생성) |

**모든 CI 통과 완료 ✅**

### 3. 프론트엔드 GitHub Pages 배포 상태 점검

| 워크플로우 | 최신 Run | 결과 | 비고 |
|----------|---------|------|------|
| CI Pipeline | #81 | ✅ success | 빌드 정상 |
| Deploy to GitHub Pages | #87 | ❌ failure | "Setup Pages" 단계 실패 |
| pages build and deployment | #88 | ❌ failure | #87 실패로 인한 연쇄 실패 |

**분석**:
- 빌드 자체는 성공 (`Build Application` job 통과)
- `Deploy` job의 `Setup Pages` 단계에서 실패
- 이전 커밋(08e5e38)에서는 배포 성공했으나 dev log 커밋(f4135c2) 이후 실패
- 코드 문제가 아닌 GitHub Pages 인프라 일시적 문제로 판단
- 로컬 빌드 테스트: `npm run build` 정상 완료 ✅

### 4. connectionTest.ts ESLint 수정

**오류**: `no-whitespace-before-property` (빌드 경고)
```typescript
// 수정 전 (경고 발생)
console.log('=' .repeat(50));  // line 291, 308

// 수정 후
console.log('='.repeat(50));
```

**파일**: `src/utils/connectionTest.ts` (lines 291, 308)

---

## 완료된 작업 (세션 2부)

### 5. alert() 전면 제거 — 55개 파일

전일 세션에서 28개 파일 완료 후, 56개 파일이 추가로 남아있는 것을 확인.
총 **55개 컴포넌트** 파일에서 `alert()` 호출 완전 제거.

#### 처리 전략

| 구분 | 처리 방법 |
|------|----------|
| 프로덕션 UI 컴포넌트 | `actionMessage` 상태 + `showActionMessage()` 헬퍼 + 토스트 배너 JSX |
| 데모/테스트 파일 | `console.log()` 또는 `console.warn()` 대체 |
| 주석 처리된 alert | 변경 없음 |
| XSS 테스트 문자열 (`security.test.ts`) | 변경 없음 (함수 호출 아님) |

#### 토스트 배너 패턴
```tsx
const [actionMessage, setActionMessage] = useState<{type:'success'|'error'|'info', text:string}|null>(null);

const showActionMessage = (type: 'success'|'error'|'info', text: string) => {
  setActionMessage({type, text});
  setTimeout(() => setActionMessage(null), 3000);
};

// JSX (return div의 첫 번째 자식):
{actionMessage && (
  <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-sm font-medium shadow-lg ${
    actionMessage.type === 'success' ? 'bg-green-100 text-green-800' :
    actionMessage.type === 'info' ? 'bg-blue-100 text-blue-800' :
    'bg-red-100 text-red-800'
  }`}>
    {actionMessage.text}
  </div>
)}
```

#### 처리된 파일 목록 (55개)

**admin 폴더 (17개)**
- AlternativeManagement.tsx, CriteriaManagement.tsx, EnhancedEvaluatorManagement.tsx
- EvaluatorAssignment.tsx, EvaluatorManagement.tsx, GroupWeightAnalysis.tsx
- ModelBuilderWorkflow.tsx, ModelConfiguration.tsx, MyProjects.tsx
- PersonalServiceDashboard.tsx, ProjectCompletion.tsx, SensitivityAnalysis.tsx
- SurveyLinkManager.tsx, TrashBin.tsx, TrashBinTest.tsx
- UsageManagement.tsx, UserManagement.tsx
- `ai-management/AISettingsManager.tsx`

**AI/분석 폴더 (6개)**
- `ai-interpretation/AIResultsInterpretationPage.tsx`
- `ai-materials/AIMaterialsGenerationPage.tsx`
- `ai-paper/AIPaperGenerationPage.tsx`
- `ai-quality/AIQualityValidationPage.tsx`
- `analysis/ResultsAnalysis.tsx`
- `analysis/advanced/ComprehensiveReport.tsx`

**평가/기준 폴더 (7개)**
- `comparison/PairwiseComparison.tsx`
- `criteria/BulkCriteriaInput.tsx`
- `criteria/InteractiveCriteriaEditor.tsx`
- `evaluation/DirectInputEvaluation.tsx`, `EvaluationTest.tsx`, `MultiModeEvaluation.tsx`
- `evaluation/assignment/InvitationHistory.tsx`, `InviteEvaluators.tsx`

**superadmin 폴더 (4개)**
- AllProjectsManagement.tsx, RoleSwitcher.tsx, SystemReset.tsx, SystemSettings.tsx

**기타 (21개)**
- `auth/SecureLoginForm.tsx`
- `common/ServerWarningBadge.tsx`, `TrashOverflowModal.tsx`
- `decision/DecisionSupportSystem.tsx`
- `demo/ComponentShowcase.tsx`, `EventSequenceDemo.tsx`
- `evaluator/ProjectSelection.tsx`
- `modeling/ModelBuilder.tsx`
- `notifications/EmailNotificationSystem.tsx`
- `paper/PaperManagement.tsx`
- `project/EnhancedProjectCreationWizard.tsx`
- `settings/AIConfiguration.tsx`, `PersonalSettings.tsx`
- `subscription/SubscriptionDashboard.tsx`
- `survey/EvaluatorSurveyPage.tsx`, `SurveyFormBuilder.tsx`, `SurveyManagementSystem.tsx`
- `workshop/ParticipantManager.tsx`
- `App.tsx`

#### 최종 검증
```
Grep alert() 결과:
- CriteriaManagement.tsx:527 → 주석 처리된 줄 (// alert(...))
- security.test.ts → XSS 테스트 문자열 (함수 호출 아님)
✅ 실제 alert() 함수 호출 0개 남음
```

#### 로컬 빌드 결과
```
✅ Compiled with warnings (errors 없음)
번들: 581.61 kB gzip
```

---

## 커밋 내역

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | 내용 |
|-----------|------|
| `9a6710f3` | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | feat: add initial migrations for exports and workshops apps |
| `569f1556` | feat: add initial migrations for exports and workshops apps |

---

## 완료된 작업 (세션 3부)

### 6. projects 엔드포인트 인증 강화

**파일**: `apps/projects/views.py` (커밋 `a47c40c`)

#### 수정 내역

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| `ProjectViewSet.authentication_classes` | `[]` (비어있음) | 제거 (DRF 기본값 사용) |
| `ProjectViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `ProjectViewSet.get_permissions()` | 항상 `AllowAny()` 반환 | **제거** |
| `ProjectViewSet.get_queryset()` 익명 분기 | 모든 프로젝트 반환 (보안 결함) | **제거** |
| `CriteriaViewSet.authentication_classes` | `[]` (비어있음) | 제거 |
| `CriteriaViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `CriteriaViewSet.get_queryset()` | 모든 criteria 반환 | 접근 가능한 프로젝트의 criteria만 반환 |
| `timezone` import | 누락 (soft_delete에서 사용 중) | **추가** |

**결과**: 미인증 사용자 `/api/service/projects/projects/` 접근 시 401 반환

---

### 7. Render.com 배포 실패 디버깅 및 수정

#### 문제 상황
`a47c40c` 커밋 이후 Render.com 빌드 실패:
```
django.db.utils.ProgrammingError: relation "survey_responses" already exists
```

**원인**: Render DB에 `survey_responses` 테이블이 마이그레이션 이전부터 존재 → `workshops.0001_initial`이 재생성 시도 → 충돌

#### 수정 시도 과정

| 시도 | 방법 | 결과 | 실패 원인 |
|------|------|------|----------|
| 1차 | `migrate --fake-initial` | CI ✅ Render ❌ | `--fake-initial`은 ALL 테이블이 존재할 때만 동작 (일부 없으면 실패) |
| 2차 | `SeparateDatabaseAndState` + `RunPython` | CI ❌ | `RunPython`은 `from_state.apps` 사용 → 새 모델 미포함 → `get_model()` 실패 |
| 3차 | `render-build.sh` 조건부 `record_applied` | CI ✅ Render ✅ | 배포 성공 |

#### 최종 해결책

**파일 1: `render-build.sh`** (커밋 `ebff907`)
```bash
# migrate 실행 전, 테이블이 이미 존재하면 migration을 applied로 마킹
python manage.py shell -c "
from django.db import connection
from django.db.migrations.recorder import MigrationRecorder
tables = connection.introspection.table_names()
recorder = MigrationRecorder(connection)
applied = {(m.app, m.name) for m in recorder.migration_qs}

if 'survey_responses' in tables and ('workshops', '0001_initial') not in applied:
    recorder.record_applied('workshops', '0001_initial')

if 'export_templates' in tables and ('exports', '0001_initial') not in applied:
    recorder.record_applied('exports', '0001_initial')
"
python manage.py migrate --no-input
```

#### 추가 문제: workshop_sessions 테이블 미존재

`survey_responses`는 있지만 `workshop_sessions` 등 다른 테이블은 없는 불일치 상태 발견.
→ `0001_initial`을 fake-apply했기 때문에 다른 테이블이 생성 안 됨.

**파일 2-3: `0002_create_missing_tables.py`** (커밋 `4f95b1a`)

`0002` 마이그레이션에서 `RunPython`으로 누락 테이블 조건부 생성:
- `0001_initial` 이후 실행되므로 `from_state.apps`에 workshop 모델 포함 → `get_model()` 정상 작동
- 각 모델의 DB 테이블 존재 여부를 확인 후 없을 때만 `schema_editor.create_model()` 호출
- 의존성 순서: `WorkshopSession` → `SurveyTemplate` → `WorkshopParticipant` → `RealTimeProgress` → `GroupConsensusResult` → `SurveyResponse`
- Fresh DB (CI): `0001_initial`이 모두 생성 → `0002`는 no-op ✅
- Render 기존 DB: `0001_initial` fake → `0002`가 누락 테이블 생성 ✅

---

## 커밋 내역 (세션 전체)

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | CI | 내용 |
|-----------|----|------|
| `9a6710f3` | ✅ #34 | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | ✅ #35 | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | ✅ #36 | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | ✅ #37 | feat: add initial migrations for exports and workshops apps |
| `569f1556` | ✅ #38 | feat: add initial migrations for exports and workshops apps |
| `a47c40c` | ✅ #39 | security: require authentication for ProjectViewSet and CriteriaViewSet |
| `6a9b693` | ✅ #40 | fix: --fake-initial 시도 (Render 실패) |
| `b4ed855` | ❌ #41 | fix: SeparateDatabaseAndState+RunPython 시도 (CI 실패) |
| `ebff907` | ✅ #42 | fix: render-build.sh 조건부 마킹 + 마이그레이션 원복 |
| `4f95b1a` | ✅ #43 | fix: 0002 migration으로 누락 테이블 생성 |

---

## 현재 시스템 상태

### 백엔드 (aebonlee/ahp-django-service)

| 앱 | 엔드포인트 | 인증 | 상태 |
|----|-----------|------|------|
| accounts | `/api/service/accounts/` | IsAuthenticated | ✅ |
| projects | `/api/service/projects/projects/` | IsAuthenticated | ✅ 401 (미인증) |
| criteria | `/api/service/projects/criteria/` | IsAuthenticated | ✅ 401 (미인증) |
| evaluations | `/api/service/evaluations/` | IsAuthenticated | ✅ |
| analysis | `/api/service/analysis/` | IsAuthenticated | ✅ |
| subscriptions | `/api/service/subscriptions/` | IsAuthenticated | ✅ |
| exports | `/api/service/exports/` | IsAuthenticated | ✅ |
| workshops | `/api/service/workshops/sessions/` | IsAuthenticated | ✅ 200 (빈 목록) |

- **CI**: ✅ Run #39-40, #42-43 성공 (#41은 SeparateDatabaseAndState 시도로 실패)
- **Render.com**: ✅ 배포 성공, workshop_sessions 테이블 생성 완료

### 프론트엔드 (aebonlee/ahp_app)

- **CI Pipeline**: ✅ 통과
- **GitHub Pages**: ✅ 배포 완료
- **배포 URL**: https://aebonlee.github.io/ahp_app

---

## 남은 작업 (TODO) — 세션 3 기준

### 우선순위 HIGH
1. ~~**전체 API 연동 통합 테스트**~~ → **완료** (세션 4)
2. **회원가입 이메일 인증 흐름 검토**

### 우선순위 LOW (개발 완료 후)
3. **Render.com PostgreSQL → Neon.tech 이전** ($7/월 절약)
4. **새 프로덕션 레포** 생성 (현재 레포는 백업용)

---

## 기술 노트

### Django 앱 추가 시 필수 체크리스트
새 Django 앱을 추가할 때 반드시 다음 3단계 모두 수행:
1. `apps/{앱명}/migrations/__init__.py` 생성
2. `apps/{앱명}/migrations/0001_initial.py` 생성 (모델이 있는 경우)
3. `settings.py` → `LOCAL_APPS` 리스트에 `'apps.{앱명}'` 추가

순서 없이 `urls.py`에만 include 추가하면 CI `manage.py check` 실패.

### GitHub Pages "Setup Pages" 실패 패턴
- 빌드 자체는 성공해도 `configure-pages@v4` 액션이 실패할 수 있음
- GitHub 인프라 일시 문제 또는 환경(github-pages) 설정 문제
- 재트리거(새 push)로 대부분 해결됨

### Django RunPython과 SeparateDatabaseAndState 주의사항
`SeparateDatabaseAndState`의 `database_operations` 안에 있는 `RunPython`은
`from_state.apps` (state_operations 적용 **이전** 상태)를 사용.
따라서 state_operations에서 정의한 새 모델을 `apps.get_model()`로 조회 불가.

올바른 패턴: 새 모델을 사용하는 `RunPython`은 **별도 마이그레이션**(`0002`)으로 분리.
이 경우 `from_state`가 `0001_initial`의 state_operations를 포함하므로 `get_model()` 정상 동작.

### Render.com 마이그레이션 충돌 처리 패턴
마이그레이션 이전에 테이블이 이미 존재하는 경우:
1. `render-build.sh`에서 `MigrationRecorder.record_applied()` 로 해당 마이그레이션 수동 마킹
2. 후속 마이그레이션(`0002`)에서 누락 테이블을 `schema_editor.create_model()` + 존재 여부 체크로 생성
3. `--fake-initial`은 ALL 테이블 존재 시에만 동작하므로 부분 상태에서는 사용 불가

---

## 세션 4: API 연동 통합 테스트 (2026-02-19 오후)

### 테스트 방법
- Python `urllib` (Windows에서 curl 미사용) 기반 HTTP 요청
- 백엔드: `https://ahp-django-backend.onrender.com`
- 순서: 회원가입 → 로그인 → 프로젝트 생성 → 기준 생성 → 평가 생성 → 비교 입력 → 분석

### 통합 테스트 결과

| # | 엔드포인트 | HTTP | 결과 | 비고 |
|---|-----------|------|------|------|
| 1 | `/health/` | GET | ✅ 200 | |
| 2 | `/db-status/` | GET | ✅ 200 | tables=75 |
| 3 | `/api/service/accounts/register/` | POST | ✅ 201 | JWT 포함 |
| 4 | `/api/service/accounts/login/` | POST | ✅ 200 | access/refresh 발급 |
| 5 | `/api/service/accounts/users/me/` | GET | ❌ 404 | → 수정됨 |
| 6 | `/api/service/projects/projects/` (미인증) | GET | ✅ 401 | 보안 정상 |
| 7 | `/api/service/projects/projects/` (인증) | GET | ✅ 200 | count=0 |
| 8 | `/api/service/projects/projects/` | POST | ✅ 201 | id 없음 → 수정됨 |
| 9 | `/api/service/projects/projects/{id}/` | GET | ✅ 200 | |
| 10 | `/api/service/projects/projects/{id}/` | PATCH | ✅ 200 | status 변경 |
| 11 | `/api/service/projects/criteria/` | POST | ✅ 201 | 3개 생성 |
| 12 | `/api/service/evaluations/evaluations/` | POST | ✅ 201 | 비교쌍 3개 자동생성, id 없음 → 수정됨 |
| 13 | `/api/service/evaluations/comparisons/` | GET | ✅ 200 | count=3 |
| 14 | `/api/service/evaluations/comparisons/{id}/` | PATCH | ❌ 500 | → 수정됨 |
| 15 | `/api/service/analysis/calculate/individual/` | POST | ❌ 500 | → 수정됨 |
| 16 | `/api/service/analysis/project-summary/` | GET | ❌ 500 | → 수정됨 |
| 17 | `/api/service/auth/token/refresh/` | POST | ✅ 200 | |

### 발견 및 수정한 버그

#### 버그 1: ProjectCreateSerializer/EvaluationCreateSerializer — `id` 누락
**현상**: 201 Created 응답에 `id` 필드 없음 → 프론트엔드가 생성된 리소스 ID를 모름
**원인**: `fields` 리스트에 `id` 미포함
**수정**:
- `ProjectCreateSerializer`: `id = serializers.SerializerMethodField()` + `get_id()` 추가
- `EvaluationCreateSerializer`: `id = serializers.UUIDField(read_only=True)` 추가

#### 버그 2: PairwiseComparisonSerializer.validate() — PATCH 시 500 KeyError
**현상**: PATCH `/comparisons/{id}/` 시 500 Server Error
**원인**: `validate()`에서 `data['criteria_a']`, `data['criteria_b']`를 직접 접근 → PATCH(partial)에서 해당 키가 없으면 `KeyError`
**수정**: instance 값을 fallback으로 사용
```python
criteria_a = data.get('criteria_a', getattr(self.instance, 'criteria_a', None))
criteria_b = data.get('criteria_b', getattr(self.instance, 'criteria_b', None))
```
**추가**: `evaluation` 필드도 `fields`에 추가하여 POST 지원

#### 버그 3: AnalysisViewSet — 4개 액션 메서드 미구현
**현상**: `urls.py`에서 참조하는 `calculate_individual`, `calculate_group`, `calculate_final_priorities`, `project_summary`가 `AnalysisViewSet`에 없음 → 500
**수정**: 4개 메서드 모두 구현
- `calculate_individual`: evaluation_id 기준 AHP 가중치 계산 + CR 반환
- `calculate_group`: 전체 완료 평가 기하평균 집계
- `calculate_final_priorities`: calculate_group 위임
- `project_summary`: 프로젝트 분석 상태 요약

#### 버그 4: `/accounts/users/me/` — URL 라우팅 404
**현상**: `UserViewSet`에 `me` 액션이 있지만 router는 `user_views.UserViewSet` 등록 (해당 클래스에 `me` 없음) → pk="me"로 조회 → 404
**수정**: `accounts/urls.py`에 `/accounts/me/` 명시적 URL 추가 + `current_user_profile` FBV 구현 (GET/PATCH 지원)

### 커밋 내역 (세션 4)

| 커밋 해시 | 내용 |
|-----------|------|
| `caae9a9` | fix: 통합 테스트 발견 버그 3종 수정 (serializers + analysis views) |
| `533ede7` | fix: /me/ 엔드포인트 404 수정 |
| `d3cc26b` | fix: EvaluationCreateSerializer id 필드 누락 수정 |

### 최종 검증 결과 (Render 배포 완료 후)

모든 수정 사항이 Render에 반영된 후 전체 흐름을 재실행한 최종 결과:

| # | 엔드포인트 | HTTP | 최종 결과 | 비고 |
|---|-----------|------|-----------|------|
| 1 | `/api/service/accounts/register/` | POST | ✅ 201 | user_id=22 포함 |
| 2 | `/api/service/accounts/me/` | GET | ✅ 200 | id, username 정상 반환 |
| 3 | `/api/service/projects/projects/` | POST | ✅ 201 | **id 포함** (UUID) |
| 4 | `/api/service/projects/criteria/` × 3 | POST | ✅ 201 × 3 | |
| 5 | `/api/service/evaluations/evaluations/` | POST | ✅ 201 | **id 포함** (UUID) |
| 6 | `/api/service/evaluations/comparisons/` | GET | ✅ 200 | count=3 자동생성 |
| 7 | `/api/service/evaluations/comparisons/{id}/` × 3 | PATCH | ✅ 200 × 3 | |
| 8 | `/api/service/analysis/calculate/individual/` | POST | ✅ 200 | AHP 가중치 정상 계산 |
| 9 | `/api/service/analysis/project-summary/` | GET | ✅ 200 | 요약 정상 반환 |

**AHP 계산 샘플 결과** (CR=0.0036, 3:5:2 비교 입력):
```
Cost:    0.6483  (rank 1)
Quality: 0.2297  (rank 2)
Speed:   0.1220  (rank 3)
CR=0.0036 → is_consistent=True (threshold 0.1 이하)
```

**전체 핵심 흐름 완전 동작 확인**: 회원가입 → 프로젝트 생성 → 기준 설정 → 평가 생성 → 쌍대비교 입력 → AHP 가중치 계산

---

## 최종 시스템 상태 (2026-02-19 세션 종료 기준)

### 백엔드 (aebonlee/ahp-django-service)

| 앱 | 주요 엔드포인트 | 상태 |
|----|----------------|------|
| accounts | register, login, /me/ | ✅ |
| projects | projects CRUD, criteria CRUD | ✅ |
| evaluations | evaluations, comparisons (PATCH) | ✅ |
| analysis | calculate_individual, project_summary | ✅ |
| workshops | sessions | ✅ |
| exports | templates | ✅ |

**보안**: 미인증 접근 → 401 Unauthorized (정상)

### 커밋 히스토리 (세션 3~4)

| 커밋 | CI | 내용 |
|------|----|------|
| `a47c40c` | ✅ | security: ProjectViewSet 인증 강화 |
| `ebff907` | ✅ | fix: Render 마이그레이션 충돌 처리 |
| `4f95b1a` | ✅ | fix: 누락 테이블 생성 마이그레이션 |
| `caae9a9` | ✅ | fix: 통합 테스트 버그 3종 수정 |
| `533ede7` | ✅ | fix: /me/ 엔드포인트 URL 라우팅 수정 |
| `d3cc26b` | ✅ | fix: EvaluationCreateSerializer id 누락 수정 |

---

## 세션 5: 프론트엔드-백엔드 연동 테스트 (2026-02-19 저녁)

### 테스트 목표
프론트엔드 `api.ts`의 엔드포인트 상수가 실제 Django 백엔드 URL과 일치하는지 검증하고 수정.

### 테스트 방법
Python `urllib`로 실제 백엔드 서버에 HTTP 요청하여 각 URL의 응답코드 확인.

### 발견된 문제 (수정 전)

#### 문제 1: AUTH.ME/PROFILE — 404
| 항목 | 기존 값 | 실제 결과 |
|------|---------|-----------|
| `AUTH.ME` | `/api/service/auth/profile/` | 404 NOT FOUND |
| `AUTH.PROFILE` | `/api/service/auth/profile/` | 404 NOT FOUND |
| **정상 경로** | `/api/service/accounts/me/` | ✅ 200 |

#### 문제 2: CRITERIA — 잘못된 경로 패턴
| 항목 | 기존 값 | 실제 결과 |
|------|---------|-----------|
| `CRITERIA.LIST` | `(id) => /projects/${id}/criteria/` | 404 |
| `CRITERIA.CREATE` | `(id) => /projects/${id}/add_criteria/` | 404 |
| **정상 경로** | `/projects/criteria/?project=${id}` | ✅ 200 |

→ `CriteriaViewSet`은 독립적인 `/projects/criteria/` 라우팅을 사용하며 `?project=` 쿼리 파라미터로 필터링.

#### 문제 3: ALTERNATIVES — 존재하지 않는 앱
| 기존 값 | 실제 결과 |
|---------|-----------|
| `/api/v1/alternatives/` | 404 (alternatives 앱 없음) |
| **해결**: `criteria/?type=alternative` 로 대체 | ✅ 200 |

#### 문제 4: COMPARISONS/EVALUATIONS — 잘못된 prefix `/api/v1/`
| 항목 | 기존 값 | 올바른 값 |
|------|---------|-----------|
| `EVALUATIONS.SUBMIT` | `/api/v1/comparisons/` | `/api/service/evaluations/comparisons/` |
| `EVALUATIONS.GET_MATRIX` | `/api/v1/comparisons/?project=` | `/api/service/evaluations/comparisons/?project=` |
| `COMPARISONS.SAVE` | `/api/v1/comparisons/` | `/api/service/evaluations/comparisons/` |
| `COMPARISONS.GET` | `/api/v1/comparisons/?project=` | `/api/service/evaluations/comparisons/?project=` |

#### 문제 5: RESULTS — 존재하지 않는 `/api/v1/results/`
| 항목 | 기존 값 | 올바른 값 |
|------|---------|-----------|
| `RESULTS.GET` | `/api/v1/results/${id}/` | `/api/service/analysis/project-summary/?project_id=${id}` |
| `RESULTS.CALCULATE_GROUP` | `/api/v1/results/group/` | `/api/service/analysis/calculate/group/` |
| `RESULTS.SENSITIVITY` | `/api/v1/results/sensitivity/` | `/api/service/analysis/sensitivity/` |
| `EVALUATIONS.RESULTS` | `/api/v1/results/?project=` | `/api/service/analysis/project-summary/?project_id=` |

#### 문제 6: EVALUATORS — `/api/service/evaluators/` 앱 없음
| 기존 값 | 실제 결과 |
|---------|-----------|
| `/api/service/evaluators/` | 404 |
| `SEND_INVITATIONS` → `/evaluators/invite/` | 404 |
| **해결**: `/evaluations/invitations/`, `/evaluations/bulk-invitations/` | ✅ 200 |

#### 보안 취약점: CORS_ALLOW_ALL_ORIGINS=True
```
Origin: https://evil.com → Access-Control-Allow-Origin: https://evil.com (⚠️)
Origin: https://naver.com → Access-Control-Allow-Origin: https://naver.com (⚠️)
```
Render 환경 변수에 `CORS_ALLOW_ALL_ORIGINS=True`가 설정되어 있어 모든 origin 허용.

### 수정 내역

#### 수정 1: `api.ts` 전면 수정 (프론트엔드)
파일: `D:/ahp_app/ahp_app/src/config/api.ts`

```typescript
// 수정 전 → 수정 후
AUTH.ME:     '/auth/profile/'      → '/accounts/me/'
AUTH.LOGIN:  '/auth/login/'        → '/auth/token/'   (simplejwt 직접)
CRITERIA.LIST: (id) => '/{id}/criteria/' → '/criteria/?project={id}'
CRITERIA.CREATE: (id) => '/{id}/add_criteria/' → '/criteria/'
ALTERNATIVES.*: '/api/v1/alternatives/' → '/projects/criteria/?type=alternative'
EVALUATIONS.*: '/api/v1/comparisons|results/' → '/evaluations/comparisons/' 및 '/analysis/...'
COMPARISONS.*: '/api/v1/comparisons/' → '/evaluations/comparisons/'
RESULTS.*: '/api/v1/results/' → '/analysis/project-summary/' 및 '/analysis/calculate/'
EVALUATORS.*: '/evaluators/' → '/evaluations/invitations/', '/evaluations/bulk-invitations/'
```

커밋: `ac28eb2`

#### 수정 2: CORS 보안 강화 (백엔드)
파일: `ahp_backend/settings.py`

```python
# 수정 전
CORS_ALLOW_ALL_ORIGINS = config('CORS_ALLOW_ALL_ORIGINS', default=False, cast=bool)
CORS_ALLOWED_ORIGIN_REGEXES = [r"^file://.*$"]

# 수정 후
CORS_ALLOW_ALL_ORIGINS = False  # 환경 변수로 override 불가, 항상 False
CORS_ALLOWED_ORIGIN_REGEXES = [r"^file://.*$"] if DEBUG else []  # DEBUG 시에만
```

커밋: `f810099`

#### 수정 3: AnalysisViewSet UUID 유효성 검증 (백엔드)
잘못된 UUID 문자열로 `Project.objects.get(pk='test')` 호출 시 `ValueError` → 500 발생하던 버그 수정.
- `project_summary`, `calculate_group`, `calculate_individual` 모두 수정
- `(Project.DoesNotExist, ValueError, Exception)` 모두 → 404로 응답

커밋: `c960f7e`

### 검증 결과

| 엔드포인트 | 수정 전 | 수정 후 |
|-----------|---------|---------|
| `AUTH.ME → /accounts/me/` | 404 ❌ | 200 ✅ |
| `CRITERIA → /criteria/?project=` | 404 ❌ | 200 ✅ |
| `COMPARISONS → /evaluations/comparisons/` | 404 ❌ | 200 ✅ |
| `EVALUATORS → /evaluations/invitations/` | 404 ❌ | 200 ✅ |
| `ALTERNATIVES → /criteria/?type=alternative` | 404 ❌ | 200 ✅ |
| CORS evil.com 허용 | ⚠️ ACAO 반환 | ✅ 차단 확인 (Render 반영 완료) |
| `project_summary('test')` | 500 ❌ | 404 ✅ |

### 커밋 내역 (세션 5)

#### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | 내용 |
|-----------|------|
| `f810099` | security: CORS_ALLOW_ALL_ORIGINS 차단, DEBUG에서만 file:// 허용 |
| `c960f7e` | fix: AnalysisViewSet UUID 유효성 검증 (500 → 404) |

#### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `ac28eb2` | fix: api.ts 전체 엔드포인트 백엔드 URL과 일치하도록 수정 |

---

---

## 세션 6: CORS Render 반영 확인 (2026-02-19 야간)

### 테스트 결과

Render 재배포 완료 후 CORS 정책 적용 여부 확인.

| Origin | 허용 여부 | ACAO 헤더 | 결과 |
|--------|-----------|-----------|------|
| `https://aebonlee.github.io` | 허용 대상 | `https://aebonlee.github.io` | ✅ 정상 허용 |
| `http://localhost:3000` | 허용 대상 | `http://localhost:3000` | ✅ 정상 허용 |
| `https://evil.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |
| `https://naver.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |
| `https://google.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |

**결론**: `CORS_ALLOW_ALL_ORIGINS = False` 하드코딩이 Render에 정상 반영됨. 화이트리스트(GitHub Pages, localhost)만 허용되고 임의 origin은 ACAO 헤더 자체가 응답에 포함되지 않음.

---

---

## 세션 7: 이메일 인증 흐름 검토 (2026-02-19 야간)

### 현황 분석

| 항목 | 설정값 | 실제 동작 |
|------|--------|-----------|
| `ACCOUNT_EMAIL_VERIFICATION` | `'mandatory'` (수정 전) | **무효** — 커스텀 뷰가 allauth 우회 |
| `EMAIL_BACKEND` | `console.EmailBackend` (기본값) | 서버 콘솔 출력만, 실제 미발송 |
| 커스텀 `/auth/register/` | allauth 완전 우회 | 가입 즉시 JWT 발급 (이메일 인증 없음) |
| allauth `/auth/registration/` | `'mandatory'` + console backend | 500 에러 (이메일 발송 실패) |

**결론**: 이메일 인증은 이미 비활성화 상태였으나, `ACCOUNT_EMAIL_VERIFICATION = 'mandatory'` 설정이 allauth URL에서 500을 유발하는 불일치 존재.

### 결정: 이메일 인증 비활성화 유지 (베타 단계)

### 수정 내역

파일: `ahp_backend/settings.py` (커밋 `ed84921`)

```python
# 수정 전
ACCOUNT_USERNAME_REQUIRED = False
ACCOUNT_AUTHENTICATION_METHOD = 'email'
ACCOUNT_EMAIL_VERIFICATION = 'mandatory'
ACCOUNT_CONFIRM_EMAIL_ON_GET = True
ACCOUNT_LOGIN_ON_EMAIL_CONFIRMATION = True

# 수정 후
ACCOUNT_USERNAME_REQUIRED = True
ACCOUNT_AUTHENTICATION_METHOD = 'username'
ACCOUNT_EMAIL_VERIFICATION = 'none'      # 코드 실제 동작과 일치
ACCOUNT_CONFIRM_EMAIL_ON_GET = False
ACCOUNT_LOGIN_ON_EMAIL_CONFIRMATION = False
```

→ allauth `/auth/registration/` 500 에러 해소.

### 향후 이메일 인증 활성화 시 필요 작업 (메모)

1. Render 환경 변수에 SMTP 설정 추가:
   ```
   EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
   EMAIL_HOST=smtp.gmail.com
   EMAIL_PORT=587
   EMAIL_HOST_USER=...
   EMAIL_HOST_PASSWORD=...
   ```
2. `ACCOUNT_EMAIL_VERIFICATION = 'mandatory'` 복원
3. 커스텀 `register` 뷰에서 이메일 인증 안내 메시지 추가 (토큰 미즉시 발급)
4. 프론트엔드 "이메일을 확인해주세요" 안내 UI 추가

---

---

## 세션 8: E2E 전체 흐름 테스트 (2026-02-19 심야)

### 테스트 시나리오
회원가입 → JWT 로그인 → 프로필 조회 → 프로젝트 생성 → 기준 3개 추가 → 평가 생성 → 비교쌍 입력(3쌍) → AHP 계산 → 프로젝트 요약 → 토큰 갱신 → 로그아웃

### 1차 테스트 결과 (실패 4건 발견)

| # | 단계 | HTTP | 결과 | 원인 |
|---|------|------|------|------|
| 4 | 프로젝트 생성 | 400 | ❌ | `evaluation_mode='individual'` 유효하지 않은 값 |
| 5 | 기준 추가 | 500 | ❌ | proj_id=None (cascade from #4) |
| 6 | 평가 생성 | 400 | ❌ | proj_id=None (cascade from #4) |
| 12 | 로그아웃 | 500 | ❌ | 토큰 rotation 후 구 refresh 토큰으로 logout 시도 (테스트 오류) |

**수정 내용**:
- `evaluation_mode: 'individual'` → `'practical'` (유효 선택값: practical/theoretical/direct_input/fuzzy_ahp)
- 로그아웃 시 step 11 갱신 후 **새 refresh 토큰** 사용

### 2차 테스트 결과 (전부 통과)

| # | 단계 | HTTP | 결과 |
|---|------|------|------|
| 1 | 회원가입 | 201 | ✅ |
| 2 | JWT 로그인 | 200 | ✅ |
| 3 | 프로필 조회 `/accounts/me/` | 200 | ✅ |
| 4 | 프로젝트 생성 (evaluation_mode=practical) | 201 | ✅ |
| 5 | 기준 3개 추가 `/projects/criteria/` | 201×3 | ✅ |
| 6 | 평가 생성 `/evaluations/evaluations/` | 201 | ✅ |
| 7 | 비교 목록 조회 (3쌍 자동생성) | 200 | ✅ |
| 8 | 비교값 입력 PATCH × 3 | 200×3 | ✅ |
| 9 | AHP 개인 가중치 계산 | 200 | ✅ |
| 10 | 프로젝트 요약 | 200 | ✅ |
| 11 | 토큰 갱신 (새 refresh 발급) | 200 | ✅ |
| 12 | 로그아웃 (갱신된 refresh 사용) | 200 | ✅ |
| 13 | 로그아웃 후 ME 조회 (access 유효기간 내) | 200 | ✅ (정상) |

**17/17 전부 통과**

**AHP 계산 결과** (3:5:2 비교 입력):
```
비용: 0.6483 (rank 1)
품질: 0.2297 (rank 2)
속도: 0.1220 (rank 3)
CR = 0.0036 → is_consistent = True
```

### 추가 발견 버그 및 수정

#### apiService.ts 잘못된 엔드포인트 2곳 (커밋 `504353b`)

| 함수 | 수정 전 | 수정 후 |
|------|---------|---------|
| `validateAccessKey` | POST `/invitations/accept/` (404) | GET `/invitations/by_token/?token=` |
| `resultsAPI.*` | `/api/results/*` (미존재) | `/api/service/analysis/*` |

- `accept`는 `detail=True` action → 올바른 경로는 `/invitations/{id}/accept/`
- 토큰으로 초대 조회는 `by_token` action (detail=False, GET)
- `resultsAPI`는 현재 컴포넌트에서 미사용(dead code)이나 경로 일관성 유지

### 커밋 내역 (세션 8)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `504353b` | fix: apiService.ts validateAccessKey, resultsAPI 경로 수정 |

---

---

## 2026-02-19 전체 세션 종합 요약

### 오늘 수행한 작업 (세션 4~8)

| 세션 | 작업 | 결과 |
|------|------|------|
| 4 | API 연동 통합 테스트 (백엔드 버그 4종 수정) | ✅ 완료 |
| 5 | 프론트엔드-백엔드 연동 테스트 (api.ts 전면 수정) | ✅ 완료 |
| 6 | CORS Render 반영 확인 | ✅ 완료 |
| 7 | 이메일 인증 흐름 검토 및 설정 정리 | ✅ 완료 |
| 8 | E2E 전체 흐름 테스트 17/17 통과 | ✅ 완료 |

### 오늘 수정한 버그 전체 목록

| # | 파일 | 버그 | 수정 내용 |
|---|------|------|-----------|
| 1 | `projects/serializers.py` | `ProjectCreateSerializer` id 누락 | `SerializerMethodField` 추가 |
| 2 | `evaluations/serializers.py` | `PairwiseComparisonSerializer.validate()` PATCH 500 | `.get()` + instance fallback |
| 3 | `evaluations/serializers.py` | `EvaluationCreateSerializer` id 누락 | `UUIDField(read_only=True)` 추가 |
| 4 | `analysis/views.py` | `AnalysisViewSet` 4개 메서드 미구현 500 | `calculate_individual/group/final_priorities/project_summary` 구현 |
| 5 | `analysis/views.py` | 잘못된 UUID → `ValueError` → 500 | `(DoesNotExist, ValueError, Exception)` → 404 |
| 6 | `accounts/views.py` + `urls.py` | `/accounts/me/` 404 | `current_user_profile` FBV + 명시적 URL |
| 7 | `settings.py` | `CORS_ALLOW_ALL_ORIGINS=True` env var로 모든 origin 허용 | `False` 하드코딩 |
| 8 | `settings.py` | `ACCOUNT_EMAIL_VERIFICATION='mandatory'` allauth 500 유발 | `'none'`으로 수정 |
| 9 | `src/config/api.ts` | 엔드포인트 상수 11개 잘못됨 | 백엔드 실제 URL과 일치하도록 전면 수정 |
| 10 | `src/services/apiService.ts` | `validateAccessKey` 404 경로 | `by_token/?token=` (GET)으로 수정 |
| 11 | `src/services/apiService.ts` | `resultsAPI.*` 미존재 경로 | `/api/service/analysis/*` 실제 경로로 수정 |

### 오늘 커밋 내역 전체

#### 백엔드 (aebonlee/ahp-django-service)

| 커밋 | 내용 |
|------|------|
| `caae9a9` | fix: 통합 테스트 버그 3종 수정 (serializers + analysis views) |
| `533ede7` | fix: /me/ 엔드포인트 404 수정 |
| `d3cc26b` | fix: EvaluationCreateSerializer id 누락 수정 |
| `f810099` | security: CORS_ALLOW_ALL_ORIGINS 차단 (False 하드코딩) |
| `c960f7e` | fix: AnalysisViewSet UUID 유효성 검증 500 → 404 |
| `ed84921` | config: allauth 이메일 인증 비활성화 (베타 단계) |

#### 프론트엔드 (aebonlee/ahp_app)

| 커밋 | 내용 |
|------|------|
| `ac28eb2` | fix: api.ts 전체 엔드포인트 백엔드 URL과 일치하도록 수정 |
| `504353b` | fix: apiService.ts validateAccessKey, resultsAPI 경로 수정 |
| `4f3ebfc` | docs: 개발일지 세션 5 추가 |
| `0c7be8e` | docs: 개발일지 세션 6 추가 (CORS 확인) |
| `a3f5bd3` | docs: 개발일지 세션 7 추가 (이메일 인증) |
| `9195247` | docs: 개발일지 세션 8 추가 (E2E 테스트) |

### 최종 시스템 상태 (2026-02-19 기준)

#### 백엔드 (https://ahp-django-backend.onrender.com)

| 항목 | 상태 |
|------|------|
| 인증 (register/login/logout/me) | ✅ 정상 |
| 프로젝트 CRUD | ✅ 정상 |
| 기준(criteria) CRUD | ✅ 정상 |
| 평가 생성 및 비교쌍 입력 | ✅ 정상 |
| AHP 계산 (개인/그룹/요약) | ✅ 정상 |
| 토큰 갱신 (rotation) | ✅ 정상 |
| CORS 보안 (화이트리스트) | ✅ 정상 |
| 이메일 인증 | ⏸ 비활성화 (베타) |

#### 프론트엔드 (https://aebonlee.github.io/ahp_app)

| 항목 | 상태 |
|------|------|
| `api.ts` 엔드포인트 상수 | ✅ 백엔드 URL과 일치 |
| `authService.ts` 인증 흐름 | ✅ 정상 |
| `apiService.ts` 평가자/결과 API | ✅ 수정 완료 |
| `ahpApiService.ts` | ✅ 정상 |

---

## 남은 작업 (TODO)

### 우선순위 LOW
1. **Render.com PostgreSQL → Neon.tech 이전** ($7/월 절약)
2. **새 프로덕션 레포** 생성
