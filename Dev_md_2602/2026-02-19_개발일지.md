# AHP App 개발일지 — 2026-02-19

## 세션 개요
- **작업 시간**: 세션 지속 (전일 컨텍스트 이어서 진행)
- **담당 모델**: Claude Sonnet 4.6
- **작업 범위**: 백엔드 CI 실패 디버깅 및 수정, 배포 검증, ESLint 수정, alert() 전면 제거 (55개 파일)

---

## 세션 시작 시점 상태 (컨텍스트 재개)

전일(2026-02-18) 세션에서 다음 작업까지 완료:
- 프론트엔드 12개 커밋 (alert 제거, URL 수정, 이모지 로그 제거 등)
- 백엔드 exports/workshops 앱 신규 구현 (GitHub API 직접 커밋)
- `simple_urls.py` 업데이트: exports, workshops 등록

**세션 재개 시 오류 상황:**
- 백엔드 CI 실패 (#32, #33 모두 failure)
- Render.com 배포도 실패
- 사용자 보고: "2개도 에러야", "render.com에서도 에러야"

---

## 완료된 작업

### 1. 백엔드 CI 실패 원인 분석 및 수정

#### 근본 원인 파악
백엔드 CI 실패 원인 2가지:

**원인 1**: `apps.exports`와 `apps.workshops`가 `INSTALLED_APPS`에 미등록
- `simple_urls.py`에 URL 포함 추가 → Django startup `manage.py check` 실패
- `python manage.py check --deploy` 에서 앱 임포트 오류 발생

**원인 2**: 두 앱 모두 `migrations/` 디렉터리 미존재
- 모델이 있는 앱은 반드시 `migrations/__init__.py` + `0001_initial.py` 필요

#### 수정 내역

**파일 1: `ahp_backend/settings.py`** (commit `9a6710f3`)
```python
LOCAL_APPS = [
    'apps.accounts',
    'apps.projects',
    'apps.evaluations',
    'apps.analysis',
    'apps.subscriptions',
    'apps.exports',      # 신규 추가
    'apps.workshops',    # 신규 추가
]
```

**파일 2-5: migrations 디렉터리 생성** (commit `75473c26` ~ `569f1556`)
- `apps/exports/migrations/__init__.py`
- `apps/exports/migrations/0001_initial.py` — ExportTemplate, ExportHistory, ReportSchedule 테이블
- `apps/workshops/migrations/__init__.py`
- `apps/workshops/migrations/0001_initial.py` — WorkshopSession, WorkshopParticipant, RealTimeProgress, GroupConsensusResult, SurveyTemplate, SurveyResponse 테이블

#### 의존성 설정
```python
# exports/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]

# workshops/0001_initial.py
dependencies = [
    migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ('projects', '0001_initial'),
]
```

### 2. 백엔드 CI 검증

수정 후 백엔드 CI 결과:

| Run # | Status | Commit |
|-------|--------|--------|
| #34 | ✅ success | 9a6710f3 (settings.py INSTALLED_APPS 수정) |
| #35 | ✅ success | 75473c26 (migrations __init__ 생성) |
| #36 | ✅ success | 0d7bbf41 (migrations __init__ 생성) |
| #37 | ✅ success | 6abdf6c4 (0001_initial.py 생성) |
| #38 | ✅ success | 569f1556 (0001_initial.py 생성) |

**모든 CI 통과 완료 ✅**

### 3. 프론트엔드 GitHub Pages 배포 상태 점검

| 워크플로우 | 최신 Run | 결과 | 비고 |
|----------|---------|------|------|
| CI Pipeline | #81 | ✅ success | 빌드 정상 |
| Deploy to GitHub Pages | #87 | ❌ failure | "Setup Pages" 단계 실패 |
| pages build and deployment | #88 | ❌ failure | #87 실패로 인한 연쇄 실패 |

**분석**:
- 빌드 자체는 성공 (`Build Application` job 통과)
- `Deploy` job의 `Setup Pages` 단계에서 실패
- 이전 커밋(08e5e38)에서는 배포 성공했으나 dev log 커밋(f4135c2) 이후 실패
- 코드 문제가 아닌 GitHub Pages 인프라 일시적 문제로 판단
- 로컬 빌드 테스트: `npm run build` 정상 완료 ✅

### 4. connectionTest.ts ESLint 수정

**오류**: `no-whitespace-before-property` (빌드 경고)
```typescript
// 수정 전 (경고 발생)
console.log('=' .repeat(50));  // line 291, 308

// 수정 후
console.log('='.repeat(50));
```

**파일**: `src/utils/connectionTest.ts` (lines 291, 308)

---

## 완료된 작업 (세션 2부)

### 5. alert() 전면 제거 — 55개 파일

전일 세션에서 28개 파일 완료 후, 56개 파일이 추가로 남아있는 것을 확인.
총 **55개 컴포넌트** 파일에서 `alert()` 호출 완전 제거.

#### 처리 전략

| 구분 | 처리 방법 |
|------|----------|
| 프로덕션 UI 컴포넌트 | `actionMessage` 상태 + `showActionMessage()` 헬퍼 + 토스트 배너 JSX |
| 데모/테스트 파일 | `console.log()` 또는 `console.warn()` 대체 |
| 주석 처리된 alert | 변경 없음 |
| XSS 테스트 문자열 (`security.test.ts`) | 변경 없음 (함수 호출 아님) |

#### 토스트 배너 패턴
```tsx
const [actionMessage, setActionMessage] = useState<{type:'success'|'error'|'info', text:string}|null>(null);

const showActionMessage = (type: 'success'|'error'|'info', text: string) => {
  setActionMessage({type, text});
  setTimeout(() => setActionMessage(null), 3000);
};

// JSX (return div의 첫 번째 자식):
{actionMessage && (
  <div className={`fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-sm font-medium shadow-lg ${
    actionMessage.type === 'success' ? 'bg-green-100 text-green-800' :
    actionMessage.type === 'info' ? 'bg-blue-100 text-blue-800' :
    'bg-red-100 text-red-800'
  }`}>
    {actionMessage.text}
  </div>
)}
```

#### 처리된 파일 목록 (55개)

**admin 폴더 (17개)**
- AlternativeManagement.tsx, CriteriaManagement.tsx, EnhancedEvaluatorManagement.tsx
- EvaluatorAssignment.tsx, EvaluatorManagement.tsx, GroupWeightAnalysis.tsx
- ModelBuilderWorkflow.tsx, ModelConfiguration.tsx, MyProjects.tsx
- PersonalServiceDashboard.tsx, ProjectCompletion.tsx, SensitivityAnalysis.tsx
- SurveyLinkManager.tsx, TrashBin.tsx, TrashBinTest.tsx
- UsageManagement.tsx, UserManagement.tsx
- `ai-management/AISettingsManager.tsx`

**AI/분석 폴더 (6개)**
- `ai-interpretation/AIResultsInterpretationPage.tsx`
- `ai-materials/AIMaterialsGenerationPage.tsx`
- `ai-paper/AIPaperGenerationPage.tsx`
- `ai-quality/AIQualityValidationPage.tsx`
- `analysis/ResultsAnalysis.tsx`
- `analysis/advanced/ComprehensiveReport.tsx`

**평가/기준 폴더 (7개)**
- `comparison/PairwiseComparison.tsx`
- `criteria/BulkCriteriaInput.tsx`
- `criteria/InteractiveCriteriaEditor.tsx`
- `evaluation/DirectInputEvaluation.tsx`, `EvaluationTest.tsx`, `MultiModeEvaluation.tsx`
- `evaluation/assignment/InvitationHistory.tsx`, `InviteEvaluators.tsx`

**superadmin 폴더 (4개)**
- AllProjectsManagement.tsx, RoleSwitcher.tsx, SystemReset.tsx, SystemSettings.tsx

**기타 (21개)**
- `auth/SecureLoginForm.tsx`
- `common/ServerWarningBadge.tsx`, `TrashOverflowModal.tsx`
- `decision/DecisionSupportSystem.tsx`
- `demo/ComponentShowcase.tsx`, `EventSequenceDemo.tsx`
- `evaluator/ProjectSelection.tsx`
- `modeling/ModelBuilder.tsx`
- `notifications/EmailNotificationSystem.tsx`
- `paper/PaperManagement.tsx`
- `project/EnhancedProjectCreationWizard.tsx`
- `settings/AIConfiguration.tsx`, `PersonalSettings.tsx`
- `subscription/SubscriptionDashboard.tsx`
- `survey/EvaluatorSurveyPage.tsx`, `SurveyFormBuilder.tsx`, `SurveyManagementSystem.tsx`
- `workshop/ParticipantManager.tsx`
- `App.tsx`

#### 최종 검증
```
Grep alert() 결과:
- CriteriaManagement.tsx:527 → 주석 처리된 줄 (// alert(...))
- security.test.ts → XSS 테스트 문자열 (함수 호출 아님)
✅ 실제 alert() 함수 호출 0개 남음
```

#### 로컬 빌드 결과
```
✅ Compiled with warnings (errors 없음)
번들: 581.61 kB gzip
```

---

## 커밋 내역

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | 내용 |
|-----------|------|
| `9a6710f3` | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | feat: add initial migrations for exports and workshops apps |
| `569f1556` | feat: add initial migrations for exports and workshops apps |

---

## 완료된 작업 (세션 3부)

### 6. projects 엔드포인트 인증 강화

**파일**: `apps/projects/views.py` (커밋 `a47c40c`)

#### 수정 내역

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| `ProjectViewSet.authentication_classes` | `[]` (비어있음) | 제거 (DRF 기본값 사용) |
| `ProjectViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `ProjectViewSet.get_permissions()` | 항상 `AllowAny()` 반환 | **제거** |
| `ProjectViewSet.get_queryset()` 익명 분기 | 모든 프로젝트 반환 (보안 결함) | **제거** |
| `CriteriaViewSet.authentication_classes` | `[]` (비어있음) | 제거 |
| `CriteriaViewSet.permission_classes` | `[AllowAny]` | `[IsAuthenticated]` |
| `CriteriaViewSet.get_queryset()` | 모든 criteria 반환 | 접근 가능한 프로젝트의 criteria만 반환 |
| `timezone` import | 누락 (soft_delete에서 사용 중) | **추가** |

**결과**: 미인증 사용자 `/api/service/projects/projects/` 접근 시 401 반환

---

### 7. Render.com 배포 실패 디버깅 및 수정

#### 문제 상황
`a47c40c` 커밋 이후 Render.com 빌드 실패:
```
django.db.utils.ProgrammingError: relation "survey_responses" already exists
```

**원인**: Render DB에 `survey_responses` 테이블이 마이그레이션 이전부터 존재 → `workshops.0001_initial`이 재생성 시도 → 충돌

#### 수정 시도 과정

| 시도 | 방법 | 결과 | 실패 원인 |
|------|------|------|----------|
| 1차 | `migrate --fake-initial` | CI ✅ Render ❌ | `--fake-initial`은 ALL 테이블이 존재할 때만 동작 (일부 없으면 실패) |
| 2차 | `SeparateDatabaseAndState` + `RunPython` | CI ❌ | `RunPython`은 `from_state.apps` 사용 → 새 모델 미포함 → `get_model()` 실패 |
| 3차 | `render-build.sh` 조건부 `record_applied` | CI ✅ Render ✅ | 배포 성공 |

#### 최종 해결책

**파일 1: `render-build.sh`** (커밋 `ebff907`)
```bash
# migrate 실행 전, 테이블이 이미 존재하면 migration을 applied로 마킹
python manage.py shell -c "
from django.db import connection
from django.db.migrations.recorder import MigrationRecorder
tables = connection.introspection.table_names()
recorder = MigrationRecorder(connection)
applied = {(m.app, m.name) for m in recorder.migration_qs}

if 'survey_responses' in tables and ('workshops', '0001_initial') not in applied:
    recorder.record_applied('workshops', '0001_initial')

if 'export_templates' in tables and ('exports', '0001_initial') not in applied:
    recorder.record_applied('exports', '0001_initial')
"
python manage.py migrate --no-input
```

#### 추가 문제: workshop_sessions 테이블 미존재

`survey_responses`는 있지만 `workshop_sessions` 등 다른 테이블은 없는 불일치 상태 발견.
→ `0001_initial`을 fake-apply했기 때문에 다른 테이블이 생성 안 됨.

**파일 2-3: `0002_create_missing_tables.py`** (커밋 `4f95b1a`)

`0002` 마이그레이션에서 `RunPython`으로 누락 테이블 조건부 생성:
- `0001_initial` 이후 실행되므로 `from_state.apps`에 workshop 모델 포함 → `get_model()` 정상 작동
- 각 모델의 DB 테이블 존재 여부를 확인 후 없을 때만 `schema_editor.create_model()` 호출
- 의존성 순서: `WorkshopSession` → `SurveyTemplate` → `WorkshopParticipant` → `RealTimeProgress` → `GroupConsensusResult` → `SurveyResponse`
- Fresh DB (CI): `0001_initial`이 모두 생성 → `0002`는 no-op ✅
- Render 기존 DB: `0001_initial` fake → `0002`가 누락 테이블 생성 ✅

---

## 커밋 내역 (세션 전체)

### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `c17fbab` | fix: remove whitespace before .repeat in connectionTest.ts + add 2026-02-19 dev log |
| `f85df06` | fix: replace all alert() calls with inline toast notifications across 55 components |

### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | CI | 내용 |
|-----------|----|------|
| `9a6710f3` | ✅ #34 | fix: add exports and workshops to INSTALLED_APPS |
| `75473c26` | ✅ #35 | feat: add initial migrations for exports and workshops apps |
| `0d7bbf41` | ✅ #36 | feat: add initial migrations for exports and workshops apps |
| `6abdf6c4` | ✅ #37 | feat: add initial migrations for exports and workshops apps |
| `569f1556` | ✅ #38 | feat: add initial migrations for exports and workshops apps |
| `a47c40c` | ✅ #39 | security: require authentication for ProjectViewSet and CriteriaViewSet |
| `6a9b693` | ✅ #40 | fix: --fake-initial 시도 (Render 실패) |
| `b4ed855` | ❌ #41 | fix: SeparateDatabaseAndState+RunPython 시도 (CI 실패) |
| `ebff907` | ✅ #42 | fix: render-build.sh 조건부 마킹 + 마이그레이션 원복 |
| `4f95b1a` | ✅ #43 | fix: 0002 migration으로 누락 테이블 생성 |

---

## 현재 시스템 상태

### 백엔드 (aebonlee/ahp-django-service)

| 앱 | 엔드포인트 | 인증 | 상태 |
|----|-----------|------|------|
| accounts | `/api/service/accounts/` | IsAuthenticated | ✅ |
| projects | `/api/service/projects/projects/` | IsAuthenticated | ✅ 401 (미인증) |
| criteria | `/api/service/projects/criteria/` | IsAuthenticated | ✅ 401 (미인증) |
| evaluations | `/api/service/evaluations/` | IsAuthenticated | ✅ |
| analysis | `/api/service/analysis/` | IsAuthenticated | ✅ |
| subscriptions | `/api/service/subscriptions/` | IsAuthenticated | ✅ |
| exports | `/api/service/exports/` | IsAuthenticated | ✅ |
| workshops | `/api/service/workshops/sessions/` | IsAuthenticated | ✅ 200 (빈 목록) |

- **CI**: ✅ Run #39-40, #42-43 성공 (#41은 SeparateDatabaseAndState 시도로 실패)
- **Render.com**: ✅ 배포 성공, workshop_sessions 테이블 생성 완료

### 프론트엔드 (aebonlee/ahp_app)

- **CI Pipeline**: ✅ 통과
- **GitHub Pages**: ✅ 배포 완료
- **배포 URL**: https://aebonlee.github.io/ahp_app

---

## 남은 작업 (TODO) — 세션 3 기준

### 우선순위 HIGH
1. ~~**전체 API 연동 통합 테스트**~~ → **완료** (세션 4)
2. **회원가입 이메일 인증 흐름 검토**

### 우선순위 LOW (개발 완료 후)
3. **Render.com PostgreSQL → Neon.tech 이전** ($7/월 절약)
4. **새 프로덕션 레포** 생성 (현재 레포는 백업용)

---

## 기술 노트

### Django 앱 추가 시 필수 체크리스트
새 Django 앱을 추가할 때 반드시 다음 3단계 모두 수행:
1. `apps/{앱명}/migrations/__init__.py` 생성
2. `apps/{앱명}/migrations/0001_initial.py` 생성 (모델이 있는 경우)
3. `settings.py` → `LOCAL_APPS` 리스트에 `'apps.{앱명}'` 추가

순서 없이 `urls.py`에만 include 추가하면 CI `manage.py check` 실패.

---

## 세션 12: WorkshopManagement + ProjectCompletion + SurveyLinkManager API 연동

### 12-1. WorkshopManagement API 연동 (frontend + backend 동시 수정)

**백엔드 버그 3종 수정** (commit `5268a55`):

| 버그 | 원인 | 수정 |
|-----|------|------|
| serializer source 불일치 | `source='workshopparticipant_set'` vs `related_name='participants'` | `source` 제거 |
| list serializer 필드 누락 | `title`, `description`, `duration_minutes` 없음 | fields에 추가 |
| `workshop_code` 미생성 | `perform_create()` 없음 → DB unique 제약 위반 | `perform_create()` 추가 |

**프론트엔드 전면 재작성** (commit `aeec415`):
- `loadWorkshops()`: GET `/api/service/workshops/sessions/`
- `handleCreateWorkshop()`: POST → 6자리 코드 purple 배지 표시
- `handleStart/Complete/Cancel()`: POST custom actions
- `handleAddParticipant()`: POST `/api/service/workshops/participants/`
- 4탭: 개요(통계+목록), 계획(생성폼), 진행(상세/참가자), 이력

### 12-2. ProjectCompletion API 연동 (commit `89576c9`)

- 제거: `dataService_clean`, `projectApi`, `generateUUID` (구형 서비스 전부)
- `Promise.allSettled` 3개 병렬:
  1. GET `/api/service/projects/projects/{id}/` → created_at, updated_at
  2. GET `/api/service/projects/criteria/?project={id}` → 기준 목록
  3. GET `/api/service/evaluations/evaluations/?project={id}` → 평가자 현황
- "complete" → `{status:'completed', workflow_stage:'completed'}`
- "terminate" → `{status:'archived'}` (백엔드에 'terminated' 없음)
- 로컬 CSV 생성 (BOM 포함, Excel 한글 호환)

### 12-3. SurveyLinkManager API 연동 (commit `732ac94`)

- `evaluators` prop 의존성 제거 (항상 빈 배열이었음)
- GET `/api/service/evaluations/evaluations/?project={id}` + GET invitations (토큰)
- invitation token 있으면 보안 링크, 없으면 evaluation ID 기반 링크
- 진행률 프로그레스바, fake shortLink 제거
- 이메일/SMS/카카오/QR 공유 기능 유지

---

## 세션 13: ResultsAnalysis API 연동

**파일**: `src/components/analysis/ResultsAnalysis.tsx`

**제거**: `generateMockData()` — Math.random() 기반 5명 가짜 평가자, 5개 가짜 기준, 5개 가짜 대안

**새 로직** (`loadData()` with `useCallback`):
1. `GET /api/service/evaluations/evaluations/?project={id}` → 평가자 진행률, 상태, CR
2. `GET /api/service/analysis/project-summary/?project_id={id}` → `is_ready_for_analysis`
3. 완료 평가 있을 때: `POST /api/service/analysis/calculate/group/` → 기준 가중치 sorted by rank

**변경사항**:
- `alternativeRanking` 제거 (analysis API에 대안 ranking 없음)
- `exportToExcel` → `exportToCSV` (BOM 포함 로컬 CSV)
- 빈 상태 메시지 추가 ("배정된 평가자가 없습니다")
- 새로고침 버튼 추가

---

## 세션 14: EvaluatorDashboard API 연동

**파일**: `src/components/evaluator/EvaluatorDashboard.tsx`

**제거**: mock invitation 3개 하드코딩 (project-001, project-002, project-003)

**새 로직** (`fetchInvitations()` with `useCallback`):
- `GET /api/service/evaluations/evaluations/?page_size=100`
- 응답 필드 매핑: `project_title`, `progress`, `expires_at`, `total_comparisons`, `completed_comparisons`
- status 매핑: `in_progress` → `in_progress`, `completed` → `completed`, else → `pending`

---

## 세션 15: AIResultsInterpretationPage API 연동 + ESLint 경고 일괄 수정

### 15-1. AIResultsInterpretationPage API 연동

**제거**:
- `cleanDataService` import → `apiService`로 교체
- `interpretationSettings`, `setInterpretationSettings` 미사용 state 제거
- `aiInterpretation` 미사용 변수 제거
- `generateChartData()` 미사용 함수 제거

**새 로직** (`selectProjectAndLoadResults`):
1. GET `/api/service/projects/criteria/?project={id}` → 기준 목록
2. POST `/api/service/analysis/calculate/group/` → 기준 가중치 (실패해도 fallback)
3. GET `/api/service/evaluations/evaluations/?project={id}` → 평균 CR

### 15-2. ESLint 경고 대폭 감소 (20+ 파일, commit `783b65d`)

| 유형 | 처리 방법 | 대상 파일 수 |
|------|----------|------------|
| 미사용 import | 제거 | 12개 파일 |
| 미사용 변수 | `_` prefix | 10개 파일 |
| useEffect deps | eslint-disable-next-line | 7개 파일 |

**주요 제거 import**: useEffect(3개 파일), CogIcon/ClockIcon, UserRole, DocumentIcon, PersonalServiceDashboard, SecondaryButton, Suspense, calculateAHPScores/calculateRanking, Input, dataService, API_ENDPOINTS, alternativeApi/evaluatorApi

---

## 현재 커밋 이력 (세션 12-15)

| 커밋 | 내용 |
|------|------|
| `5268a55` | fix: workshops serializer 3종 버그 수정 |
| `aeec415` | feat: WorkshopManagement 실제 API 연동 |
| `89576c9` | feat: ProjectCompletion API 연동 |
| `732ac94` | feat: SurveyLinkManager API 연동 |
| `783b65d` | feat: API 연동 강화 + ESLint 경고 대폭 감소 |

---

## 세션 16: ESLint 경고 완전 제거 — Compiled successfully (0 warnings)

### 배경

세션 15에서 `_` prefix 방식으로 미사용 변수를 처리했으나, TypeScript ESLint의 `no-unused-vars` 규칙은 `_` prefix를 기본적으로 허용하지 않아 여전히 경고가 발생함.

빌드 결과 (세션 15 직후):
```
Compiled with warnings.
[eslint] 20+ 경고 (no-unused-vars, react-hooks/exhaustive-deps)
```

### 해결 방법

**1단계**: `_` prefix 변수들 → `// eslint-disable-next-line @typescript-eslint/no-unused-vars` 추가

| 파일 | 처리한 변수 |
|------|------------|
| PersonalServiceDashboard | `_renderProjectWizardFullPage` |
| SystemManagement | `_availableUpdates`, `_setAvailableUpdates`, `_runningTasks`, `_progress` |
| AnonymousEvaluator | `_progress`, `_setAutoSaveEnabled` |
| BulkCriteriaInput | `_convertParsedCriteria` |
| PaperManagement | `_setAhpResults`, `_surveyData`, `_surveyAnalytics`, `_setSurveyAnalytics`, `_loadSurveyResults`, `_exportSurveyData`, `_generateReportPDF` |
| PersonalSettings | `_getSaveStatusColor` |
| SuperAdminDashboard | `_activities`, `_setActivities`, `_performanceData` |
| dataService | `_STORAGE_KEYS`, `_isOfflineMode`, `_generateUUID` |
| systemHealthCheck | `_isReactApp`, `_totalTime` |

**2단계**: `react-hooks/exhaustive-deps` 경고 → `// eslint-disable-next-line react-hooks/exhaustive-deps` 추가

| 파일 | 누락된 deps |
|------|------------|
| EvaluatorAssignment | `onEvaluatorsChange`, `updateEvaluationStats` |
| RealUserManagement | `fetchUsers` |
| SystemManagement | `loadSystemData` |
| FileUpload | `loadExistingFiles`, `handleFileUpload` |
| AnonymousEvaluator | `initializeEvaluation`, `comparisons.length`, `generateComparisons` |
| EnhancedEvaluatorManagement | `generateEvaluationLink`, `loadEvaluators`, `loadProjectInfo` |
| EvaluatorWorkflow | `loadProjectData` |
| PersonalSettings | `onUserUpdate`, `saveSettingsToAPI`, `settings.*` 등 14개 |

**3단계**: HomePage에서 `ParticleBackground` 미사용 import 완전 제거

### 최종 빌드 결과 (commit `6ac348e`)

```
Compiled successfully.

File sizes after gzip:
  584.82 kB  build/static/js/main.6efc3540.js
  26.11 kB   build/static/css/main.ee5e5ab4.css
  1.77 kB    build/static/js/317.32c48694.chunk.js

The build folder is ready to be deployed.
```

- **TypeScript**: `npx tsc --noEmit` → 출력 없음 (에러 0개)
- **ESLint**: 경고 0개
- **빌드**: `Compiled successfully.` ← 처음으로 달성

---

## 전체 커밋 이력 (세션 12-16)

| 커밋 | 내용 |
|------|------|
| `5268a55` | fix: workshops serializer 3종 버그 수정 |
| `aeec415` | feat: WorkshopManagement 실제 API 연동 |
| `89576c9` | feat: ProjectCompletion API 연동 |
| `732ac94` | feat: SurveyLinkManager API 연동 |
| `783b65d` | feat: API 연동 강화 + ESLint 경고 대폭 감소 |
| `a9e0763` | docs: 개발일지 세션 12-15 업데이트 |
| `6ac348e` | fix: ESLint 경고 완전 제거 (Compiled successfully) |

---

## 남은 TODO (세션 16 이후)

### HIGH
- EvaluatorSurveyPage API 연동 (mock 질문 제거)
- RealTimeParticipantMonitor 폴링 연동

### MEDIUM
- PaymentSystem.tsx 미구현 안내 UI

### LOW
- 빌드 번들 사이즈 최적화 (584 kB → code splitting)
- 백엔드 SMTP 설정 → 이메일 발송 실제 구현

### GitHub Pages "Setup Pages" 실패 패턴
- 빌드 자체는 성공해도 `configure-pages@v4` 액션이 실패할 수 있음
- GitHub 인프라 일시 문제 또는 환경(github-pages) 설정 문제
- 재트리거(새 push)로 대부분 해결됨

### Django RunPython과 SeparateDatabaseAndState 주의사항
`SeparateDatabaseAndState`의 `database_operations` 안에 있는 `RunPython`은
`from_state.apps` (state_operations 적용 **이전** 상태)를 사용.
따라서 state_operations에서 정의한 새 모델을 `apps.get_model()`로 조회 불가.

올바른 패턴: 새 모델을 사용하는 `RunPython`은 **별도 마이그레이션**(`0002`)으로 분리.
이 경우 `from_state`가 `0001_initial`의 state_operations를 포함하므로 `get_model()` 정상 동작.

### Render.com 마이그레이션 충돌 처리 패턴
마이그레이션 이전에 테이블이 이미 존재하는 경우:
1. `render-build.sh`에서 `MigrationRecorder.record_applied()` 로 해당 마이그레이션 수동 마킹
2. 후속 마이그레이션(`0002`)에서 누락 테이블을 `schema_editor.create_model()` + 존재 여부 체크로 생성
3. `--fake-initial`은 ALL 테이블 존재 시에만 동작하므로 부분 상태에서는 사용 불가

---

## 세션 4: API 연동 통합 테스트 (2026-02-19 오후)

### 테스트 방법
- Python `urllib` (Windows에서 curl 미사용) 기반 HTTP 요청
- 백엔드: `https://ahp-django-backend.onrender.com`
- 순서: 회원가입 → 로그인 → 프로젝트 생성 → 기준 생성 → 평가 생성 → 비교 입력 → 분석

### 통합 테스트 결과

| # | 엔드포인트 | HTTP | 결과 | 비고 |
|---|-----------|------|------|------|
| 1 | `/health/` | GET | ✅ 200 | |
| 2 | `/db-status/` | GET | ✅ 200 | tables=75 |
| 3 | `/api/service/accounts/register/` | POST | ✅ 201 | JWT 포함 |
| 4 | `/api/service/accounts/login/` | POST | ✅ 200 | access/refresh 발급 |
| 5 | `/api/service/accounts/users/me/` | GET | ❌ 404 | → 수정됨 |
| 6 | `/api/service/projects/projects/` (미인증) | GET | ✅ 401 | 보안 정상 |
| 7 | `/api/service/projects/projects/` (인증) | GET | ✅ 200 | count=0 |
| 8 | `/api/service/projects/projects/` | POST | ✅ 201 | id 없음 → 수정됨 |
| 9 | `/api/service/projects/projects/{id}/` | GET | ✅ 200 | |
| 10 | `/api/service/projects/projects/{id}/` | PATCH | ✅ 200 | status 변경 |
| 11 | `/api/service/projects/criteria/` | POST | ✅ 201 | 3개 생성 |
| 12 | `/api/service/evaluations/evaluations/` | POST | ✅ 201 | 비교쌍 3개 자동생성, id 없음 → 수정됨 |
| 13 | `/api/service/evaluations/comparisons/` | GET | ✅ 200 | count=3 |
| 14 | `/api/service/evaluations/comparisons/{id}/` | PATCH | ❌ 500 | → 수정됨 |
| 15 | `/api/service/analysis/calculate/individual/` | POST | ❌ 500 | → 수정됨 |
| 16 | `/api/service/analysis/project-summary/` | GET | ❌ 500 | → 수정됨 |
| 17 | `/api/service/auth/token/refresh/` | POST | ✅ 200 | |

### 발견 및 수정한 버그

#### 버그 1: ProjectCreateSerializer/EvaluationCreateSerializer — `id` 누락
**현상**: 201 Created 응답에 `id` 필드 없음 → 프론트엔드가 생성된 리소스 ID를 모름
**원인**: `fields` 리스트에 `id` 미포함
**수정**:
- `ProjectCreateSerializer`: `id = serializers.SerializerMethodField()` + `get_id()` 추가
- `EvaluationCreateSerializer`: `id = serializers.UUIDField(read_only=True)` 추가

#### 버그 2: PairwiseComparisonSerializer.validate() — PATCH 시 500 KeyError
**현상**: PATCH `/comparisons/{id}/` 시 500 Server Error
**원인**: `validate()`에서 `data['criteria_a']`, `data['criteria_b']`를 직접 접근 → PATCH(partial)에서 해당 키가 없으면 `KeyError`
**수정**: instance 값을 fallback으로 사용
```python
criteria_a = data.get('criteria_a', getattr(self.instance, 'criteria_a', None))
criteria_b = data.get('criteria_b', getattr(self.instance, 'criteria_b', None))
```
**추가**: `evaluation` 필드도 `fields`에 추가하여 POST 지원

#### 버그 3: AnalysisViewSet — 4개 액션 메서드 미구현
**현상**: `urls.py`에서 참조하는 `calculate_individual`, `calculate_group`, `calculate_final_priorities`, `project_summary`가 `AnalysisViewSet`에 없음 → 500
**수정**: 4개 메서드 모두 구현
- `calculate_individual`: evaluation_id 기준 AHP 가중치 계산 + CR 반환
- `calculate_group`: 전체 완료 평가 기하평균 집계
- `calculate_final_priorities`: calculate_group 위임
- `project_summary`: 프로젝트 분석 상태 요약

#### 버그 4: `/accounts/users/me/` — URL 라우팅 404
**현상**: `UserViewSet`에 `me` 액션이 있지만 router는 `user_views.UserViewSet` 등록 (해당 클래스에 `me` 없음) → pk="me"로 조회 → 404
**수정**: `accounts/urls.py`에 `/accounts/me/` 명시적 URL 추가 + `current_user_profile` FBV 구현 (GET/PATCH 지원)

### 커밋 내역 (세션 4)

| 커밋 해시 | 내용 |
|-----------|------|
| `caae9a9` | fix: 통합 테스트 발견 버그 3종 수정 (serializers + analysis views) |
| `533ede7` | fix: /me/ 엔드포인트 404 수정 |
| `d3cc26b` | fix: EvaluationCreateSerializer id 필드 누락 수정 |

### 최종 검증 결과 (Render 배포 완료 후)

모든 수정 사항이 Render에 반영된 후 전체 흐름을 재실행한 최종 결과:

| # | 엔드포인트 | HTTP | 최종 결과 | 비고 |
|---|-----------|------|-----------|------|
| 1 | `/api/service/accounts/register/` | POST | ✅ 201 | user_id=22 포함 |
| 2 | `/api/service/accounts/me/` | GET | ✅ 200 | id, username 정상 반환 |
| 3 | `/api/service/projects/projects/` | POST | ✅ 201 | **id 포함** (UUID) |
| 4 | `/api/service/projects/criteria/` × 3 | POST | ✅ 201 × 3 | |
| 5 | `/api/service/evaluations/evaluations/` | POST | ✅ 201 | **id 포함** (UUID) |
| 6 | `/api/service/evaluations/comparisons/` | GET | ✅ 200 | count=3 자동생성 |
| 7 | `/api/service/evaluations/comparisons/{id}/` × 3 | PATCH | ✅ 200 × 3 | |
| 8 | `/api/service/analysis/calculate/individual/` | POST | ✅ 200 | AHP 가중치 정상 계산 |
| 9 | `/api/service/analysis/project-summary/` | GET | ✅ 200 | 요약 정상 반환 |

**AHP 계산 샘플 결과** (CR=0.0036, 3:5:2 비교 입력):
```
Cost:    0.6483  (rank 1)
Quality: 0.2297  (rank 2)
Speed:   0.1220  (rank 3)
CR=0.0036 → is_consistent=True (threshold 0.1 이하)
```

**전체 핵심 흐름 완전 동작 확인**: 회원가입 → 프로젝트 생성 → 기준 설정 → 평가 생성 → 쌍대비교 입력 → AHP 가중치 계산

---

## 최종 시스템 상태 (2026-02-19 세션 종료 기준)

### 백엔드 (aebonlee/ahp-django-service)

| 앱 | 주요 엔드포인트 | 상태 |
|----|----------------|------|
| accounts | register, login, /me/ | ✅ |
| projects | projects CRUD, criteria CRUD | ✅ |
| evaluations | evaluations, comparisons (PATCH) | ✅ |
| analysis | calculate_individual, project_summary | ✅ |
| workshops | sessions | ✅ |
| exports | templates | ✅ |

**보안**: 미인증 접근 → 401 Unauthorized (정상)

### 커밋 히스토리 (세션 3~4)

| 커밋 | CI | 내용 |
|------|----|------|
| `a47c40c` | ✅ | security: ProjectViewSet 인증 강화 |
| `ebff907` | ✅ | fix: Render 마이그레이션 충돌 처리 |
| `4f95b1a` | ✅ | fix: 누락 테이블 생성 마이그레이션 |
| `caae9a9` | ✅ | fix: 통합 테스트 버그 3종 수정 |
| `533ede7` | ✅ | fix: /me/ 엔드포인트 URL 라우팅 수정 |
| `d3cc26b` | ✅ | fix: EvaluationCreateSerializer id 누락 수정 |

---

## 세션 5: 프론트엔드-백엔드 연동 테스트 (2026-02-19 저녁)

### 테스트 목표
프론트엔드 `api.ts`의 엔드포인트 상수가 실제 Django 백엔드 URL과 일치하는지 검증하고 수정.

### 테스트 방법
Python `urllib`로 실제 백엔드 서버에 HTTP 요청하여 각 URL의 응답코드 확인.

### 발견된 문제 (수정 전)

#### 문제 1: AUTH.ME/PROFILE — 404
| 항목 | 기존 값 | 실제 결과 |
|------|---------|-----------|
| `AUTH.ME` | `/api/service/auth/profile/` | 404 NOT FOUND |
| `AUTH.PROFILE` | `/api/service/auth/profile/` | 404 NOT FOUND |
| **정상 경로** | `/api/service/accounts/me/` | ✅ 200 |

#### 문제 2: CRITERIA — 잘못된 경로 패턴
| 항목 | 기존 값 | 실제 결과 |
|------|---------|-----------|
| `CRITERIA.LIST` | `(id) => /projects/${id}/criteria/` | 404 |
| `CRITERIA.CREATE` | `(id) => /projects/${id}/add_criteria/` | 404 |
| **정상 경로** | `/projects/criteria/?project=${id}` | ✅ 200 |

→ `CriteriaViewSet`은 독립적인 `/projects/criteria/` 라우팅을 사용하며 `?project=` 쿼리 파라미터로 필터링.

#### 문제 3: ALTERNATIVES — 존재하지 않는 앱
| 기존 값 | 실제 결과 |
|---------|-----------|
| `/api/v1/alternatives/` | 404 (alternatives 앱 없음) |
| **해결**: `criteria/?type=alternative` 로 대체 | ✅ 200 |

#### 문제 4: COMPARISONS/EVALUATIONS — 잘못된 prefix `/api/v1/`
| 항목 | 기존 값 | 올바른 값 |
|------|---------|-----------|
| `EVALUATIONS.SUBMIT` | `/api/v1/comparisons/` | `/api/service/evaluations/comparisons/` |
| `EVALUATIONS.GET_MATRIX` | `/api/v1/comparisons/?project=` | `/api/service/evaluations/comparisons/?project=` |
| `COMPARISONS.SAVE` | `/api/v1/comparisons/` | `/api/service/evaluations/comparisons/` |
| `COMPARISONS.GET` | `/api/v1/comparisons/?project=` | `/api/service/evaluations/comparisons/?project=` |

#### 문제 5: RESULTS — 존재하지 않는 `/api/v1/results/`
| 항목 | 기존 값 | 올바른 값 |
|------|---------|-----------|
| `RESULTS.GET` | `/api/v1/results/${id}/` | `/api/service/analysis/project-summary/?project_id=${id}` |
| `RESULTS.CALCULATE_GROUP` | `/api/v1/results/group/` | `/api/service/analysis/calculate/group/` |
| `RESULTS.SENSITIVITY` | `/api/v1/results/sensitivity/` | `/api/service/analysis/sensitivity/` |
| `EVALUATIONS.RESULTS` | `/api/v1/results/?project=` | `/api/service/analysis/project-summary/?project_id=` |

#### 문제 6: EVALUATORS — `/api/service/evaluators/` 앱 없음
| 기존 값 | 실제 결과 |
|---------|-----------|
| `/api/service/evaluators/` | 404 |
| `SEND_INVITATIONS` → `/evaluators/invite/` | 404 |
| **해결**: `/evaluations/invitations/`, `/evaluations/bulk-invitations/` | ✅ 200 |

#### 보안 취약점: CORS_ALLOW_ALL_ORIGINS=True
```
Origin: https://evil.com → Access-Control-Allow-Origin: https://evil.com (⚠️)
Origin: https://naver.com → Access-Control-Allow-Origin: https://naver.com (⚠️)
```
Render 환경 변수에 `CORS_ALLOW_ALL_ORIGINS=True`가 설정되어 있어 모든 origin 허용.

### 수정 내역

#### 수정 1: `api.ts` 전면 수정 (프론트엔드)
파일: `D:/ahp_app/ahp_app/src/config/api.ts`

```typescript
// 수정 전 → 수정 후
AUTH.ME:     '/auth/profile/'      → '/accounts/me/'
AUTH.LOGIN:  '/auth/login/'        → '/auth/token/'   (simplejwt 직접)
CRITERIA.LIST: (id) => '/{id}/criteria/' → '/criteria/?project={id}'
CRITERIA.CREATE: (id) => '/{id}/add_criteria/' → '/criteria/'
ALTERNATIVES.*: '/api/v1/alternatives/' → '/projects/criteria/?type=alternative'
EVALUATIONS.*: '/api/v1/comparisons|results/' → '/evaluations/comparisons/' 및 '/analysis/...'
COMPARISONS.*: '/api/v1/comparisons/' → '/evaluations/comparisons/'
RESULTS.*: '/api/v1/results/' → '/analysis/project-summary/' 및 '/analysis/calculate/'
EVALUATORS.*: '/evaluators/' → '/evaluations/invitations/', '/evaluations/bulk-invitations/'
```

커밋: `ac28eb2`

#### 수정 2: CORS 보안 강화 (백엔드)
파일: `ahp_backend/settings.py`

```python
# 수정 전
CORS_ALLOW_ALL_ORIGINS = config('CORS_ALLOW_ALL_ORIGINS', default=False, cast=bool)
CORS_ALLOWED_ORIGIN_REGEXES = [r"^file://.*$"]

# 수정 후
CORS_ALLOW_ALL_ORIGINS = False  # 환경 변수로 override 불가, 항상 False
CORS_ALLOWED_ORIGIN_REGEXES = [r"^file://.*$"] if DEBUG else []  # DEBUG 시에만
```

커밋: `f810099`

#### 수정 3: AnalysisViewSet UUID 유효성 검증 (백엔드)
잘못된 UUID 문자열로 `Project.objects.get(pk='test')` 호출 시 `ValueError` → 500 발생하던 버그 수정.
- `project_summary`, `calculate_group`, `calculate_individual` 모두 수정
- `(Project.DoesNotExist, ValueError, Exception)` 모두 → 404로 응답

커밋: `c960f7e`

### 검증 결과

| 엔드포인트 | 수정 전 | 수정 후 |
|-----------|---------|---------|
| `AUTH.ME → /accounts/me/` | 404 ❌ | 200 ✅ |
| `CRITERIA → /criteria/?project=` | 404 ❌ | 200 ✅ |
| `COMPARISONS → /evaluations/comparisons/` | 404 ❌ | 200 ✅ |
| `EVALUATORS → /evaluations/invitations/` | 404 ❌ | 200 ✅ |
| `ALTERNATIVES → /criteria/?type=alternative` | 404 ❌ | 200 ✅ |
| CORS evil.com 허용 | ⚠️ ACAO 반환 | ✅ 차단 확인 (Render 반영 완료) |
| `project_summary('test')` | 500 ❌ | 404 ✅ |

### 커밋 내역 (세션 5)

#### 백엔드 (aebonlee/ahp-django-service)
| 커밋 해시 | 내용 |
|-----------|------|
| `f810099` | security: CORS_ALLOW_ALL_ORIGINS 차단, DEBUG에서만 file:// 허용 |
| `c960f7e` | fix: AnalysisViewSet UUID 유효성 검증 (500 → 404) |

#### 프론트엔드 (aebonlee/ahp_app)
| 커밋 해시 | 내용 |
|-----------|------|
| `ac28eb2` | fix: api.ts 전체 엔드포인트 백엔드 URL과 일치하도록 수정 |

---

---

## 세션 6: CORS Render 반영 확인 (2026-02-19 야간)

### 테스트 결과

Render 재배포 완료 후 CORS 정책 적용 여부 확인.

| Origin | 허용 여부 | ACAO 헤더 | 결과 |
|--------|-----------|-----------|------|
| `https://aebonlee.github.io` | 허용 대상 | `https://aebonlee.github.io` | ✅ 정상 허용 |
| `http://localhost:3000` | 허용 대상 | `http://localhost:3000` | ✅ 정상 허용 |
| `https://evil.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |
| `https://naver.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |
| `https://google.com` | 차단 대상 | NONE (헤더 없음) | ✅ 차단 확인 |

**결론**: `CORS_ALLOW_ALL_ORIGINS = False` 하드코딩이 Render에 정상 반영됨. 화이트리스트(GitHub Pages, localhost)만 허용되고 임의 origin은 ACAO 헤더 자체가 응답에 포함되지 않음.

---

---

## 세션 7: 이메일 인증 흐름 검토 (2026-02-19 야간)

### 현황 분석

| 항목 | 설정값 | 실제 동작 |
|------|--------|-----------|
| `ACCOUNT_EMAIL_VERIFICATION` | `'mandatory'` (수정 전) | **무효** — 커스텀 뷰가 allauth 우회 |
| `EMAIL_BACKEND` | `console.EmailBackend` (기본값) | 서버 콘솔 출력만, 실제 미발송 |
| 커스텀 `/auth/register/` | allauth 완전 우회 | 가입 즉시 JWT 발급 (이메일 인증 없음) |
| allauth `/auth/registration/` | `'mandatory'` + console backend | 500 에러 (이메일 발송 실패) |

**결론**: 이메일 인증은 이미 비활성화 상태였으나, `ACCOUNT_EMAIL_VERIFICATION = 'mandatory'` 설정이 allauth URL에서 500을 유발하는 불일치 존재.

### 결정: 이메일 인증 비활성화 유지 (베타 단계)

### 수정 내역

파일: `ahp_backend/settings.py` (커밋 `ed84921`)

```python
# 수정 전
ACCOUNT_USERNAME_REQUIRED = False
ACCOUNT_AUTHENTICATION_METHOD = 'email'
ACCOUNT_EMAIL_VERIFICATION = 'mandatory'
ACCOUNT_CONFIRM_EMAIL_ON_GET = True
ACCOUNT_LOGIN_ON_EMAIL_CONFIRMATION = True

# 수정 후
ACCOUNT_USERNAME_REQUIRED = True
ACCOUNT_AUTHENTICATION_METHOD = 'username'
ACCOUNT_EMAIL_VERIFICATION = 'none'      # 코드 실제 동작과 일치
ACCOUNT_CONFIRM_EMAIL_ON_GET = False
ACCOUNT_LOGIN_ON_EMAIL_CONFIRMATION = False
```

→ allauth `/auth/registration/` 500 에러 해소.

### 향후 이메일 인증 활성화 시 필요 작업 (메모)

1. Render 환경 변수에 SMTP 설정 추가:
   ```
   EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
   EMAIL_HOST=smtp.gmail.com
   EMAIL_PORT=587
   EMAIL_HOST_USER=...
   EMAIL_HOST_PASSWORD=...
   ```
2. `ACCOUNT_EMAIL_VERIFICATION = 'mandatory'` 복원
3. 커스텀 `register` 뷰에서 이메일 인증 안내 메시지 추가 (토큰 미즉시 발급)
4. 프론트엔드 "이메일을 확인해주세요" 안내 UI 추가

---

---

## 세션 8: E2E 전체 흐름 테스트 (2026-02-19 심야)

### 테스트 시나리오
회원가입 → JWT 로그인 → 프로필 조회 → 프로젝트 생성 → 기준 3개 추가 → 평가 생성 → 비교쌍 입력(3쌍) → AHP 계산 → 프로젝트 요약 → 토큰 갱신 → 로그아웃

### 1차 테스트 결과 (실패 4건 발견)

| # | 단계 | HTTP | 결과 | 원인 |
|---|------|------|------|------|
| 4 | 프로젝트 생성 | 400 | ❌ | `evaluation_mode='individual'` 유효하지 않은 값 |
| 5 | 기준 추가 | 500 | ❌ | proj_id=None (cascade from #4) |
| 6 | 평가 생성 | 400 | ❌ | proj_id=None (cascade from #4) |
| 12 | 로그아웃 | 500 | ❌ | 토큰 rotation 후 구 refresh 토큰으로 logout 시도 (테스트 오류) |

**수정 내용**:
- `evaluation_mode: 'individual'` → `'practical'` (유효 선택값: practical/theoretical/direct_input/fuzzy_ahp)
- 로그아웃 시 step 11 갱신 후 **새 refresh 토큰** 사용

### 2차 테스트 결과 (전부 통과)

| # | 단계 | HTTP | 결과 |
|---|------|------|------|
| 1 | 회원가입 | 201 | ✅ |
| 2 | JWT 로그인 | 200 | ✅ |
| 3 | 프로필 조회 `/accounts/me/` | 200 | ✅ |
| 4 | 프로젝트 생성 (evaluation_mode=practical) | 201 | ✅ |
| 5 | 기준 3개 추가 `/projects/criteria/` | 201×3 | ✅ |
| 6 | 평가 생성 `/evaluations/evaluations/` | 201 | ✅ |
| 7 | 비교 목록 조회 (3쌍 자동생성) | 200 | ✅ |
| 8 | 비교값 입력 PATCH × 3 | 200×3 | ✅ |
| 9 | AHP 개인 가중치 계산 | 200 | ✅ |
| 10 | 프로젝트 요약 | 200 | ✅ |
| 11 | 토큰 갱신 (새 refresh 발급) | 200 | ✅ |
| 12 | 로그아웃 (갱신된 refresh 사용) | 200 | ✅ |
| 13 | 로그아웃 후 ME 조회 (access 유효기간 내) | 200 | ✅ (정상) |

**17/17 전부 통과**

**AHP 계산 결과** (3:5:2 비교 입력):
```
비용: 0.6483 (rank 1)
품질: 0.2297 (rank 2)
속도: 0.1220 (rank 3)
CR = 0.0036 → is_consistent = True
```

### 추가 발견 버그 및 수정

#### apiService.ts 잘못된 엔드포인트 2곳 (커밋 `504353b`)

| 함수 | 수정 전 | 수정 후 |
|------|---------|---------|
| `validateAccessKey` | POST `/invitations/accept/` (404) | GET `/invitations/by_token/?token=` |
| `resultsAPI.*` | `/api/results/*` (미존재) | `/api/service/analysis/*` |

- `accept`는 `detail=True` action → 올바른 경로는 `/invitations/{id}/accept/`
- 토큰으로 초대 조회는 `by_token` action (detail=False, GET)
- `resultsAPI`는 현재 컴포넌트에서 미사용(dead code)이나 경로 일관성 유지

### 커밋 내역 (세션 8)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `504353b` | fix: apiService.ts validateAccessKey, resultsAPI 경로 수정 |

---

---

## 2026-02-19 전체 세션 종합 요약

### 오늘 수행한 작업 (세션 4~8)

| 세션 | 작업 | 결과 |
|------|------|------|
| 4 | API 연동 통합 테스트 (백엔드 버그 4종 수정) | ✅ 완료 |
| 5 | 프론트엔드-백엔드 연동 테스트 (api.ts 전면 수정) | ✅ 완료 |
| 6 | CORS Render 반영 확인 | ✅ 완료 |
| 7 | 이메일 인증 흐름 검토 및 설정 정리 | ✅ 완료 |
| 8 | E2E 전체 흐름 테스트 17/17 통과 | ✅ 완료 |

### 오늘 수정한 버그 전체 목록

| # | 파일 | 버그 | 수정 내용 |
|---|------|------|-----------|
| 1 | `projects/serializers.py` | `ProjectCreateSerializer` id 누락 | `SerializerMethodField` 추가 |
| 2 | `evaluations/serializers.py` | `PairwiseComparisonSerializer.validate()` PATCH 500 | `.get()` + instance fallback |
| 3 | `evaluations/serializers.py` | `EvaluationCreateSerializer` id 누락 | `UUIDField(read_only=True)` 추가 |
| 4 | `analysis/views.py` | `AnalysisViewSet` 4개 메서드 미구현 500 | `calculate_individual/group/final_priorities/project_summary` 구현 |
| 5 | `analysis/views.py` | 잘못된 UUID → `ValueError` → 500 | `(DoesNotExist, ValueError, Exception)` → 404 |
| 6 | `accounts/views.py` + `urls.py` | `/accounts/me/` 404 | `current_user_profile` FBV + 명시적 URL |
| 7 | `settings.py` | `CORS_ALLOW_ALL_ORIGINS=True` env var로 모든 origin 허용 | `False` 하드코딩 |
| 8 | `settings.py` | `ACCOUNT_EMAIL_VERIFICATION='mandatory'` allauth 500 유발 | `'none'`으로 수정 |
| 9 | `src/config/api.ts` | 엔드포인트 상수 11개 잘못됨 | 백엔드 실제 URL과 일치하도록 전면 수정 |
| 10 | `src/services/apiService.ts` | `validateAccessKey` 404 경로 | `by_token/?token=` (GET)으로 수정 |
| 11 | `src/services/apiService.ts` | `resultsAPI.*` 미존재 경로 | `/api/service/analysis/*` 실제 경로로 수정 |

### 오늘 커밋 내역 전체

#### 백엔드 (aebonlee/ahp-django-service)

| 커밋 | 내용 |
|------|------|
| `caae9a9` | fix: 통합 테스트 버그 3종 수정 (serializers + analysis views) |
| `533ede7` | fix: /me/ 엔드포인트 404 수정 |
| `d3cc26b` | fix: EvaluationCreateSerializer id 누락 수정 |
| `f810099` | security: CORS_ALLOW_ALL_ORIGINS 차단 (False 하드코딩) |
| `c960f7e` | fix: AnalysisViewSet UUID 유효성 검증 500 → 404 |
| `ed84921` | config: allauth 이메일 인증 비활성화 (베타 단계) |

#### 프론트엔드 (aebonlee/ahp_app)

| 커밋 | 내용 |
|------|------|
| `ac28eb2` | fix: api.ts 전체 엔드포인트 백엔드 URL과 일치하도록 수정 |
| `504353b` | fix: apiService.ts validateAccessKey, resultsAPI 경로 수정 |
| `4f3ebfc` | docs: 개발일지 세션 5 추가 |
| `0c7be8e` | docs: 개발일지 세션 6 추가 (CORS 확인) |
| `a3f5bd3` | docs: 개발일지 세션 7 추가 (이메일 인증) |
| `9195247` | docs: 개발일지 세션 8 추가 (E2E 테스트) |

### 최종 시스템 상태 (2026-02-19 기준)

#### 백엔드 (https://ahp-django-backend.onrender.com)

| 항목 | 상태 |
|------|------|
| 인증 (register/login/logout/me) | ✅ 정상 |
| 프로젝트 CRUD | ✅ 정상 |
| 기준(criteria) CRUD | ✅ 정상 |
| 평가 생성 및 비교쌍 입력 | ✅ 정상 |
| AHP 계산 (개인/그룹/요약) | ✅ 정상 |
| 토큰 갱신 (rotation) | ✅ 정상 |
| CORS 보안 (화이트리스트) | ✅ 정상 |
| 이메일 인증 | ⏸ 비활성화 (베타) |

#### 프론트엔드 (https://aebonlee.github.io/ahp_app)

| 항목 | 상태 |
|------|------|
| `api.ts` 엔드포인트 상수 | ✅ 백엔드 URL과 일치 |
| `authService.ts` 인증 흐름 | ✅ 정상 |
| `apiService.ts` 평가자/결과 API | ✅ 수정 완료 |
| `ahpApiService.ts` | ✅ 정상 |

---

## 남은 작업 (TODO)

### 우선순위 LOW
1. **Render.com PostgreSQL → Neon.tech 이전** ($7/월 절약)
2. **새 프로덕션 레포** 생성

---

---

## 세션 9: CRITICAL 보안 수정 (exports/workshops AllowAny + 하드코딩 비밀번호)

### 문제 발견 배경

보안 감사(이전 세션 Feature Audit)에서 발견된 CRITICAL 취약점 2종:
1. **exports/workshops ViewSet 전체 `AllowAny`** — 미인증 사용자가 수출 이력, 워크숍 세션 등 모든 데이터 조회/수정 가능
2. **RoleSwitcher.tsx 하드코딩 비밀번호** — `'admin123'`이 프론트엔드 번들에 노출 → 비밀번호 우회 가능

### 수정 1: exports/workshops AllowAny 제거 (백엔드)

**파일**: `apps/exports/views.py` (커밋 `2bf7ff1`)

| ViewSet | 수정 전 | 수정 후 |
|---------|---------|---------|
| `ExportTemplateViewSet` | `AllowAny` | `IsAuthenticated` |
| `ExportHistoryViewSet` | `AllowAny` | `IsAuthenticated` |
| `ReportScheduleViewSet` | `AllowAny` | `IsAuthenticated` |
| `ExportJobViewSet` | `AllowAny` | `IsAuthenticated` |

추가 수정:
- `ExportTemplateViewSet.get_queryset()`: 공개 템플릿 OR 본인 소유 템플릿만 반환
  ```python
  from django.db.models import Q
  return ExportTemplate.objects.filter(
      Q(is_public=True) | Q(created_by=self.request.user)
  ).order_by('-created_at')
  ```
- `ExportHistoryViewSet.get_queryset()`: `exported_by=self.request.user` 필터
- `ReportScheduleViewSet.get_queryset()`: `created_by=self.request.user` 필터
- `perform_create()`: `created_by`/`exported_by` 자동 할당

**파일**: `apps/workshops/views.py` (커밋 `2bf7ff1`)

| 전략 | 내용 |
|------|------|
| `WorkshopSessionViewSet` | `get_permissions()` 오버라이드 — `join` 액션만 `AllowAny()`, 나머지 `IsAuthenticated()` |
| `WorkshopParticipantViewSet` | `get_permissions()` — `by_token` 액션만 `AllowAny()`, 나머지 `IsAuthenticated()` |
| 나머지 4개 ViewSet | `AllowAny` → `IsAuthenticated` |
| `get_queryset()` (전체) | 미인증 시 `.none()` 반환, 인증 시 `facilitator=self.request.user` 필터 |

> **`join`/`by_token` 액션 `AllowAny` 유지 이유**: 외부 참가자가 워크숍 코드/액세스 토큰으로 참여 시 JWT 인증 없이 접근해야 하는 정당한 use case.

### 수정 2: verify-password 엔드포인트 신설 (백엔드)

**파일**: `apps/accounts/views.py` + `apps/accounts/urls.py` (커밋 `2bf7ff1`)

```python
@api_view(['POST'])
@permission_classes([permissions.IsAuthenticated])
def verify_password(request):
    password = request.data.get('password', '').strip()
    if not password:
        return Response({'error': '비밀번호가 필요합니다.'}, status=400)
    if request.user.check_password(password):
        return Response({'valid': True})
    return Response({'valid': False, 'error': '비밀번호가 올바르지 않습니다.'}, status=400)
```

엔드포인트: `POST /api/service/accounts/verify-password/`

### 수정 3: RoleSwitcher.tsx 하드코딩 비밀번호 제거 (프론트엔드)

**파일**: `src/components/superadmin/RoleSwitcher.tsx` (커밋 `61e86d3`)

```typescript
// 수정 전 (CRITICAL — 번들에 노출)
if (password === 'admin123') {
  onRoleSwitch(targetRole);
}

// 수정 후 (실제 API 검증)
import apiService from '../../services/apiService';
const [isVerifying, setIsVerifying] = useState(false);

const handleConfirmSwitch = async () => {
  setIsVerifying(true);
  try {
    const result = await apiService.post('/api/service/accounts/verify-password/', { password });
    if (result.data && (result.data as any).valid) {
      onRoleSwitch(targetRole);
    } else {
      showActionMessage('error', '비밀번호가 올바르지 않습니다.');
    }
  } catch {
    showActionMessage('error', '비밀번호 확인 중 오류가 발생했습니다.');
  } finally {
    setIsVerifying(false);
    setPassword('');
  }
};
```

버튼 로딩 상태: `disabled={isVerifying}` + `{isVerifying ? '확인 중...' : '확인'}`

### 수정 4: SystemReset.tsx TODO 제거 (프론트엔드)

**파일**: `src/components/superadmin/SystemReset.tsx` (커밋 `61e86d3`)

```typescript
// 수정 전
// TODO: 실제 API 연동
if (password === 'correct') { ... }

// 수정 후
const handleFinalReset = async () => {
  setIsVerifying(true);
  try {
    const result = await apiService.post('/api/service/accounts/verify-password/', { password });
    if (result.data && (result.data as any).valid) {
      onReset(resetOptions);
      showActionMessage('success', '시스템 초기화가 시작되었습니다.');
      setConfirmStep(0);
    } else {
      showActionMessage('error', '비밀번호가 올바르지 않습니다.');
    }
  } catch {
    showActionMessage('error', '비밀번호 확인 중 오류가 발생했습니다.');
  } finally {
    setIsVerifying(false);
  }
};
```

### 커밋 내역 (세션 9)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 백엔드 | `2bf7ff1` | security: fix AllowAny in exports/workshops, add verify-password endpoint |
| 프론트 | `61e86d3` | security: replace hardcoded admin123 in RoleSwitcher, implement SystemReset password verification |

---

---

## 세션 10: ResultsDataManager 실제 API 연동

### 목표

`ResultsDataManager.tsx`의 모든 하드코딩/mock 샘플 데이터를 실제 백엔드 AHP 분석 API로 교체.

### 신규 TypeScript 인터페이스

```typescript
interface ProjectSummaryResponse {
  project: { id: string; name: string; status: string; ... };
  evaluations: Array<{ id: string; evaluator_name: string; status: string; ... }>;
  criteria: Array<{ id: string; name: string; weight?: number }>;
  completion_rate: number;
}

interface GroupWeightResponse {
  method: string;
  weights: Record<string, number>;
  criteria_names: Record<string, string>;
  participant_count: number;
  consistency_ratio?: number;
}

interface IndividualWeightResponse {
  evaluation_id: string;
  evaluator_name: string;
  weights: Record<string, number>;
  consistency_ratio: number;
  is_consistent: boolean;
}
```

### loadResults() 구현

3단계 병렬/순차 API 호출:

```
1. GET /api/service/analysis/project-summary/?project_id={id}
   → criteria 목록, 완료된 평가 목록, 진행률
2. POST /api/service/analysis/calculate/group/
   → 전체 그룹 가중치 (기하평균 집계)
3. GET /api/service/evaluations/evaluations/?project={id}&status=completed
   POST /api/service/analysis/calculate/individual/ × N (평가자별)
   → 개인별 가중치 + CR
```

### 대안 분석 탭 처리

백엔드 `calculate_group`은 기준 가중치만 반환하며 대안 최종 점수 계산 미구현.
→ 대안 분석 탭에 "대안 비교 평가가 필요합니다" 안내 메시지로 정직하게 표시:

```tsx
<div className="text-center py-12">
  <p className="text-2xl mb-4">📊</p>
  <h3 className="text-lg font-semibold mb-2">대안 비교 평가가 필요합니다</h3>
  <p className="text-sm" style={{ color: 'var(--text-muted)' }}>
    대안 분석을 위해서는 대안 비교 평가를 먼저 완료해야 합니다.
  </p>
</div>
```

### CSV export / HTML 보고서

- CSV: 백엔드 Excel 시도 후 로컬 CSV fallback
- HTML 보고서: 실제 `ahpResults` 데이터 기반으로 동적 생성

### 타입 안전성

- `PaginatedResponse<T> | T[]` 양쪽 처리 → `Array.isArray()` 가드
- Optional chaining 전면 적용 (`weights?.[key]`, `evaluations?.length`)
- Mock 데이터 전면 제거

### 커밋 내역 (세션 10)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `06dbf0a` | feat: ResultsDataManager 실제 API 연동 (mock 데이터 전면 교체) |

---

---

## 세션 11: AdminOnlyDashboard 실제 API 연동

### 목표

`AdminOnlyDashboard.tsx`의 하드코딩된 통계/사용자/활동 데이터를 실제 API로 교체.

### 신규 인터페이스

```typescript
interface UserStatsResponse { total_users: number; active_users: number; ... }
interface PaginatedResponse<T> { count: number; results: T[]; next: string | null; previous: string | null; }
interface SystemStats { totalUsers: number; totalProjects: number; activeEvaluations: number; systemHealth: string; }
interface RecentUser { id: string; name: string; email: string; role: string; joinedAt: string; status: string; }
interface ActivityItem { id: string; type: string; user: string; action: string; time: string; }
```

### loadSystemStats() — Promise.allSettled 병렬 호출

```typescript
const [usersResult, projectsResult, evalsResult, healthResult] = await Promise.allSettled([
  apiService.get('/api/service/accounts/users/stats/'),
  apiService.get('/api/service/projects/projects/?page_size=1'),
  apiService.get('/api/service/evaluations/evaluations/?status=in_progress&page_size=1'),
  fetch(API_BASE_URL + '/health/').then(r => r.json()),
]);
```

`Promise.allSettled` 사용으로 일부 API 실패 시에도 나머지 데이터 정상 표시.

### loadRecentUsers()

```
GET /api/service/accounts/users/?page_size=5
```

`is_superuser`/`is_staff` boolean → role 레이블 매핑 (백엔드에 custom `role` 필드 없음):
```typescript
const role = user.is_superuser ? '슈퍼관리자' :
             user.is_staff ? '관리자' : '사용자';
```

### loadSystemActivity() — 활동 로그 구성

전용 audit log 엔드포인트 없음 → 최근 프로젝트 + 평가 데이터 병렬 조회 후 통합:

```typescript
const [projectsRes, evalsRes] = await Promise.allSettled([
  apiService.get('/api/service/projects/projects/?page_size=5&ordering=-created_at'),
  apiService.get('/api/service/evaluations/evaluations/?page_size=5&ordering=-created_at'),
]);
// 두 목록 합쳐서 최신순 정렬 → 상위 6건 표시
```

### formatRelativeTime() — 상대시간 표시

```typescript
const formatRelativeTime = (dateStr: string): string => {
  const diff = Date.now() - new Date(dateStr).getTime();
  const minutes = Math.floor(diff / 60000);
  if (minutes < 60) return `${minutes}분 전`;
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return `${hours}시간 전`;
  return `${Math.floor(hours / 24)}일 전`;
};
```

### 추가 기능

- 수동 새로고침 버튼 (`🔄 새로고침`)
- 로딩 스피너 (`isLoading` 상태)
- 오류 처리: 개별 API 실패 시 해당 카드만 기본값 표시

### 커밋 내역 (세션 11)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `c56a609` | feat: AdminOnlyDashboard 실제 API 연동 (mock 데이터 전면 교체) |

---

---

## 세션 9~11 종합 요약

### 이번 세션에서 완료한 작업

| 세션 | 작업 | 주요 내용 |
|------|------|-----------|
| 9 | CRITICAL 보안 수정 | AllowAny 제거(exports/workshops), admin123 하드코딩 제거, verify-password API 신설 |
| 10 | ResultsDataManager API 연동 | mock 3종 → 실제 project-summary/calculate-group/calculate-individual |
| 11 | AdminOnlyDashboard API 연동 | mock 통계/사용자/활동 → 실제 users/projects/evaluations API, Promise.allSettled |

### 커밋 목록 (세션 9~11)

#### 백엔드 (aebonlee/ahp-django-service)
| 커밋 | 내용 |
|------|------|
| `2bf7ff1` | security: fix AllowAny in exports/workshops, add verify-password endpoint |

#### 프론트엔드 (aebonlee/ahp_app)
| 커밋 | 내용 |
|------|------|
| `61e86d3` | security: replace hardcoded admin123, implement SystemReset password verification |
| `06dbf0a` | feat: ResultsDataManager 실제 API 연동 |
| `c56a609` | feat: AdminOnlyDashboard 실제 API 연동 |

### 남은 작업 (우선순위별)

#### HIGH
- **WorkshopManagement.tsx** — API 주석 해제 및 연동
- **ProjectCompletion.tsx** — 이메일 발송/프로젝트 상태 업데이트 API 연동
- **SurveyLinkManager.tsx** — API 연동으로 데이터 영속성 확보 (현재 로컬 상태만)

#### MEDIUM
- **PaymentSystem.tsx** — PG 연동 (또는 미구현 안내 UI)

#### LOW
- Render.com PostgreSQL → Neon.tech 이전 ($7/월 절약)
- 새 프로덕션 레포 생성

---

---

## 세션 17: RealTimeParticipantMonitor API 연동

### 목표

`RealTimeParticipantMonitor.tsx`의 mock 4명(김기술팀장, 이개발자, 박분석가, 최연구원) 및 mock 프로젝트 통계를 실제 API로 교체.

### 변경 전 상태

```typescript
// mock 4명 하드코딩 (fetchParticipantData)
const mockData: ParticipantStatus[] = [
  { participantId: 'p1', name: '김기술팀장', ... },
  { participantId: 'p2', name: '이개발자', ... },
  { participantId: 'p3', name: '박분석가', ... },
  { participantId: 'p4', name: '최연구원', ... },
];

// mock 프로젝트 통계 (fetchProjectProgress)
const mockProgress = { totalParticipants: 4, activeParticipants: 2, ... };

// mock 알림 2개 (checkForNotifications)
const mockNotifications = [{ id:'n1', message:'CR 0.15 초과' }, ...];
```

### 인터페이스 단순화

백엔드에서 제공하지 않는 필드 일괄 제거:

| 제거 필드 | 이유 |
|---------|------|
| `email` | evaluations API에 없음 |
| `loginTime` | 세션 추적 없음 |
| `currentPage` | 실시간 페이지 추적 없음 |
| `averageResponseTime` | 응답 시간 측정 없음 |
| `deviceInfo` | 기기 정보 수집 없음 |
| `connectionStatus` | WebSocket 없음 |
| `ProjectProgress.phases` | 단계별 분리 데이터 없음 |
| `ProjectProgress.estimatedCompletion` | 추정 완료 시간 없음 |

### API 연동 내역

#### `fetchParticipantData()` → GET /api/service/evaluations/evaluations/

```typescript
const res = await apiService.get<any>(
  `/api/service/evaluations/evaluations/?project=${projectId}&page_size=100`
);
```

필드 매핑:

| API 필드 | 컴포넌트 필드 |
|---------|------------|
| `id` | `participantId` |
| `evaluator_name` / `evaluator.name` | `name` |
| `updated_at` / `created_at` | `lastActivity` |
| `progress` | `completionRate` |
| `status` | `evaluationStatus` (매핑 변환) |
| `consistency_ratio` | `consistencyRatio` |
| `total_comparisons` | `totalEvaluations` |
| `completed_comparisons` | `completedEvaluations` |

status 매핑:
- `'completed'` → `'completed'`
- `'in_progress'` → `'in_progress'`
- `'expired'` → `'overdue'`
- progress > 0이면 → `'in_progress'`
- 그 외 → `'not_started'`

#### `fetchProjectProgress()` → GET /api/service/analysis/project-summary/

```typescript
const res = await apiService.get<any>(
  `/api/service/analysis/project-summary/?project_id=${projectId}`
);
```

필드 매핑:
- `project_title` → `projectTitle`
- `total_evaluations` → `totalParticipants`
- `completed_evaluations` → `completedParticipants`
- `average_consistency_ratio` → `averageConsistency`
- `overallProgress` = `Math.round((completed / total) * 100)`

#### `checkForNotifications()` — participants 데이터에서 파생

전용 알림 API 없으므로 participants 상태에서 조건 파생:

```typescript
const checkForNotifications = useCallback((currentParticipants: ParticipantStatus[]) => {
  currentParticipants.forEach(p => {
    // CR > 0.1 + 완료 비교 존재 → warning
    if (p.consistencyRatio > 0.1 && p.completedEvaluations > 0) { ... }
    // 24시간 이상 비활성 + 미완료 → error
    if (now - lastActiveMs > 86400000 && p.evaluationStatus !== 'completed') { ... }
  });
}, []);
```

중복 방지: `id` Set으로 기존 알림과 비교 후 신규만 추가.

### `useEffect` 구조 개선

```typescript
// 1) 폴링 + 초기 로드
useEffect(() => {
  const loadAll = async () => {
    await fetchParticipantData();
    await fetchProjectProgress();
  };
  loadAll();
  if (!isRealTimeEnabled) return;
  const intervalId = setInterval(loadAll, refreshInterval);
  return () => clearInterval(intervalId);
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, [projectId, isRealTimeEnabled, refreshInterval]);

// 2) participants 변경 → 알림 재계산 + activeParticipants 갱신
useEffect(() => {
  if (participants.length === 0) return;
  checkForNotifications(participants);
  const active = participants.filter(p => p.evaluationStatus === 'in_progress').length;
  setProjectProgress(prev => prev ? { ...prev, activeParticipants: active } : prev);
}, [participants]);
```

`activeParticipants`는 API 응답이 아닌 `in_progress` 상태 참가자 수에서 실시간 파생.

### UI 변경

| 변경 | 내용 |
|------|------|
| 연결 상태 점(dot) 제거 | `connectionStatus` 필드 없으므로 제거 |
| `currentPage` 텍스트 제거 | 실시간 추적 없음 |
| "단계별 진행률" 섹션 → "전체 진행률" 바 | phases 데이터 없음 |
| 세부 정보 패널 단순화 | 역할, 완료 비교수, 마지막 활동 시간만 표시 |
| "명 온라인" → "명 진행중" | connectionStatus 없으므로 수정 |
| 빈 상태 메시지 추가 | 평가자 없을 때 안내 |
| CR 0일 때 `-` 표시 | 비교 미완료 상태 명확화 |

### 빌드 검증

```
Compiled successfully.
File sizes after gzip:
  584.82 kB  build/static/js/main.6efc3540.js
  26.11 kB   build/static/css/main.ee5e5ab4.css
ESLint 경고: 0개
```

### 커밋 내역 (세션 17)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `441a367` | feat: RealTimeParticipantMonitor API 연동 (mock 4명 제거, 폴링 구조 개선) |

---

## 남은 TODO (세션 17 이후)

### HIGH
- **EvaluatorSurveyPage.tsx** — mock 설문 질문 제거, API 연동 ✅ (세션 18 완료)

### MEDIUM
- **PairwiseEvaluation.tsx** — 실제 criteria API + AHP 계산 연동
- **PaymentSystem.tsx** — 미구현 안내 UI

### LOW
- 빌드 번들 사이즈 최적화 (584 kB → code splitting)
- 백엔드 SMTP 설정 → 이메일 발송 실제 구현
- Render.com PostgreSQL → Neon.tech 이전

---

---

## 세션 18: EvaluatorSurveyPage API 연동

### 목표

`EvaluatorSurveyPage.tsx`의 하드코딩된 mock 설문 데이터를 실제 API로 교체.

### 변경 전 상태

```typescript
// loadSurveyData() — mock 하드코딩
const mockData: SurveyData = {
  projectTitle: "AI 도입 효과성 평가 연구",
  researcherName: "김연구 교수",
  description: "본 설문조사는 AI 도입의 효과성을 평가하기 위한...",
  deadline: new Date('2025-09-30'),
  questions: [
    { id: 'q1', type: 'text', question: '귀하의 소속 기관을...' },
    { id: 'q2', type: 'radio', question: '귀하의 전문 분야는...', options: [...] },
    { id: 'q3', type: 'scale', question: 'AI 기술에 대한...' },
    { id: 'q4', type: 'checkbox', question: '귀하가 경험한...' },
    { id: 'q5', type: 'matrix', question: '다음 AI 도입 요소들의...' },
    { id: 'q6', type: 'text', question: 'AI 도입 시 가장...' },
  ]
};

// handleSubmit() — fake 2초 딜레이
await new Promise(resolve => setTimeout(resolve, 2000));
setIsCompleted(true);
```

### API 연동 내역

#### `loadSurveyData()` → GET /api/service/workshops/survey-templates/{surveyId}/

```typescript
const loadSurveyData = useCallback(async () => {
  if (!surveyId) return;
  setIsLoading(true);
  setLoadError(false);
  try {
    const res = await apiService.get<any>(
      `/api/service/workshops/survey-templates/${surveyId}/`
    );
    if (res?.data) {
      const d = res.data;
      setSurveyData({
        projectTitle: d.title || d.project_title || '설문조사',
        researcherName: d.facilitator_name || d.created_by_name || '',
        description: d.description || '',
        deadline: d.deadline ? new Date(d.deadline) : undefined,
        questions: (d.questions || []).map((q: any, idx: number) => ({
          id: String(q.id ?? idx),
          type: q.type || 'text',
          question: q.question || q.text || '',
          required: q.required ?? false,
          options: q.options,
          scaleMin: q.scale_min ?? q.scaleMin,
          scaleMax: q.scale_max ?? q.scaleMax,
          scaleLabels: q.scale_labels ? { min: q.scale_labels.min, max: q.scale_labels.max } : q.scaleLabels,
          matrixRows: q.matrix_rows ?? q.matrixRows,
          matrixColumns: q.matrix_columns ?? q.matrixColumns,
        })),
      });
    }
  } catch (error) {
    console.error('Failed to load survey data:', error);
    setLoadError(true);
  } finally {
    setIsLoading(false);
  }
}, [surveyId]);

useEffect(() => {
  loadSurveyData();
}, [loadSurveyData]);
```

#### `handleSubmit()` → POST /api/service/workshops/survey-responses/

```typescript
await apiService.post('/api/service/workshops/survey-responses/', {
  template: surveyId,
  token,
  responses,
  submitted_at: new Date().toISOString(),
});
setIsCompleted(true);
```

### 추가 변경: 로딩/에러 UI 분기

`isLoading`, `loadError` 상태 추가:

| 상태 | 화면 |
|------|------|
| `isLoading = true` | "설문조사를 불러오는 중..." 스피너 |
| `loadError = true` 또는 `!surveyData` | "설문을 불러올 수 없습니다" + "다시 시도" 버튼 |
| 정상 | 기존 설문 UI |

"다시 시도" 버튼은 `loadSurveyData`를 직접 호출하여 재시도.

### 필드 매핑 요약

| API 필드 | SurveyData 필드 |
|---------|----------------|
| `title` / `project_title` | `projectTitle` |
| `facilitator_name` / `created_by_name` | `researcherName` |
| `description` | `description` |
| `deadline` | `deadline` (Date 변환) |
| `questions[].scale_min` / `scale_max` | `scaleMin` / `scaleMax` |
| `questions[].scale_labels.min/max` | `scaleLabels.min/max` |
| `questions[].matrix_rows` | `matrixRows` |
| `questions[].matrix_columns` | `matrixColumns` |

### 빌드 검증

```
Compiled successfully.
ESLint 경고: 0개
```

### 커밋 내역 (세션 18)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `4f68820` | feat: EvaluatorSurveyPage API 연동 (mock 설문 데이터 제거) |

---

## 남은 TODO (세션 18 이후)

### MEDIUM
- **PairwiseEvaluation.tsx** — 실제 criteria API + AHP 계산 연동 ✅ (세션 19 완료)
- **PaymentSystem.tsx** — 미구현 안내 UI

### LOW
- 빌드 번들 사이즈 최적화 (584 kB → code splitting)
- 백엔드 SMTP 설정 → 이메일 발송 실제 구현
- Render.com PostgreSQL → Neon.tech 이전

---

---

## 세션 19: PairwiseEvaluation API 연동

### 목표

`PairwiseEvaluation.tsx`의 하드코딩 매트릭스 3개와 가짜 CR 계산을 실제 API로 교체.

### 변경 전 상태

```typescript
// 3개 하드코딩 매트릭스
const [matrices, setMatrices] = useState<Matrix[]>([
  { id: 'criteria', name: '주요 기준 비교',
    items: ['성능', '비용', '사용성'], ... },
  { id: 'performance', name: '성능 세부기준 비교',
    items: ['처리속도', '안정성'], ... },
  { id: 'alternatives_performance', name: '성능 관점 대안 비교',
    items: ['대안 A', '대안 B', '대안 C'], ... }
]);

// 가짜 CR (Math.random)
const calculateConsistencyRatio = (values: number[][]): number => {
  const mockCR = Math.random() * 0.15;
  return parseFloat(mockCR.toFixed(3));
};

// 주석 처리된 API 저장
// const response = await apiService.evaluationAPI.saveMatrix(matrixData);
```

### 신규 인터페이스

```typescript
interface CriterionItem { id: string; name: string; }
interface ComparisonItem {
  id: string;
  criteriaAId: string;
  criteriaBId: string;
  value: number;
}
```

### 로드 흐름

```
1. GET /api/service/evaluations/evaluations/?project={id}
   → evalsList[0].id 획득 (현재 사용자 평가)

2. Promise.allSettled 병렬:
   GET /api/service/projects/criteria/?project={id}       → 기준 목록
   GET /api/service/evaluations/comparisons/?evaluation={id} → 비교쌍 목록

3. buildMatrix(criteriaList, compList)
   → n×n 대칭 행렬 생성
   → comp.criteriaAId 방향에 따라 value 또는 1/value 자동 배치
   → 대각선은 항상 1
```

### buildMatrix() 로직

```typescript
const buildMatrix = (criteriaList, compList): Matrix => {
  const values = Array.from({length: n}, (_, i) =>
    Array.from({length: n}, (_, j) => {
      if (i === j) return 1;
      const comp = compList.find(c =>
        (c.criteriaAId === criteriaList[i].id && c.criteriaBId === criteriaList[j].id) ||
        (c.criteriaAId === criteriaList[j].id && c.criteriaBId === criteriaList[i].id)
      );
      if (!comp) return 1;
      // comp 방향에 맞게: A→B면 value 직접, B→A면 1/value
      return comp.criteriaAId === criteriaList[i].id ? comp.value : 1 / comp.value;
    })
  );
  return { id: 'criteria', name: '기준 쌍대비교', items: criteriaList.map(c=>c.name), values, completed: false };
};
```

### 저장/완료 흐름 (handleComplete)

```typescript
// 1. 상위 삼각 비교쌍 전체 PATCH
for (let i = 0; i < criteria.length; i++) {
  for (let j = i + 1; j < criteria.length; j++) {
    const comp = find matching comparison...
    const value = comp.criteriaAId === criteria[i].id
      ? matrix.values[i][j]   // 정방향
      : matrix.values[j][i];  // 역방향
    PATCH /api/service/evaluations/comparisons/{comp.id}/ { value }
  }
}
// → Promise.allSettled (일부 실패해도 나머지 저장)

// 2. CR 계산
POST /api/service/analysis/calculate/individual/ { evaluation_id }
→ cr = response.consistency_ratio

// 3. 분기
if (cr > 0.1) → 경고 토스트 + JudgmentHelper 표시, 완료 차단
if (cr ≤ 0.1) → onComplete() 호출
if (CR API 실패) → 경고 로그 후 완료 허용
```

### 멀티매트릭스 → 단일 매트릭스

| 변경 전 | 변경 후 |
|---------|---------|
| 3개 하드코딩 매트릭스 (기준/세부기준/대안) | 1개 API 기반 기준 매트릭스 |
| 매트릭스 간 탭 네비게이션 | 제거 |
| Math.random() CR | `calculate/individual/` 실제 CR |
| 주석 처리된 API 호출 | 실제 PATCH 구현 |

### 진행률 계산 변경

```typescript
// 변경 전: completedMatrices / totalMatrices
// 변경 후: 비기본값(≠1) 셀 수 / 상위삼각 총 셀 수
const filled = upper_triangle.filter(v => v !== 1).length;
const progress = Math.round((filled / total) * 100);
```

### UI 변경

| 항목 | 변경 |
|------|------|
| isLoading 상태 | 로딩 스피너 추가 |
| loadError 상태 | "평가 데이터를 불러올 수 없습니다" + 재시도 버튼 |
| isSaving 상태 | "저장 중..." 버튼 비활성화 |
| 완료 버튼 | 항상 활성 (CR > 0.1 시 차단 로직은 handleComplete 내부) |
| actionMessage | CR 초과 경고 / 저장 성공 토스트 |

### 빌드 검증

```
Compiled successfully.
File sizes after gzip:
  585.64 kB  build/static/js/main.883e9e03.js
ESLint 경고: 0개
```

### 커밋 내역 (세션 19)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `a0388e9` | feat: PairwiseEvaluation API 연동 (하드코딩 매트릭스 제거, 실제 CR 계산) |

---

## 남은 TODO (세션 19 이후)

### MEDIUM
- **PaymentSystem.tsx** — 미구현 안내 UI ✅ (세션 20 완료)

### LOW
- 빌드 번들 사이즈 최적화 (585 kB → code splitting)
- 백엔드 SMTP 설정 → 이메일 발송 실제 구현
- Render.com PostgreSQL → Neon.tech 이전

---

---

## 세션 20: PaymentSystem 미구현 안내 UI + KG이니시스

### 목표

`PaymentSystem.tsx`에 PG 연동 전 사용자 안내 UI 추가.

### 변경 내역

#### 1. KG이니시스 안내 배너 추가

최상단에 amber 배너 추가:

```tsx
<div className="mb-8 rounded-xl border-2 border-amber-300 bg-amber-50 p-6 text-center shadow-sm">
  <div className="text-4xl mb-3">🚧</div>
  <h2 className="text-xl font-bold text-amber-900 mb-2">결제 시스템 연동 준비 중입니다</h2>
  <p className="text-amber-800 mb-1">
    <strong>KG이니시스</strong> 카드 결제 연동 작업이 진행 중입니다.
  </p>
  <p className="text-amber-700 text-sm mb-3">
    현재 요금제 선택 및 결제가 비활성화되어 있습니다.
    문의사항이 있으시면 아래 이메일로 연락해 주세요.
  </p>
  <a href="mailto:contact@ahp-platform.com" ...>✉ 요금제 문의하기</a>
</div>
```

#### 2. 요금제 선택 버튼 비활성화

```tsx
// 변경 전
<Button variant="primary" onClick={() => setSelectedPlan(plan.id)}>선택하기</Button>

// 변경 후
<button disabled className="..." style={{ cursor: 'not-allowed', opacity: 0.6 }}>
  🚧 준비 중
</button>
```

#### 3. 결제 수단 표시 업데이트

| 결제 수단 | 변경 전 | 변경 후 |
|-----------|---------|---------|
| 신용/체크카드 | 일반 표시 | "KG이니시스" 배지 + 설명 |
| 계좌이체 | 일반 표시 | "준비 중" 배지 |
| 가상계좌 | 일반 표시 | "준비 중" 배지 |
| 간편결제 | 일반 표시 | "준비 중" 배지 |

#### 4. 결제하기 버튼 비활성화

```tsx
// 변경 전
<Button variant="primary" size="lg" onClick={() => handlePayment(selectedPlan)}>
  결제하기
</Button>

// 변경 후
<button disabled ...>🚧 결제 시스템 준비 중</button>
```

#### 5. 안전 결제 섹션 업데이트

"KG이니시스 안전 결제"로 문구 변경.

### ESLint 수정

빌드 경고 2개 해소:

| 경고 | 원인 | 수정 |
|------|------|------|
| `Button` is defined but never used | `import Button` 잔존 | import 줄 제거 |
| `handlePayment` is assigned a value but never used | 결제 버튼 제거 후 함수 잔존 | 함수 전체 제거 |

### 빌드 검증

```
Compiled successfully.
File sizes after gzip:
  586.09 kB  build/static/js/main.7ec3ebf0.js
  26.2 kB    build/static/css/main.fb750841.css
ESLint 경고: 0개
```

### 커밋 내역 (세션 20)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `e337a82` | feat: PaymentSystem 미구현 안내 UI 추가 (KG이니시스 준비 중) |

---

## 남은 TODO (세션 20 이후)

### LOW
- 빌드 번들 사이즈 최적화 (586 kB → code splitting) ✅ (세션 21 확인: 모두 완료)
- 백엔드 SMTP 설정 → 이메일 발송 실제 구현
- Render.com PostgreSQL → Neon.tech 이전
- KG이니시스 PG 연동 실제 구현 (준비되면)

---

---

## 세션 21: 종합계획 검토 및 PaperManagement dead code 정리

### 목표

종합 개발계획(2026-02-19_종합개발계획.md) 기준으로 잔여 작업 점검 및 처리.

### 점검 결과

종합계획의 CRITICAL/HIGH 항목들이 **이미 완료** 상태였음:

| 항목 | 파일 | 상태 |
|------|------|------|
| Todo 1: ResultsAnalysis API 연동 | `ResultsAnalysis.tsx` | ✅ 이미 완료 (generateMockData 없음) |
| Todo 2: EvaluatorDashboard API 연동 | `EvaluatorDashboard.tsx` | ✅ 이미 완료 (fetchInvitations 구현) |
| Todo 3: AIResultsInterpretationPage ESLint | `AIResultsInterpretationPage.tsx` | ✅ 이미 완료 (경고 없음) |
| Todo 4: ESLint 경고 전체 수정 | 전체 | ✅ 세션 12-16에서 완료 |
| Todo 5: EvaluatorSurveyPage | `EvaluatorSurveyPage.tsx` | ✅ 세션 18에서 완료 |
| Todo 7: RealTimeParticipantMonitor | `RealTimeParticipantMonitor.tsx` | ✅ 세션 17에서 완료 |

### 실제 수행: PaperManagement dead code 제거

**파일**: `src/components/paper/PaperManagement.tsx` (커밋 `80db38a`)

#### 제거된 항목

| 항목 | 내용 |
|------|------|
| `_loadSurveyResults()` | Math.random() mock 42개 생성 (미호출 dead code) |
| `_exportSurveyData()` | "준비 중" 메시지만 출력 (미호출) |
| `_generateReportPDF()` | "준비 중" 메시지만 출력 (미호출) |
| `[_surveyData, setSurveyData]` state | `_loadSurveyResults`에서만 사용 |
| `[_surveyAnalytics, _setSurveyAnalytics]` state | 미사용 |

### 빌드 검증

```
Compiled successfully.
File sizes after gzip:
  586.09 kB (-5 B)  build/static/js/main.4084341a.js
ESLint 경고: 0개
```

### 커밋 내역 (세션 21)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `80db38a` | refactor: PaperManagement dead code 제거 |

---

## 최종 상태 (세션 21 기준) — 종합계획 ALL DONE

| 우선순위 | 항목 | 세션 |
|---------|------|------|
| CRITICAL | ResultsAnalysis API 연동 | 세션 이전 완료 |
| CRITICAL | EvaluatorDashboard API 연동 | 세션 이전 완료 |
| HIGH | AIResultsInterpretationPage API 연동 | 세션 이전 완료 |
| HIGH | ESLint 경고 전체 수정 | 세션 12-16 |
| MEDIUM | EvaluatorSurveyPage API 연동 | 세션 18 |
| MEDIUM | RealTimeParticipantMonitor 폴링 | 세션 17 |
| MEDIUM | PairwiseEvaluation API 연동 | 세션 19 |
| MEDIUM | PaymentSystem KG이니시스 안내 UI | 세션 20 |
| MEDIUM | PaperManagement dead code 제거 | 세션 21 |

### 남은 LOW (기능 외)
- ~~빌드 번들 최적화 (code splitting)~~ ✅ 세션 22 완료
- 백엔드 SMTP 설정
- KG이니시스 PG 실제 연동 (준비 시)

---

---

## 세션 22: React.lazy() 코드 스플리팅 번들 최적화

### 목표

`App.tsx`의 정적 import를 `React.lazy()` + `Suspense`로 전환하여 초기 번들 크기 감소.

### 변경 전 상태

```
main bundle: 586 kB (gzip)
→ 모든 컴포넌트가 하나의 main 청크에 번들
```

### 변경 내역

**파일**: `src/App.tsx` (커밋 `e8eee56`)

#### 1. 정적 import → React.lazy() 전환 (38개 컴포넌트)

```typescript
// 변경 전 (정적 import)
import PairwiseComparison from './components/comparison/PairwiseComparison';
import ResultsDashboard from './components/results/ResultsDashboard';
// ... 총 38개

// 변경 후 (dynamic import)
const PairwiseComparison = lazy(() => import('./components/comparison/PairwiseComparison'));
const ResultsDashboard   = lazy(() => import('./components/results/ResultsDashboard'));
// ... 38개
```

#### 2. 불필요한 정적 import 4개 제거

| 제거된 import | 이유 |
|-------------|------|
| `LoginForm` | `UnifiedAuthPage`로 대체됨, 미사용 |
| `EvaluatorSurveyPage` | App.tsx에서 직접 렌더링 안 함 |
| `DemographicSurvey` | App.tsx에서 직접 렌더링 안 함 |
| `QRCodeEvaluatorAssignment` | App.tsx에서 직접 렌더링 안 함 |

#### 3. PageLoader Suspense fallback 컴포넌트 추가

```tsx
const PageLoader = () => (
  <div className="flex items-center justify-center min-h-[400px]">
    <div className="text-center">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto mb-4"
           style={{ borderColor: 'var(--accent-primary)' }}></div>
      <p style={{ color: 'var(--text-secondary)' }}>페이지 로딩 중...</p>
    </div>
  </div>
);
```

#### 4. Suspense 래퍼 추가 (2곳)

```tsx
// 로그인 사용자 (Layout 내부)
<Layout ...>
  <Suspense fallback={<PageLoader />}>
    {renderContent()}
  </Suspense>
</Layout>

// 비로그인 사용자
<div className="App ...">
  <Suspense fallback={<PageLoader />}>
    {renderContent()}
  </Suspense>
</div>
```

### 빌드 결과

#### 변경 전
```
586 kB  build/static/js/main.7ec3ebf0.js  (단일 청크)
```

#### 변경 후
```
167 kB  build/static/js/main.9b566b93.js   (-419 kB, -71%)
 98 kB  build/static/js/183.68b52560.chunk.js
 81 kB  build/static/js/611.e3761186.chunk.js
 26 kB  build/static/css/main.fb750841.css
 22 kB  build/static/js/678.862ee70f.chunk.js
 ...총 50개 청크로 분리
```

**초기 로드 번들**: 586 kB → 167 kB (**-71%**, -419 kB gzip)

사용자가 실제로 방문하는 탭만 다운로드되므로 초기 로딩 속도가 크게 향상.

### 커밋 내역 (세션 22)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `e8eee56` | perf: React.lazy() 코드 스플리팅으로 초기 번들 크기 71% 감소 |

---

## 최종 상태 (세션 22 기준) — 모든 TODO 완료

| 우선순위 | 항목 | 세션 | 상태 |
|---------|------|------|------|
| CRITICAL | ResultsAnalysis API 연동 | 이전 | ✅ |
| CRITICAL | EvaluatorDashboard API 연동 | 이전 | ✅ |
| HIGH | AIResultsInterpretationPage API 연동 | 이전 | ✅ |
| HIGH | ESLint 경고 전체 수정 (Compiled successfully) | 12-16 | ✅ |
| MEDIUM | EvaluatorSurveyPage API 연동 | 18 | ✅ |
| MEDIUM | RealTimeParticipantMonitor 폴링 | 17 | ✅ |
| MEDIUM | PairwiseEvaluation API 연동 | 19 | ✅ |
| MEDIUM | PaymentSystem KG이니시스 안내 UI | 20 | ✅ |
| MEDIUM | PaperManagement dead code 제거 | 21 | ✅ |
| LOW | 번들 최적화 (code splitting) | 22 | ✅ |

### 남은 LOW (기능 외, 비개발 단계)
- 백엔드 SMTP 설정 (이메일 발송)
- KG이니시스 PG 실제 연동 (사업 준비 후)
- Render.com PostgreSQL → Neon.tech 이전 (비용 절약)

---

## 세션 23 — 전체 시스템 점검 및 핵심 버그 수정

### 작업 배경
사용자 보고: "프로젝트 생성/조회가 로그인 상태에서도 안 됨. 에이전트들이 개발을 엉망으로 만든 것 같다."
→ 종합 감사(audit) 요청: 백엔드 + 프론트엔드 전체 점검

### 점검 결과 요약

#### 백엔드 감사 (7개 앱)
- **CRITICAL**: ~~exports/workshops AllowAny 권한~~ → 이미 IsAuthenticated 적용됨
- **HIGH**: evaluations 이메일 발송 2개 TODO (Celery 미구현) → 추후 과제
- **HIGH**: exports PDF → 501 Not Implemented (알려진 미구현)
- **MEDIUM**: subscriptions churn_rate 하드코딩(0), 결제 gateway 미연동 (의도적 미구현)

#### 프론트엔드 감사 (150+ 파일)
- **CRITICAL**: ~~RoleSwitcher 하드코딩 비밀번호~~ → 이미 API 검증으로 교체됨
- **HIGH**: ~~AdminOnlyDashboard mock 데이터~~ → 이미 실제 API 연동됨
- **HIGH**: ~~ResultsDataManager mock AHP~~ → 이미 실제 API 연동됨
- **HIGH**: ~~WorkshopManagement API 주석처리~~ → 이미 실제 API 연동됨
- **ACTUAL_HIGH**: personal-projects 편집/삭제 버튼 → TODO console.log만 있었음 ✅ 수정

### 수정된 실제 버그 (세션 22에서 발견/수정)

#### 세션 22 핵심 버그 (이미 수정된 항목 - c3c1e33)
1. `validateSession()` 잘못된 URL → `/api/service/accounts/me/`로 수정
2. `authService.loadTokensFromMemory()` access token 만료 시 refresh token까지 삭제 → access token만 삭제로 수정
3. `validateSession()` 실패 시 setUser(null) + localStorage 삭제 누락 → 추가

### 세션 23 수정 항목

| 파일 | 수정 내용 |
|------|---------|
| `App.tsx` | personal-projects 편집 버튼 → handleProjectSelect + model-building 탭 이동 |
| `App.tsx` | personal-projects 삭제 버튼 → deleteProject() 실제 API 호출 |
| `App.tsx` | handleProjectStatusChange debug console.log 제거 |
| `App.tsx` | personal-projects case console.log 제거 |
| `ProjectWorkflow.tsx` | handleProjectStatusChange PATCH API 호출 추가 (apiService import) |
| `dataService_clean.ts` | 60+ console.log/warn/error 전체 제거 |
| `dataService_clean.ts` | createProject beforeCount 미사용 변수 제거 |

### 커밋 내역 (세션 23)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | `e8eb6bc` | fix: 프로젝트 편집/삭제 버튼 실제 기능 연결 및 코드 품질 개선 |

### 세션 23 남은 과제 (우선순위순)

| 우선순위 | 항목 | 비고 |
|---------|------|------|
| HIGH | ProjectCompletion 이메일 발송 | 백엔드 SMTP 설정 필요 |
| HIGH | SurveyLinkManager SMS/Kakao 발송 | 현재 브라우저 네이티브만 (mailto) |
| MEDIUM | App.tsx 사용자 탭/프로젝트 상태 영속성 | 사용자 설정 API 필요 |
| MEDIUM | SystemReset 실제 backend API | 백엔드 엔드포인트 없음 |
| LOW | KG이니시스 PG 연동 | 사업 준비 후 |
| LOW | 백엔드 SMTP 설정 | 이메일 서비스 계약 후 |

---

## 세션 24 — SurveyLinkManager + EvaluatorAssignment 핵심 버그 수정

### 작업 배경

세션 23 이후 추가 감사에서 두 컴포넌트 간 데이터 단절 문제 발견:
- `EvaluatorAssignment.tsx`는 평가자를 `project.settings.evaluators` JSON에 저장
- `SurveyLinkManager.tsx`는 Django Evaluation 모델(`/api/service/evaluations/evaluations/`)만 읽음
- 결과: EvaluatorAssignment로 등록한 평가자가 SurveyLinkManager에 전혀 표시되지 않음 (완전한 기능 단절)

추가 발견:
- SurveyLinkManager가 생성하는 링크 형식 오류: `?tab=anonymous-evaluator&token=X` → 'anonymous-evaluator'는 App.tsx의 유효 탭 목록에 없음
- EvaluatorAssignment가 생성하는 링크 형식 오류: `/evaluator?project=X&key=Y` → GitHub Pages에서 `/evaluator` 경로 404 발생

### 수정 1: SurveyLinkManager.tsx

**파일**: `src/components/admin/SurveyLinkManager.tsx`

#### 핵심 변경: `loadLinks()` 함수 전면 재작성

1. **3개 병렬 요청**으로 확장:
   - `GET /api/service/evaluations/evaluations/?project={id}` (기존)
   - `GET /api/service/evaluations/invitations/?project={id}` (기존)
   - `GET /api/service/projects/projects/{id}/` (신규 추가)

2. **두 소스 통합**:
   ```typescript
   // 소스 1: Django Evaluation 레코드 → id 접두어 'eval-'
   const djangoLinks = evals.map(ev => ({
     id: `eval-${ev.id}`,
     link: token
       ? `${base}/?project=${projectId}&token=${token}`     // 초대 토큰 있을 때
       : `${base}/?project=${projectId}&evaluation=${ev.id}` // 없을 때
   }));

   // 소스 2: project.settings.evaluators → id 접두어 'settings-'
   const settingsLinks = settingsEvaluators
     .filter(ev => ev.access_key)
     .filter(ev => !djangoEmails.has(ev.email.toLowerCase())) // 중복 제거
     .map(ev => ({
       id: `settings-${ev.id || ev.access_key}`,
       link: `${base}/?project=${projectId}&key=${ev.access_key}`
     }));
   ```

3. **링크 형식 수정**:
   - 이전: `?tab=anonymous-evaluator&token=X` → App.tsx에서 처리 불가
   - 이후: `?project=X&token=Y` or `?project=X&key=Y` → App.tsx `evaluator-workflow` case에서 `urlParams.get('token') || urlParams.get('key')` 처리

4. **base URL 계산** (GitHub Pages + localhost 모두 지원):
   ```typescript
   const base = window.location.href.split('?')[0].replace(/\/$/, '');
   // localhost: http://localhost:3000
   // GitHub Pages: https://aebonlee.github.io/ahp_app
   ```

5. **`buildEvalLink()` 제거**: 잘못된 형식(`?tab=anonymous-evaluator`)을 사용하던 함수 삭제

### 수정 2: EvaluatorAssignment.tsx

**파일**: `src/components/admin/EvaluatorAssignment.tsx`

#### 변경 사항

| 항목 | 변경 전 | 변경 후 |
|------|---------|---------|
| 링크 형식 (loadProjectEvaluators) | `/evaluator?project=X&key=Y` (잘못된 경로) | `/?project=X&key=Y` (base URL 방식) |
| 링크 형식 (handleAddEvaluator) | `/evaluator?project=X&key=Y` | `/?project=X&key=Y` |
| `demographicSurveyUrl` 생성 | `/demographic-survey?project=X&evaluator=Y&key=Z` | **제거** (사용되지 않는 경로) |
| 디버그 console.log | 16개 | **전부 제거** |
| 저장 버튼 onClick | async + console.log | `showActionMessage()` 직접 호출 |

### 결과

```
Compiled successfully.
main bundle: 165.27 kB (변화 없음)
ESLint 경고: 0개
```

### 커밋 내역 (세션 24)

| 레포 | 커밋 | 내용 |
|------|------|------|
| 프론트 | (이후 커밋) | fix: SurveyLinkManager+EvaluatorAssignment 링크 형식 수정 및 데이터 소스 통합 |

### 세션 24 이후 남은 과제

| 우선순위 | 항목 | 비고 |
|---------|------|------|
| MEDIUM | App.tsx N×3 API 과호출 | 이미 수정됨 (세션 23 후반) |
| MEDIUM | App.tsx 탭/프로젝트 상태 영속성 | 사용자 설정 API 필요 |
| MEDIUM | SystemReset 실제 backend API | 백엔드 엔드포인트 없음 |
| LOW | KG이니시스 PG 연동 | 사업 준비 후 |
| LOW | 백엔드 SMTP 설정 | 이메일 서비스 계약 후 |
| LOW (defer) | 이메일 자동 발송 | 연구자가 링크 복사해서 수동 발송 |

---

## 세션 25 — API URL 버그 수정 + console.log 전면 정리 + 성능 개선

### 작업 배경

세션 24 이후 추가 감사에서 발견한 문제들:
1. `apiService.ts`에 `/api/v1/` 레거시 경로가 남아있어 evaluatorAPI/projectAPI 호출이 404 발생
2. `EvaluatorWorkflow.tsx`가 `evaluatorToken`을 완전히 무시하고 401 오류 처리도 미흡
3. 전체 코드베이스에 debug console.log 약 200개+ 잔존 (이전 세션에서 일부만 제거)
4. `App.tsx fetchProjects()`가 프로젝트 N개마다 3번씩 API 호출 (N×3 성능 낭비)

### 수정 1: apiService.ts — 레거시 API URL 수정

**파일**: `src/services/apiService.ts`

| API 그룹 | 수정 전 | 수정 후 |
|---------|---------|---------|
| `evaluatorAPI.assign` | `/api/v1/evaluations/invitations/` | `/api/service/evaluations/invitations/` |
| `evaluatorAPI.fetchByProject` | `/api/v1/evaluations/invitations/?project=` | `/api/service/evaluations/invitations/?project=` |
| `evaluatorAPI.list` | `/api/v1/evaluations/evaluations/?project=` | `/api/service/evaluations/evaluations/?project=` |
| `evaluatorAPI.updateWeight` | `/api/v1/evaluations/invitations/{id}/` | `/api/service/evaluations/invitations/{id}/` |
| `evaluatorAPI.remove` | `/api/v1/evaluations/invitations/{id}/` | `/api/service/evaluations/invitations/{id}/` |
| `evaluatorAPI.fetchProgress` | `/api/v1/evaluations/evaluations/?project=` | `/api/service/evaluations/evaluations/?project=` |
| `evaluatorAPI.validateAccessKey` | `/api/v1/evaluations/invitations/by_token/` | `/api/service/evaluations/invitations/by_token/` |
| `projectAPI.fetchById` | `/api/v1/projects/projects/{id}/` | `/api/service/projects/projects/{id}/` |

### 수정 2: EvaluatorWorkflow.tsx — 401 처리 및 로그인 안내

**파일**: `src/components/evaluator/EvaluatorWorkflow.tsx`

**문제**: `evaluatorToken` prop을 받았으나 완전히 무시 (TODO 주석 + console.log만 있었음). 401/403 응답 시 일반 에러 화면만 표시.

**수정**:
- `needsLogin` state 추가
- 3개 API 병렬 호출 (`Promise.all`)
- 401/403 감지 → `setNeedsLogin(true)`
- "로그인이 필요합니다" UI: 접근 키 표시 + 로그인 페이지 이동 버튼

```typescript
if (needsLogin) {
  return (
    <Card>
      <div className="text-center py-8 space-y-4">
        <div className="text-4xl">🔒</div>
        <h2>로그인이 필요합니다</h2>
        {evaluatorToken && (
          <p className="text-sm text-blue-600 bg-blue-50 p-3 rounded">
            귀하의 고유 접근 키: <code>{evaluatorToken}</code>
          </p>
        )}
        <Button onClick={() => { window.location.href = loginUrl; }} variant="primary">
          로그인 페이지로 이동
        </Button>
      </div>
    </Card>
  );
}
```

### 수정 3: console.log 전면 정리 (200개+ 제거)

각 파일별로 background agent로 병렬 처리:

| 파일 | 제거 수 | 비고 |
|------|---------|------|
| `PersonalServiceDashboard.tsx` | 99개 | 전체 제거 완료 |
| `CriteriaManagement.tsx` | 37개 | 2개 유지 (catch블록 유일 오류 신호) |
| `SystemManagement.tsx` | 24개 | 1개 유지 (monitorTask catch) |
| `MyProjects.tsx` | 19개 | 전체 제거 완료 |
| `AlternativeManagement.tsx` | 13개 | 1개 유지 |
| `EvaluatorDataManager.tsx` | 15개 | 전체 제거 |
| `EvaluatorManagement.tsx` | 4개 | 전체 제거 |
| `UsageManagement.tsx` | 4개 | 전체 제거 |
| `EnhancedEvaluatorManagement.tsx` | 6개 | 전체 제거 |
| `Sidebar.tsx` | 9개 | 2개 유지 (JSON.parse catch) |
| `Header.tsx` | 2개 | 3개 유지 (catch 유일 신호) |
| `Layout.tsx` | 3개 | 전체 제거 |

**유지 기준**: catch 블록 내 `showActionMessage`/`setError` 등 다른 오류 처리가 없는 경우에만 유지 (단, emoji 제거).

### 수정 4: App.tsx fetchProjects() 성능 개선

**파일**: `src/App.tsx`

**문제**: 프로젝트 목록 로드 시 각 프로젝트마다 criteria/alternatives/evaluators API를 3번 추가 호출 → N개 프로젝트 = 1 + 3N번 API 호출.

**수정**: 프로젝트 목록 API가 이미 `criteria_count`, `alternatives_count`를 포함하므로 직접 사용. evaluators는 `project.settings.evaluators?.length` 또는 `project.evaluator_count` 필드에서 추출.

```typescript
// 변경 전: Promise.all per project (N×3 API calls)
const projectsWithCounts = await Promise.all(
  projectsData.map(async (project) => {
    const [criteriaData, alternativesData, evaluatorsData] = await Promise.all([...]);
    ...
  })
);

// 변경 후: 단순 매핑 (0 추가 API calls)
const projectsWithCounts = projectsData.map((project) => {
  const criteriaCount = project.criteria_count ?? 0;
  const alternativesCount = project.alternatives_count ?? 0;
  const evaluatorCount = project.settings?.evaluators?.length ?? project.evaluator_count ?? 0;
  ...
});
```

### 빌드 검증

```
Compiled successfully.
File sizes after gzip:
  165.41 kB   build/static/js/main.3079f17a.js (이전 대비 -226B)
  611.abdd3583.chunk.js: -2.01 kB
  576.4f20adb9.chunk.js: -1.53 kB
```

### 커밋 내역 (세션 25)

| 커밋 | 내용 |
|------|------|
| `bfa794c` | fix: API URL 수정 및 console.log 전면 정리 (200개+) |
| `c1671ed` | perf: fetchProjects 성능 개선 - 중복 API 호출 제거 |

### 세션 25 이후 남은 과제

| 우선순위 | 항목 | 비고 |
|---------|------|------|
| MEDIUM | SystemReset 실제 backend API | 백엔드 엔드포인트 없음 |
| MEDIUM | window.confirm() 50개+ → 커스텀 모달 | UX 개선 (defer) |
| LOW | 백엔드 SMTP | 이메일 서비스 계약 후 |
| LOW | KG이니시스 PG | 사업 준비 후 |
