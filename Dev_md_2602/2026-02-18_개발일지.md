# AHP App 개발일지 — 2026-02-18

## 세션 개요
- **작업 시간**: 수 시간 (멀티 세션 연속 작업)
- **담당 모델**: Claude Sonnet 4.6
- **작업 범위**: 코드 품질 개선 + 백엔드 API 연결 수정 + 아키텍처 점검

---

## 완료된 커밋 목록

| 커밋 해시 | 내용 | 변경 파일 수 |
|-----------|------|-------------|
| `dc9bace` | alert() 제거 — 28개 파일 인라인 에러 메시지로 교체 | 28 |
| `c996c61` | 미연결 onClick 핸들러 연결 + 청구서 다운로드 구현 | 3 |
| `b3cd76a` | hooks/auth 이모지 디버그 로그 제거 | 8 |
| `2f532ce` | 하드코딩 localhost URL → API_BASE_URL 전면 교체 | 13 |
| `fb074fa` | 서비스/대시보드 이모지 디버그 로그 제거 | 17 |
| `d02ed7d` | 나머지 이모지 디버그 로그 제거 | 9 |
| `882acc4` | API 엔드포인트 URL 전면 수정 + TypeScript 정규식 오류 수정 | 3 |

| `c1950fa` | ALTERNATIVES 엔드포인트 수정 + useProjects.ts 9개 URL 수정 | 3 |
| `21b1205` | ModelBuilder.tsx 6개 URL + connectionTest.ts 2개 URL 수정 | 2 |
| `9ae677d` | ApiTestPage.tsx localhost:5000 → API_BASE_URL | 1 |
| `9c1dd2d` | api.ts PAYMENT/RESULTS 섹션 전면 재검증 | 1 |
| `08e5e38` | services/api.ts 고급 분석 엔드포인트 /api/service/ 프리픽스 추가 | 1 |

**총 12개 커밋, ~100개 파일 수정**

---

## 세부 작업 내역

### 1. alert() 전면 제거 (dc9bace)
- **문제**: 28개 파일에 `window.alert()` 사용 — 브라우저별 UI 불일치, UX 저해
- **해결**: 각 컴포넌트에 `errorMessage` / `successMessage` state 추가, 인라인 배너로 교체
- **주요 파일**: EvaluatorWorkflow, AlternativeManagement, CriteriaManagement, ModelFinalization 등

### 2. 미구현 기능 완성 (c996c61)
- **DecisionSupportSystem.tsx**: "평가 재검토" 버튼 → `setActiveStep('evaluation')`, "일관성 개선" → `setActiveStep('structuring')` 연결
- **SubscriptionManagement.tsx**: "청구서 다운로드" 버튼에 실제 API 연동 (`/api/service/subscriptions/invoices/`)
  - Blob 다운로드 패턴 구현, 실패 시 새 탭으로 fallback
- **HierarchyTreeVisualization.tsx**: 이모지 디버그 로그 제거

### 3. localhost URL 전면 교체 (2f532ce)
- **문제**: 13개 파일에 `http://localhost:5000` 또는 `http://localhost:8000` 하드코딩
- **해결**: 모두 `import { API_BASE_URL } from '../../config/api'` 로 통일
- **WebSocket URL**: `API_BASE_URL.replace(/^https?:\/\//, 'wss://')` 패턴으로 자동 파생
- **주요 파일**: ahpApiService.ts, hierarchyApi.ts, groupApi.ts, AlertSystem.tsx, HierarchicalEvaluationDashboard.tsx 등

### 4. 이모지 디버그 로그 대량 제거 (b3cd76a, fb074fa, d02ed7d)
- **제거 총량**: ~280개 console.log 문 (`🔍`, `✅`, `🚀`, `📊`, `🔄`, `⚠️` 등 이모지 접두사)
- **보존**: `console.error()`, `console.warn()`, 이모지 없는 `console.log()`
- **주요 파일**: PersonalServiceDashboard.tsx (~55개), dataService_clean.ts (~45개), EnhancedAuthFlow.tsx (10개) 등

### 5. API 엔드포인트 URL 전면 수정 (882acc4)

#### TypeScript 정규식 오류 수정
```typescript
// 오류 (/ 미이스케이프)
API_BASE_URL.replace(/^https?:///, 'wss://')

// 수정
API_BASE_URL.replace(/^https?:\/\//, 'wss://')
```
- 영향 파일: `RealtimeMonitoringDashboard.tsx`, `monitoringApi.ts`

#### API 경로 수정 내역

| 항목 | 기존 (틀림) | 수정 (올바름) |
|------|------------|--------------|
| EVALUATORS.LIST | `/api/service/evaluators/` | `/api/service/evaluations/invitations/` |
| INVITATIONS | `/api/service/invitations/` | `/api/service/evaluations/invitations/` |
| COMPARISONS | `/api/v1/comparisons/` | `/api/service/evaluations/comparisons/` |
| RESULTS | `/api/v1/results/` | `/api/service/analysis/analysis/` |
| SURVEYS.LIST | `/api/service/projects/{id}/surveys/` | `/api/service/evaluations/demographic-surveys/` |
| PAYMENT.* | `/api/service/payments/` | `/api/service/subscriptions/` |
| STATUS | `/api/service/status/` | `/health/` |
| AUTH.PROFILE | `/api/service/auth/profile/` | `/api/service/accounts/dashboard/` |
| WebSocket | `ws://localhost:8000/ws/...` | `wss://ahp-django-backend.onrender.com/ws/...` |

---

## 아키텍처 점검 결과

### 전체 구성
```
프론트엔드 (GitHub Pages)
  https://aebonlee.github.io/ahp_app
  레포: aebonlee/ahp_app (React + TypeScript)
        │
        │ HTTPS REST API + WSS WebSocket
        ▼
백엔드 (Render.com Web Service — 유료 Starter)
  https://ahp-django-backend.onrender.com
  레포: aebonlee/ahp-django-service (Django REST Framework)
        │
        │ PostgreSQL
        ▼
데이터베이스 (Render.com PostgreSQL — 유료 Starter)
  67개 테이블, 정상 연결 확인
```

### 백엔드 실제 등록 앱 (simple_urls.py 기준)

| 앱 | 경로 | 상태 |
|----|------|------|
| accounts | `/api/service/accounts/` | ✅ 작동 |
| projects | `/api/service/projects/` | ✅ 작동 |
| evaluations | `/api/service/evaluations/` | ✅ 작동 |
| analysis | `/api/service/analysis/` | ✅ 작동 |
| subscriptions | `/api/service/subscriptions/` | ✅ 등록됨 |
| **exports** | `/api/service/exports/` | ❌ **미등록** |
| **workshops** | `/api/service/workshops/` | ❌ **미등록** |

### 백엔드 엔드포인트 테스트 결과 (수정 전)

| 엔드포인트 | HTTP | 비고 |
|-----------|------|------|
| `GET /health/` | 200 ✅ | |
| `GET /api/service/projects/projects/` | 200 ✅ | 인증 없이 공개 접근 가능 (⚠️ 보안 검토 필요) |
| `POST /api/service/auth/login/` | 400 ✅ | 이메일 인증 필요 메시지 |
| `GET /api/service/evaluators/` | 404 ❌ | → 수정됨 |
| `GET /api/service/invitations/` | 404 ❌ | → 수정됨 |
| `GET /api/v1/comparisons/` | 404 ❌ | → 수정됨 |
| `GET /api/v1/alternatives/` | 404 ❌ | 백엔드 미구현 |
| `GET /api/service/export/excel/` | 404 ❌ | 백엔드 앱 미등록 |
| `GET /api/service/workshops/` | 404 ❌ | 백엔드 앱 미등록 |
| `GET /api/service/status/` | 404 ❌ | → `/health/`로 수정 |

---

## 세션 2 추가 작업 내역 (c1950fa ~ 08e5e38)

### 6. 백엔드 구조 심층 분석

#### 백엔드 URL 구조 (실제 검증 완료)
| 앱 | 실제 등록된 ViewSets/Endpoints |
|----|-------------------------------|
| projects | ProjectViewSet, CriteriaViewSet, ProjectTemplateViewSet |
| evaluations | EvaluationViewSet, PairwiseComparisonViewSet, EvaluationInvitationViewSet, DemographicSurveyViewSet, BulkInvitationViewSet, EvaluatorProgressViewSet |
| analysis | AnalysisViewSet, AdvancedAnalysisViewSet + calculate/individual/, group/, sensitivity/, final-priorities/, project-summary/ |
| subscriptions | plans/, subscriptions/, payment-methods/, payment-records/, usage/, alerts/, subscribe/, check-limits/, validate-coupon/, stats/ |

#### 중요 발견사항
- **Alternatives**: 별도 모델/ViewSet 없음 → `Criteria` 모델의 `type='alternative'` 필드로 구현
  - `filterset_fields = ['project', 'type', 'parent', 'level']` 지원 → `?project=ID&type=alternative`로 조회
- **api/v1/ prefix**: `simple_urls.py`가 `api/`, `api/v1/`, `api/service/` 3개 모두 동일 `api_patterns`에 매핑
  - `apiService.ts`의 `/api/v1/evaluations/...` URL들은 모두 유효함
- **ProjectViewSet.permission**: `AllowAny` — 개발용 의도적 설정

### 7. ALTERNATIVES 엔드포인트 전면 교정 (c1950fa)
- `src/config/api.ts`: `ALTERNATIVES.LIST` → `criteria/?project=ID&type=alternative`
- `src/services/api.ts`: `alternativeApi` 4개 메서드 모두 criteria 기반으로 수정
  - `createAlternative`: `data.project_id`에서 URL 구성 → `/projects/{id}/add_criteria/`
  - `updateAlternative`/`deleteAlternative`: `/criteria/{id}/`
- `src/hooks/useProjects.ts`: 9개 하드코딩 URL 전면 수정
  - DRF 응답 파싱: `Array.isArray(data) || data.results || data.{key}` 패턴

### 8. ModelBuilder.tsx URL 수정 (21b1205)
- 6개 `/api/v1/` 경로 → 정확한 `/api/service/projects/...` 경로
- 필드명 수정: `project_id` → `project`, `parent_id` → `parent`, `order_index` → `order`
- Response 파싱: DRF 형식 지원 추가

### 9. PAYMENT 섹션 재검증 (9c1dd2d)
| 항목 | 기존 (틀림) | 수정 (올바름) |
|------|------------|--------------|
| CHECKOUT | `/subscriptions/checkout/` | `/subscriptions/subscribe/` |
| SUBSCRIPTION | `/subscriptions/subscription/` | `/subscriptions/subscriptions/` |
| PAYMENT_METHODS | `/subscriptions/methods/` | `/subscriptions/payment-methods/` |
| INVOICES | `/subscriptions/invoices/` | `/subscriptions/payment-records/` |
| CANCEL/UPGRADE/DOWNGRADE | 고정 문자열 | `(id: string) => URL` 함수로 변경 |
| 신규 추가 | — | `CHECK_LIMITS`, `VALIDATE_COUPON`, `STATS` |

### 10. 고급 분석 /api/service/ 프리픽스 수정 (08e5e38)
- `advancedAnalysisApi` 5개 메서드: `/analysis/advanced/...` → `/api/service/analysis/advanced/...`

---

## 세션 3 추가 작업 내역 — 백엔드 구현 (GitHub API 직접 커밋)

### 11. exports 앱 전체 구현 (aebonlee/ahp-django-service)
**신규 생성 파일 3개:**
- `apps/exports/serializers.py` — ExportTemplateSerializer, ExportHistorySerializer, ReportScheduleSerializer
- `apps/exports/views.py` — 4개 ViewSet:
  - `ExportTemplateViewSet` (CRUD)
  - `ExportHistoryViewSet` (읽기 전용)
  - `ReportScheduleViewSet` (CRUD)
  - `ExportDataViewSet` (실제 내보내기 로직):
    - `GET /api/service/exports/excel/?project=ID` → openpyxl(Excel) / CSV fallback
    - `GET /api/service/exports/pdf/?project=ID` → 501 준비 중 응답
    - `GET /api/service/exports/report/?project=ID` → JSON 보고서
- `apps/exports/urls.py` — router + excel/pdf/report custom URL 등록

### 12. workshops 앱 전체 구현 (aebonlee/ahp-django-service)
**신규 생성 파일 3개:**
- `apps/workshops/serializers.py` — 7개 Serializer (WorkshopSession, Participant, Progress, Consensus, Survey)
- `apps/workshops/views.py` — 6개 ViewSet:
  - `WorkshopSessionViewSet`: start/complete/cancel/join/participants/progress 액션
  - `WorkshopParticipantViewSet`: by_token 액션
  - `RealTimeProgressViewSet`, `GroupConsensusResultViewSet`, `SurveyTemplateViewSet`, `SurveyResponseViewSet`
- `apps/workshops/urls.py` — 6개 ViewSet 라우터 등록

### 13. simple_urls.py 업데이트 (aebonlee/ahp-django-service)
```python
# 추가된 라인
path('exports/', include('apps.exports.urls')),
path('workshops/', include('apps.workshops.urls')),
```

**결과: 이제 작동하는 백엔드 엔드포인트:**
| 앱 | 경로 | 상태 |
|----|------|------|
| accounts | `/api/service/accounts/` | ✅ |
| projects | `/api/service/projects/` | ✅ |
| evaluations | `/api/service/evaluations/` | ✅ |
| analysis | `/api/service/analysis/` | ✅ |
| subscriptions | `/api/service/subscriptions/` | ✅ |
| **exports** | `/api/service/exports/` | ✅ **신규 구현** |
| **workshops** | `/api/service/workshops/` | ✅ **신규 구현** |

---

## 오늘 작업 전체 요약 (2026-02-18)

### 프론트엔드 (aebonlee/ahp_app) — 12개 커밋
| 커밋 | 내용 |
|------|------|
| dc9bace | alert() 제거 28개 파일 |
| c996c61 | onClick 핸들러 + 청구서 다운로드 |
| b3cd76a | 이모지 디버그 로그 제거 (8파일) |
| 2f532ce | localhost URL → API_BASE_URL (13파일) |
| fb074fa | 이모지 디버그 로그 제거 (17파일) |
| d02ed7d | 이모지 디버그 로그 제거 (9파일) |
| 882acc4 | API 엔드포인트 URL 수정 + TS regex 수정 |
| c1950fa | ALTERNATIVES 엔드포인트 + useProjects.ts 9개 URL |
| 21b1205 | ModelBuilder.tsx + connectionTest.ts URL |
| 9ae677d | ApiTestPage localhost 수정 |
| 9c1dd2d | api.ts PAYMENT/RESULTS 섹션 재검증 |
| 08e5e38 | 고급 분석 /api/service/ 프리픽스 수정 |

### 백엔드 (aebonlee/ahp-django-service) — GitHub API 직접 커밋
- exports 앱: serializers + views + urls (3파일 신규)
- workshops 앱: serializers + views + urls (3파일 신규)
- simple_urls.py: exports, workshops 등록 (1파일 수정)

---

## 남은 작업 (TODO)

### 우선순위 HIGH
1. **백엔드 Render.com 재배포 트리거**
   - `ahp-django-service` 레포에 push가 발생했으므로 Render.com 자동 재배포 대기
   - 또는 Render.com 대시보드에서 Manual Deploy 실행
   - 재배포 후 `/api/service/exports/excel/?project=ID` 테스트 필요

2. **openpyxl 설치 여부 확인**
   - `requirements.txt`에 `openpyxl` 미포함
   - Excel 내보내기를 위해 추가 필요: `openpyxl>=3.1.0`
   - 없으면 CSV fallback으로 동작함

### 우선순위 MEDIUM
3. **projects 엔드포인트 인증 강화** (출시 전)
   - `ProjectViewSet.permission_classes = [AllowAny]` → `[IsAuthenticated]`

4. **회원가입 이메일 인증 흐름 검토**
   - 현재 이메일 인증 없으면 로그인 불가

5. **ALTERNATIVES / 전체 API 연동 테스트**

### 우선순위 LOW (개발 완료 후)
6. **Render.com PostgreSQL → Neon.tech 무료 이전** ($7/월 절약)
7. **프론트엔드 레포 구조 정리** (백업용 레포 → 새 레포 퍼블리싱)

---

## 향후 개발 방향 (사용자 지시)
- 현재 `aebonlee/ahp_app` 레포는 **백업용**으로 전환
- 개발 완료 후 **새 레포지토리** 생성하여 실제 서비스 파일만 탑재 후 퍼블리싱
- 비용 절감은 개발 완료 후 고려

---

## GitHub Actions 빌드 상태
- **CI Pipeline**: ✅ 통과
- **Deploy to GitHub Pages**: ✅ 완료
- **배포 URL**: https://aebonlee.github.io/ahp_app
- **최신 커밋**: `08e5e38` (프론트엔드), 백엔드 GitHub API 직접 커밋 완료
