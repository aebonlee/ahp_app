name: Quick Deploy

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests and deploy directly'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: quick-deploy
  cancel-in-progress: true

jobs:
  quick-deploy:
    name: Quick Deploy to Pages
    runs-on: ubuntu-latest
    environment:
      name: github-pages-quick
      url: https://aebonlee.github.io/ahp_app/
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: 'recursive'
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: |
        echo "ğŸ”§ Installing dependencies..."
        npm ci --legacy-peer-deps
      working-directory: ahp_app
      
    - name: Quick test (optional)
      if: ${{ !inputs.skip_tests }}
      run: |
        echo "ğŸ§ª Running quick tests..."
        npm test -- --coverage --watchAll=false --testTimeout=5000 --maxWorkers=2 --passWithNoTests
      working-directory: ahp_app
      continue-on-error: true
      env:
        CI: true
        
    - name: Build application
      run: |
        echo "ğŸ—ï¸ Building application..."
        npm run build
      working-directory: ahp_app
      env:
        CI: false
        PUBLIC_URL: /ahp_app
        GENERATE_SOURCEMAP: false
        REACT_APP_OPENAI_API_KEY: API_KEY_NOT_SET
        
    - name: Verify build
      run: |
        if [ -d "build" ]; then 
          echo "âœ… Build completed successfully"
          echo "ğŸ“Š Build stats:"
          du -sh build/
          echo "ğŸ“ Main files:"
          find build -name "*.js" -o -name "*.css" | head -5
        else 
          echo "âŒ Build failed"
          exit 1
        fi
      working-directory: ahp_app
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
        
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v4
      with:
        path: ./ahp_app/build
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
        
    - name: Deploy success
      run: |
        echo "ğŸš€ Quick deployment completed!"
        echo "ğŸŒ Site: https://aebonlee.github.io/ahp_app/"
        echo "â±ï¸ Deployed at: $(date -u)"