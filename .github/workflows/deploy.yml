name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Test basic setup
      run: |
        echo "=== Basic Setup Test ==="
        echo "âœ… Repository checked out successfully"
        echo "ğŸ“ Current directory: $(pwd)"
        echo "ğŸ“‹ Repository contents:"
        ls -la
        echo "âœ… Step 1 completed successfully"
        
    - name: Detect project structure
      run: |
        echo "=== Project Structure Analysis ==="
        echo "ğŸ” Checking for frontend source files..."
        if [ -d "ahp_frontend_src" ]; then
          echo "âœ… Frontend source directory found"
          echo "ğŸ“ Frontend source contents:"
          ls -la ahp_frontend_src/ | head -10
        else
          echo "âŒ Frontend source directory not found"
        fi
        
        echo "ğŸ” Checking for package.json..."
        if [ -f "ahp_package.json" ]; then
          echo "âœ… Package configuration found"
          echo "ğŸ“‹ Package info:"
          head -10 ahp_package.json
        else
          echo "âŒ Package configuration not found"
        fi
        
        echo "ğŸ” Checking for public files..."
        if [ -d "ahp_frontend_public" ]; then
          echo "âœ… Public directory found"
          echo "ğŸ“ Public contents:"
          ls -la ahp_frontend_public/
        else
          echo "âŒ Public directory not found"
        fi
        echo "âœ… Step 2 completed successfully"
        
    - name: Setup Node.js environment
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ahp_package.json
        
    - name: Verify Node.js setup
      run: |
        echo "=== Node.js Environment Verification ==="
        echo "ğŸ“¦ Node.js version:"
        node --version
        echo "ğŸ“¦ npm version:"
        npm --version
        echo "ğŸ” Checking npm cache:"
        npm config get cache
        echo "âœ… Step 3 completed successfully"
        
    - name: Prepare project structure
      run: |
        echo "=== Project Structure Preparation ==="
        echo "ğŸ”§ Creating proper package.json..."
        if [ -f "ahp_package.json" ]; then
          cp ahp_package.json package.json
          echo "âœ… package.json created from ahp_package.json"
        else
          echo "âŒ ahp_package.json not found"
          exit 1
        fi
        
        echo "ğŸ”§ Setting up source directories..."
        if [ -d "ahp_frontend_src" ] && [ -d "ahp_frontend_public" ]; then
          mkdir -p src
          cp -r ahp_frontend_src/* src/
          mkdir -p public  
          cp -r ahp_frontend_public/* public/
          echo "âœ… Source and public directories prepared"
          echo "ğŸ“ Source files copied:"
          ls -la src/ | head -5
          echo "ğŸ“ Public files copied:"
          ls -la public/ | head -5
        else
          echo "âŒ Required directories not found"
          echo "Available directories:"
          ls -la
          exit 1
        fi
        echo "âœ… Step 4 completed successfully"
        
    - name: Install dependencies
      run: |
        echo "=== Dependencies Installation ==="
        echo "ğŸ“¦ Installing npm dependencies..."
        npm ci --verbose
        echo "ğŸ“‹ Installed packages:"
        npm list --depth=0
        echo "âœ… Step 5 completed successfully"
        
    - name: Build frontend
      env:
        GENERATE_SOURCEMAP: false
        PUBLIC_URL: .
        CI: false
      run: |
        echo "=== Frontend Build Process ==="
        echo "ğŸ—ï¸ Building React application..."
        echo "Environment variables:"
        echo "GENERATE_SOURCEMAP=$GENERATE_SOURCEMAP"
        echo "PUBLIC_URL=$PUBLIC_URL"
        npm run build:frontend
        echo "ğŸ“ Build output:"
        ls -la build/
        echo "ğŸ“„ Build files:"
        find build/ -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
        echo "ğŸ“Š Build size:"
        du -sh build/
        echo "âœ… Step 6 completed successfully"
        
    - name: Setup GitHub Pages
      uses: actions/configure-pages@v5
      
    - name: Upload to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./build
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: Verify deployment
      run: |
        echo "=== Deployment Verification ==="
        echo "ğŸš€ Deployment completed successfully!"
        echo "ğŸ“ Deployment URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ” Checking deployment status..."
        if [ -n "${{ steps.deployment.outputs.page_url }}" ]; then
          echo "âœ… GitHub Pages URL available"
        else
          echo "âŒ GitHub Pages URL not available"
        fi
        echo "âœ… Step 7 completed successfully"