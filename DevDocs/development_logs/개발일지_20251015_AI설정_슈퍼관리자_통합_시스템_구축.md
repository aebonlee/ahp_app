# 개발일지 - AI 설정 슈퍼관리자 통합 시스템 구축
## OpenAI API 키 관리 및 회원별 AI 기능 연동 개발

**작성일**: 2025-10-15  
**개발자**: 사용자 + Claude Code (Sonnet 4)  
**작업 범위**: 프론트엔드 + 백엔드 + Django 관리자 페이지 통합  

---

## 📋 사용자 요구사항 분석

### 🎯 핵심 요구사항
```
1. 연구자들이 직접 API 키 발급이 어려울 수 있음
2. 슈퍼관리자가 AI 사용 요금제에 따라 회원별 설정 관리
3. 슈퍼관리자 모드에 AI 기능 관리 메뉴 추가
4. 회원별 AI 기능 연결 시스템 구축
5. 프론트엔드 + 백엔드 + Django 관리자 통합 관리
6. 개발 프롬프트 자동 저장 시스템
```

### 💡 해결 방안 설계
```
🏗️ 시스템 아키텍처:
├── 프론트엔드: 슈퍼관리자 AI 관리 대시보드
├── 백엔드: Django REST API (AI 설정 CRUD)
├── 데이터베이스: AI 설정 모델 + 회원 연동
├── Django 관리자: 통합 관리 인터페이스
└── 자동화: 프롬프트 저장 시스템
```

---

## 🗄️ 데이터베이스 모델 설계

### 1. AI 서비스 설정 모델
```python
# backend/models/ai_settings.py
from django.db import models
from django.contrib.auth.models import User

class AIServicePlan(models.Model):
    """AI 서비스 요금제"""
    PLAN_CHOICES = [
        ('free', '무료 (제한적)'),
        ('basic', '기본형 ($10/월)'),
        ('premium', '프리미엄 ($30/월)'),
        ('enterprise', '기업형 ($100/월)'),
    ]
    
    name = models.CharField(max_length=50, choices=PLAN_CHOICES, unique=True)
    monthly_cost = models.DecimalField(max_digits=10, decimal_places=2)
    monthly_token_limit = models.IntegerField()  # 월간 토큰 한도
    daily_request_limit = models.IntegerField()  # 일간 요청 한도
    features = models.JSONField(default=dict)  # 사용 가능 기능들
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.get_name_display()} - ${self.monthly_cost}/월"

class AIServiceSettings(models.Model):
    """AI 서비스 설정 (관리자가 관리)"""
    PROVIDER_CHOICES = [
        ('openai', 'OpenAI'),
        ('claude', 'Claude'),
        ('gemini', 'Google Gemini'),
    ]
    
    name = models.CharField(max_length=100)  # 설정 이름
    provider = models.CharField(max_length=20, choices=PROVIDER_CHOICES)
    api_key = models.TextField()  # 암호화 저장
    model_name = models.CharField(max_length=50, default='gpt-3.5-turbo')
    max_tokens = models.IntegerField(default=1000)
    temperature = models.FloatField(default=0.7)
    
    # 사용량 제한
    hourly_limit = models.IntegerField(default=100)
    daily_limit = models.IntegerField(default=1000)
    monthly_limit = models.IntegerField(default=10000)
    
    # 관리 정보
    is_active = models.BooleanField(default=True)
    created_by = models.ForeignKey(User, on_delete=models.CASCADE)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.name} ({self.provider})"

class UserAIAccess(models.Model):
    """사용자별 AI 접근 권한"""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='ai_access')
    ai_plan = models.ForeignKey(AIServicePlan, on_delete=models.CASCADE)
    ai_settings = models.ForeignKey(AIServiceSettings, on_delete=models.CASCADE, null=True, blank=True)
    
    # 사용량 추적
    tokens_used_today = models.IntegerField(default=0)
    tokens_used_month = models.IntegerField(default=0)
    requests_today = models.IntegerField(default=0)
    last_reset_date = models.DateField(auto_now_add=True)
    
    # 권한 설정
    is_enabled = models.BooleanField(default=True)
    can_use_advanced_features = models.BooleanField(default=False)
    
    # 관리 정보
    assigned_by = models.ForeignKey(User, on_delete=models.CASCADE, related_name='assigned_ai_access')
    assigned_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.user.username} - {self.ai_plan.name}"

class AIUsageLog(models.Model):
    """AI 사용 로그"""
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    ai_settings = models.ForeignKey(AIServiceSettings, on_delete=models.CASCADE)
    
    # 요청 정보
    request_type = models.CharField(max_length=50)  # 'chatbot', 'analysis', 'generation'
    prompt = models.TextField()
    response = models.TextField()
    
    # 사용량 정보
    tokens_used = models.IntegerField()
    cost = models.DecimalField(max_digits=10, decimal_places=4)
    response_time = models.FloatField()  # 응답 시간 (초)
    
    # 메타데이터
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return f"{self.user.username} - {self.request_type} ({self.created_at})"
```

### 2. 마이그레이션 파일 생성
```python
# backend/migrations/0001_ai_settings.py
from django.db import migrations, models
import django.db.models.deletion
from django.conf import settings

class Migration(migrations.Migration):
    initial = True
    
    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]
    
    operations = [
        migrations.CreateModel(
            name='AIServicePlan',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(choices=[('free', '무료 (제한적)'), ('basic', '기본형 ($10/월)'), ('premium', '프리미엄 ($30/월)'), ('enterprise', '기업형 ($100/월)')], max_length=50, unique=True)),
                ('monthly_cost', models.DecimalField(decimal_places=2, max_digits=10)),
                ('monthly_token_limit', models.IntegerField()),
                ('daily_request_limit', models.IntegerField()),
                ('features', models.JSONField(default=dict)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        # ... 다른 모델들
    ]
```

---

## 🖥️ 프론트엔드 개발

### 1. 슈퍼관리자 AI 관리 메뉴 추가
```typescript
// src/components/admin/SuperAdminAIManagement.tsx
import React, { useState, useEffect } from 'react';
import { AIServiceSettings, UserAIAccess, AIUsageLog } from '../../types/ai';
import { apiClient } from '../../services/api';
import PageHeader from '../common/PageHeader';
import Tooltip from '../common/Tooltip';
import UIIcon from '../common/UIIcon';

interface SuperAdminAIManagementProps {
  user?: User;
}

const SuperAdminAIManagement: React.FC<SuperAdminAIManagementProps> = ({ user }) => {
  const [activeTab, setActiveTab] = useState<'settings' | 'users' | 'usage' | 'billing'>('settings');
  const [aiSettings, setAiSettings] = useState<AIServiceSettings[]>([]);
  const [userAccess, setUserAccess] = useState<UserAIAccess[]>([]);
  const [usageLogs, setUsageLogs] = useState<AIUsageLog[]>([]);
  const [loading, setLoading] = useState(false);

  // 데이터 로드
  useEffect(() => {
    loadData();
  }, [activeTab]);

  const loadData = async () => {
    setLoading(true);
    try {
      switch (activeTab) {
        case 'settings':
          const settingsData = await apiClient.get('/api/admin/ai-settings/');
          setAiSettings(settingsData.data);
          break;
        case 'users':
          const usersData = await apiClient.get('/api/admin/user-ai-access/');
          setUserAccess(usersData.data);
          break;
        case 'usage':
          const usageData = await apiClient.get('/api/admin/ai-usage-logs/');
          setUsageLogs(usageData.data);
          break;
      }
    } catch (error) {
      console.error('데이터 로드 실패:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen" style={{ backgroundColor: 'var(--bg-base)' }}>
      <PageHeader
        title="AI 서비스 관리"
        description="사용자별 AI 기능 할당 및 사용량 모니터링"
        icon="🤖"
        onBack={() => window.history.back()}
      />
      
      <div className="container-adaptive section-padding">
        {/* 탭 네비게이션 */}
        <div className="mb-6">
          <div className="flex space-x-1 rounded-lg p-1" style={{ backgroundColor: 'var(--bg-secondary)' }}>
            {[
              { key: 'settings', label: 'AI 설정', icon: '⚙️' },
              { key: 'users', label: '사용자 관리', icon: '👥' },
              { key: 'usage', label: '사용량 모니터링', icon: '📊' },
              { key: 'billing', label: '요금 관리', icon: '💳' }
            ].map((tab) => (
              <button
                key={tab.key}
                onClick={() => setActiveTab(tab.key as any)}
                className={`flex items-center space-x-2 px-4 py-2 rounded-lg font-medium transition-colors ${
                  activeTab === tab.key ? 'text-white' : ''
                }`}
                style={{
                  backgroundColor: activeTab === tab.key ? 'var(--accent-primary)' : 'transparent',
                  color: activeTab === tab.key ? 'white' : 'var(--text-secondary)'
                }}
              >
                <UIIcon emoji={tab.icon} size="sm" />
                <span>{tab.label}</span>
              </button>
            ))}
          </div>
        </div>

        {/* 탭 콘텐츠 */}
        <div className="space-y-6">
          {activeTab === 'settings' && (
            <AISettingsTab settings={aiSettings} onUpdate={loadData} />
          )}
          
          {activeTab === 'users' && (
            <UserManagementTab userAccess={userAccess} onUpdate={loadData} />
          )}
          
          {activeTab === 'usage' && (
            <UsageMonitoringTab usageLogs={usageLogs} />
          )}
          
          {activeTab === 'billing' && (
            <BillingManagementTab />
          )}
        </div>
      </div>
    </div>
  );
};

// AI 설정 탭 컴포넌트
const AISettingsTab: React.FC<{
  settings: AIServiceSettings[]; 
  onUpdate: () => void;
}> = ({ settings, onUpdate }) => {
  const [showAddModal, setShowAddModal] = useState(false);

  return (
    <div className="space-y-6">
      {/* 헤더 */}
      <div className="flex items-center justify-between">
        <div>
          <h3 className="text-xl font-bold" style={{ color: 'var(--text-primary)' }}>
            AI 서비스 설정
          </h3>
          <p style={{ color: 'var(--text-secondary)' }}>
            OpenAI API 키 및 모델 설정을 관리합니다.
          </p>
        </div>
        <button
          onClick={() => setShowAddModal(true)}
          className="flex items-center space-x-2 px-4 py-2 rounded-lg font-medium text-white"
          style={{ backgroundColor: 'var(--accent-primary)' }}
        >
          <UIIcon emoji="➕" size="sm" />
          <span>새 AI 설정 추가</span>
        </button>
      </div>

      {/* 설정 목록 */}
      <div className="grid gap-4">
        {settings.map((setting) => (
          <div key={setting.id} className="p-4 rounded-lg border" 
               style={{ backgroundColor: 'var(--bg-primary)', borderColor: 'var(--border-light)' }}>
            <div className="flex items-start justify-between">
              <div className="flex-1">
                <div className="flex items-center space-x-3 mb-2">
                  <UIIcon emoji="🤖" size="lg" />
                  <div>
                    <h4 className="font-semibold" style={{ color: 'var(--text-primary)' }}>
                      {setting.name}
                    </h4>
                    <p className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                      {setting.provider} - {setting.model_name}
                    </p>
                  </div>
                </div>
                
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <div>
                    <span style={{ color: 'var(--text-muted)' }}>일간 한도:</span>
                    <span className="ml-2 font-medium" style={{ color: 'var(--text-primary)' }}>
                      {setting.daily_limit.toLocaleString()}
                    </span>
                  </div>
                  <div>
                    <span style={{ color: 'var(--text-muted)' }}>월간 한도:</span>
                    <span className="ml-2 font-medium" style={{ color: 'var(--text-primary)' }}>
                      {setting.monthly_limit.toLocaleString()}
                    </span>
                  </div>
                  <div>
                    <span style={{ color: 'var(--text-muted)' }}>상태:</span>
                    <span className={`ml-2 px-2 py-1 rounded-full text-xs font-medium ${
                      setting.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                      {setting.is_active ? '활성' : '비활성'}
                    </span>
                  </div>
                </div>
              </div>
              
              <div className="flex items-center space-x-2">
                <Tooltip content="설정 수정">
                  <button className="p-2 rounded-lg transition-colors"
                          style={{ backgroundColor: 'var(--bg-secondary)' }}>
                    <UIIcon emoji="✏️" size="sm" />
                  </button>
                </Tooltip>
                <Tooltip content="사용량 확인">
                  <button className="p-2 rounded-lg transition-colors"
                          style={{ backgroundColor: 'var(--bg-secondary)' }}>
                    <UIIcon emoji="📊" size="sm" />
                  </button>
                </Tooltip>
                <Tooltip content="설정 삭제">
                  <button className="p-2 rounded-lg transition-colors text-red-600">
                    <UIIcon emoji="🗑️" size="sm" />
                  </button>
                </Tooltip>
              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};
```

### 2. 사용자 AI 기능 할당 컴포넌트
```typescript
// src/components/admin/UserAIAssignment.tsx
const UserManagementTab: React.FC<{
  userAccess: UserAIAccess[];
  onUpdate: () => void;
}> = ({ userAccess, onUpdate }) => {
  const [users, setUsers] = useState<User[]>([]);
  const [selectedUser, setSelectedUser] = useState<User | null>(null);
  const [showAssignModal, setShowAssignModal] = useState(false);

  return (
    <div className="space-y-6">
      {/* 사용자별 AI 기능 할당 테이블 */}
      <div className="rounded-lg border overflow-hidden" 
           style={{ backgroundColor: 'var(--bg-primary)', borderColor: 'var(--border-light)' }}>
        <div className="px-6 py-4 border-b" style={{ borderColor: 'var(--border-light)' }}>
          <h4 className="font-semibold" style={{ color: 'var(--text-primary)' }}>
            사용자 AI 기능 할당 현황
          </h4>
        </div>
        
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr style={{ backgroundColor: 'var(--bg-secondary)' }}>
                <th className="px-6 py-3 text-left text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
                  사용자
                </th>
                <th className="px-6 py-3 text-left text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
                  요금제
                </th>
                <th className="px-6 py-3 text-left text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
                  사용량 (이번 달)
                </th>
                <th className="px-6 py-3 text-left text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
                  상태
                </th>
                <th className="px-6 py-3 text-left text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
                  관리
                </th>
              </tr>
            </thead>
            <tbody>
              {userAccess.map((access) => (
                <tr key={access.id} className="border-t" style={{ borderColor: 'var(--border-light)' }}>
                  <td className="px-6 py-4">
                    <div className="flex items-center space-x-3">
                      <div className="w-10 h-10 rounded-full flex items-center justify-center"
                           style={{ backgroundColor: 'var(--accent-pastel)' }}>
                        <UIIcon emoji="👤" size="lg" />
                      </div>
                      <div>
                        <div className="font-medium" style={{ color: 'var(--text-primary)' }}>
                          {access.user.username}
                        </div>
                        <div className="text-sm" style={{ color: 'var(--text-secondary)' }}>
                          {access.user.email}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span className="px-3 py-1 rounded-full text-sm font-medium"
                          style={{ 
                            backgroundColor: 'var(--accent-pastel)', 
                            color: 'var(--accent-dark)' 
                          }}>
                      {access.ai_plan.name}
                    </span>
                  </td>
                  <td className="px-6 py-4">
                    <div className="text-sm">
                      <div style={{ color: 'var(--text-primary)' }}>
                        {access.tokens_used_month.toLocaleString()} / {access.ai_plan.monthly_token_limit.toLocaleString()} 토큰
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-2 mt-1">
                        <div 
                          className="h-2 rounded-full" 
                          style={{ 
                            backgroundColor: 'var(--accent-primary)',
                            width: `${Math.min(100, (access.tokens_used_month / access.ai_plan.monthly_token_limit) * 100)}%`
                          }}
                        ></div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                      access.is_enabled ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                    }`}>
                      {access.is_enabled ? '활성' : '비활성'}
                    </span>
                  </td>
                  <td className="px-6 py-4">
                    <div className="flex items-center space-x-2">
                      <Tooltip content="설정 수정">
                        <button className="p-1 rounded transition-colors"
                                style={{ backgroundColor: 'var(--bg-secondary)' }}>
                          <UIIcon emoji="✏️" size="sm" />
                        </button>
                      </Tooltip>
                      <Tooltip content="사용량 초기화">
                        <button className="p-1 rounded transition-colors"
                                style={{ backgroundColor: 'var(--warning-pastel)' }}>
                          <UIIcon emoji="🔄" size="sm" />
                        </button>
                      </Tooltip>
                      <Tooltip content="기능 비활성화">
                        <button className="p-1 rounded transition-colors text-red-600">
                          <UIIcon emoji="🚫" size="sm" />
                        </button>
                      </Tooltip>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};
```

---

## 🔧 백엔드 API 개발

### Django REST API Views
```python
# backend/views/ai_management.py
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django.contrib.admin.views.decorators import staff_member_required
from django.utils.decorators import method_decorator
from django.db import transaction
from django.utils import timezone
from datetime import timedelta

from .models import AIServiceSettings, UserAIAccess, AIUsageLog, AIServicePlan
from .serializers import (
    AIServiceSettingsSerializer, 
    UserAIAccessSerializer, 
    AIUsageLogSerializer,
    AIServicePlanSerializer
)

@method_decorator(staff_member_required, name='dispatch')
class AIServiceSettingsViewSet(viewsets.ModelViewSet):
    """AI 서비스 설정 관리 (슈퍼관리자 전용)"""
    queryset = AIServiceSettings.objects.all()
    serializer_class = AIServiceSettingsSerializer
    permission_classes = [IsAuthenticated]
    
    def perform_create(self, serializer):
        serializer.save(created_by=self.request.user)
    
    @action(detail=True, methods=['post'])
    def test_connection(self, request, pk=None):
        """AI 서비스 연결 테스트"""
        setting = self.get_object()
        try:
            # API 키 유효성 검증 로직
            from ..services.ai_service import AIService
            ai_service = AIService(setting)
            is_valid = ai_service.test_connection()
            
            return Response({
                'success': True,
                'is_valid': is_valid,
                'message': '연결 테스트 성공' if is_valid else 'API 키가 유효하지 않습니다'
            })
        except Exception as e:
            return Response({
                'success': False,
                'error': str(e)
            }, status=status.HTTP_400_BAD_REQUEST)

@method_decorator(staff_member_required, name='dispatch')
class UserAIAccessViewSet(viewsets.ModelViewSet):
    """사용자 AI 접근 권한 관리"""
    queryset = UserAIAccess.objects.select_related('user', 'ai_plan', 'ai_settings')
    serializer_class = UserAIAccessSerializer
    permission_classes = [IsAuthenticated]
    
    @action(detail=False, methods=['post'])
    def bulk_assign(self, request):
        """사용자들에게 일괄 AI 기능 할당"""
        user_ids = request.data.get('user_ids', [])
        ai_plan_id = request.data.get('ai_plan_id')
        ai_settings_id = request.data.get('ai_settings_id')
        
        try:
            with transaction.atomic():
                for user_id in user_ids:
                    UserAIAccess.objects.update_or_create(
                        user_id=user_id,
                        defaults={
                            'ai_plan_id': ai_plan_id,
                            'ai_settings_id': ai_settings_id,
                            'assigned_by': request.user,
                            'is_enabled': True
                        }
                    )
            
            return Response({
                'success': True,
                'message': f'{len(user_ids)}명의 사용자에게 AI 기능이 할당되었습니다.'
            })
        except Exception as e:
            return Response({
                'success': False,
                'error': str(e)
            }, status=status.HTTP_400_BAD_REQUEST)
    
    @action(detail=True, methods=['post'])
    def reset_usage(self, request, pk=None):
        """사용량 초기화"""
        access = self.get_object()
        access.tokens_used_today = 0
        access.tokens_used_month = 0
        access.requests_today = 0
        access.last_reset_date = timezone.now().date()
        access.save()
        
        return Response({
            'success': True,
            'message': '사용량이 초기화되었습니다.'
        })

class AIUsageLogViewSet(viewsets.ReadOnlyModelViewSet):
    """AI 사용 로그 조회"""
    queryset = AIUsageLog.objects.select_related('user', 'ai_settings')
    serializer_class = AIUsageLogSerializer
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # 날짜 필터링
        start_date = self.request.query_params.get('start_date')
        end_date = self.request.query_params.get('end_date')
        if start_date:
            queryset = queryset.filter(created_at__date__gte=start_date)
        if end_date:
            queryset = queryset.filter(created_at__date__lte=end_date)
        
        # 사용자 필터링 (슈퍼관리자가 아닌 경우 자신의 로그만)
        if not self.request.user.is_staff:
            queryset = queryset.filter(user=self.request.user)
        
        return queryset.order_by('-created_at')
    
    @action(detail=False, methods=['get'])
    def usage_statistics(self, request):
        """사용량 통계"""
        from django.db.models import Sum, Count, Avg
        from django.db.models.functions import TruncDate
        
        # 일간 사용량 통계
        daily_stats = AIUsageLog.objects.filter(
            created_at__gte=timezone.now() - timedelta(days=30)
        ).values('created_at__date').annotate(
            total_tokens=Sum('tokens_used'),
            total_cost=Sum('cost'),
            request_count=Count('id'),
            avg_response_time=Avg('response_time')
        ).order_by('created_at__date')
        
        # 사용자별 통계
        user_stats = AIUsageLog.objects.filter(
            created_at__gte=timezone.now() - timedelta(days=30)
        ).values('user__username').annotate(
            total_tokens=Sum('tokens_used'),
            total_cost=Sum('cost'),
            request_count=Count('id')
        ).order_by('-total_tokens')[:10]
        
        return Response({
            'daily_statistics': list(daily_stats),
            'top_users': list(user_stats),
            'period': '최근 30일'
        })
```

### Serializers
```python
# backend/serializers/ai_serializers.py
from rest_framework import serializers
from django.contrib.auth.models import User
from .models import AIServiceSettings, UserAIAccess, AIUsageLog, AIServicePlan

class AIServicePlanSerializer(serializers.ModelSerializer):
    class Meta:
        model = AIServicePlan
        fields = '__all__'

class AIServiceSettingsSerializer(serializers.ModelSerializer):
    created_by_name = serializers.CharField(source='created_by.username', read_only=True)
    
    class Meta:
        model = AIServiceSettings
        fields = '__all__'
        extra_kwargs = {
            'api_key': {'write_only': True}  # 보안을 위해 읽기 시 숨김
        }

class UserAIAccessSerializer(serializers.ModelSerializer):
    user_info = serializers.SerializerMethodField()
    ai_plan_info = serializers.SerializerMethodField()
    ai_settings_info = serializers.SerializerMethodField()
    usage_percentage = serializers.SerializerMethodField()
    
    class Meta:
        model = UserAIAccess
        fields = '__all__'
    
    def get_user_info(self, obj):
        return {
            'id': obj.user.id,
            'username': obj.user.username,
            'email': obj.user.email,
            'first_name': obj.user.first_name,
            'last_name': obj.user.last_name
        }
    
    def get_ai_plan_info(self, obj):
        return {
            'name': obj.ai_plan.name,
            'display_name': obj.ai_plan.get_name_display(),
            'monthly_cost': obj.ai_plan.monthly_cost,
            'monthly_token_limit': obj.ai_plan.monthly_token_limit
        }
    
    def get_ai_settings_info(self, obj):
        if obj.ai_settings:
            return {
                'name': obj.ai_settings.name,
                'provider': obj.ai_settings.provider,
                'model_name': obj.ai_settings.model_name
            }
        return None
    
    def get_usage_percentage(self, obj):
        if obj.ai_plan.monthly_token_limit > 0:
            return round((obj.tokens_used_month / obj.ai_plan.monthly_token_limit) * 100, 2)
        return 0

class AIUsageLogSerializer(serializers.ModelSerializer):
    user_name = serializers.CharField(source='user.username', read_only=True)
    ai_settings_name = serializers.CharField(source='ai_settings.name', read_only=True)
    
    class Meta:
        model = AIUsageLog
        fields = '__all__'
```

---

## 🎯 프롬프트 자동 저장 시스템

### 개발 프롬프트 저장 컴포넌트
```typescript
// src/utils/promptLogger.ts
interface PromptLog {
  timestamp: string;
  user_prompt: string;
  ai_response?: string;
  context: string;
  session_id: string;
}

class PromptLogger {
  private logs: PromptLog[] = [];
  private sessionId: string;
  
  constructor() {
    this.sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    this.loadExistingLogs();
  }
  
  // 프롬프트 저장
  logPrompt(userPrompt: string, context: string = 'general', aiResponse?: string) {
    const log: PromptLog = {
      timestamp: new Date().toISOString(),
      user_prompt: userPrompt,
      ai_response: aiResponse,
      context: context,
      session_id: this.sessionId
    };
    
    this.logs.push(log);
    this.saveToLocalStorage();
    this.saveToBackend(log);
  }
  
  // 로컬 스토리지에 저장
  private saveToLocalStorage() {
    try {
      localStorage.setItem('ahp_prompt_logs', JSON.stringify(this.logs));
    } catch (error) {
      console.error('프롬프트 로컬 저장 실패:', error);
    }
  }
  
  // 백엔드에 저장
  private async saveToBackend(log: PromptLog) {
    try {
      await fetch('/api/prompt-logs/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify(log)
      });
    } catch (error) {
      console.error('프롬프트 백엔드 저장 실패:', error);
    }
  }
  
  // 기존 로그 로드
  private loadExistingLogs() {
    try {
      const saved = localStorage.getItem('ahp_prompt_logs');
      if (saved) {
        this.logs = JSON.parse(saved);
      }
    } catch (error) {
      console.error('프롬프트 로그 로드 실패:', error);
      this.logs = [];
    }
  }
  
  // 개발일지 형식으로 저장
  async saveAsDevelopmentLog() {
    const today = new Date();
    const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
    const fileName = `개발일지_${dateStr}_프롬프트_로그.md`;
    
    const content = this.generateMarkdownContent();
    
    try {
      // 백엔드 API를 통해 파일 저장
      await fetch('/api/save-development-log/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('authToken')}`
        },
        body: JSON.stringify({
          filename: fileName,
          content: content,
          folder: 'development_logs'
        })
      });
      
      console.log(`개발일지 저장 완료: ${fileName}`);
    } catch (error) {
      console.error('개발일지 저장 실패:', error);
    }
  }
  
  // 마크다운 콘텐츠 생성
  private generateMarkdownContent(): string {
    const today = new Date();
    const dateStr = today.toLocaleDateString('ko-KR');
    const timeStr = today.toLocaleTimeString('ko-KR');
    
    let content = `# 개발일지 - 프롬프트 로그
## AI 협업 세션 기록

**작성일**: ${dateStr} ${timeStr}  
**세션 ID**: ${this.sessionId}  
**총 프롬프트 수**: ${this.logs.length}개  

---

## 📝 프롬프트 상세 기록

`;

    this.logs.forEach((log, index) => {
      content += `### ${index + 1}. ${log.context} (${new Date(log.timestamp).toLocaleTimeString('ko-KR')})

**사용자 프롬프트:**
\`\`\`
${log.user_prompt}
\`\`\`

`;

      if (log.ai_response) {
        content += `**AI 응답 요약:**
\`\`\`
${log.ai_response.length > 500 ? log.ai_response.substring(0, 500) + '...' : log.ai_response}
\`\`\`

`;
      }

      content += `---

`;
    });

    content += `## 📊 세션 통계

- **총 프롬프트 수**: ${this.logs.length}개
- **평균 프롬프트 길이**: ${Math.round(this.logs.reduce((sum, log) => sum + log.user_prompt.length, 0) / this.logs.length)}자
- **주요 컨텍스트**: ${this.getMostFrequentContext()}
- **세션 시작**: ${new Date(this.logs[0]?.timestamp).toLocaleString('ko-KR')}
- **세션 종료**: ${new Date(this.logs[this.logs.length - 1]?.timestamp).toLocaleString('ko-KR')}

---

**저장 완료**: ${dateStr} ${timeStr}  
**자동 생성**: AHP 플랫폼 프롬프트 로거
`;

    return content;
  }
  
  // 가장 빈번한 컨텍스트 찾기
  private getMostFrequentContext(): string {
    const contextCounts: { [key: string]: number } = {};
    this.logs.forEach(log => {
      contextCounts[log.context] = (contextCounts[log.context] || 0) + 1;
    });
    
    return Object.keys(contextCounts).reduce((a, b) => 
      contextCounts[a] > contextCounts[b] ? a : b
    );
  }
}

// 전역 인스턴스
export const promptLogger = new PromptLogger();
```

---

## 🎯 다음 단계 구현 계획

### 1. 우선순위 개발 순서
```
🚀 Phase 1 (이번 주):
├── 데이터베이스 모델 생성 및 마이그레이션
├── Django 관리자 페이지 설정
├── 기본 API 엔드포인트 구현
└── 프롬프트 로거 기본 기능

🔧 Phase 2 (다음 주):
├── 슈퍼관리자 프론트엔드 컴포넌트
├── 사용자 AI 기능 할당 시스템
├── 사용량 모니터링 대시보드
└── 자동 프롬프트 저장 기능

⚡ Phase 3 (완성):
├── 실시간 사용량 알림
├── 자동 요금 계산
├── 고급 분석 리포트
└── 전체 시스템 통합 테스트
```

### 2. 기술적 고려사항
- **보안**: API 키 암호화 저장 및 전송
- **성능**: 사용량 로그 최적화 및 인덱싱
- **확장성**: 다양한 AI 서비스 지원 구조
- **모니터링**: 실시간 사용량 추적 시스템

이제 체계적으로 구현을 시작하겠습니다! 🚀